﻿﻿﻿<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eco-Escapade | Carte Interactive</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>%F0%9F%8C%BF</text></svg>">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="responsive.css">
</head>
<body>

    <div id="map-loader">
        <i class="fa-solid fa-bicycle bike-loader"></i>
        <div class="loading-bar-container"><div class="loading-bar" id="loadBar" style="width: 100%;"></div></div>
        <p class="loading-text" id="loader-msg">Chargement de la carte...</p>
    </div>

    <div id="tutoBox" class="tuto-box">
        <div id="tutoTitle" class="tuto-title">TUTORIEL</div>
        <div id="tutoText" class="tuto-text"></div>
        <button id="tutoBtn" class="tuto-btn" onclick="nextTutoStep()">SUIVANT ➡️</button>
        <button class="tuto-skip-btn" onclick="skipTuto()">Passer le tuto</button>
    </div>

    <div class="dashboard-header">
        <!-- ÉTAGE DESKTOP : Navigation classique (>768px) -->
        <div class="brand"><h1>Eco-Escapade</h1></div>
        <button class="burger-menu" id="burgerMenu" style="display: none;">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="index.html" id="nav-home">Accueil</a>
            <a href="carnet.html" id="nav-fav">Mes favoris</a>
            <a href="apropos.html" id="nav-apropos">À propos</a>
        </div>
        <div class="search-container" id="searchBox">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" id="search-input" list="gares-list" placeholder="Rechercher..." autocomplete="off">
            <datalist id="gares-list"></datalist>
        </div>
        <div class="actions">
            <button class="btn-discover" onclick="openDiscoverModal()"><i class="fa-solid fa-compass"></i> <span id="btn-discover-text">DÉCOUVRIR</span></button>
            <button id="btnStats" class="btn-discover" style="background: linear-gradient(135deg, #3b82f6, #2563eb); margin-right: 5px;"><i class="fa-solid fa-chart-column"></i> STATS</button>
            <button class="btn-tool" title="Me Localiser" onclick="map.locate({setView: true, maxZoom: 12})"><i class="fa-solid fa-location-arrow"></i></button>
            <button id="btnRandomGare" class="btn-tool" title="Gare Aléatoire" onclick="randomGare()"><i class="fa-solid fa-dice"></i></button>
            
            <button id="btnHeatmap" class="btn-tool" onclick="toggleHeatmap()" title="Carte de chaleur affluence" style="display:none;">
                <i class="fa-solid fa-fire"></i>
            </button>
            <button id="btnIgn" class="btn-tool" onclick="toggleIgnLayer()" title="Carte topographique IGN">
                <i class="fa-solid fa-mountain"></i>
            </button>
            <button id="btnThemes" class="btn-tool" onclick="openThemeSelector()" title="Changer le thème">
                <i class="fa-solid fa-palette"></i>
            </button>
            <button id="btnEcoInfo" class="btn-tool" onclick="toggleEcoPanel()" title="Infos écologiques avancées">
                <i class="fa-solid fa-leaf"></i>
            </button>

            <button class="lang-switch" onclick="switchLangMap()">FR / EN</button>
        </div>
    </div>

    <!-- HEADER MOBILE : 2 ÉTAGES (visible uniquement <768px) -->
    <div class="mobile-header" id="mobileHeader">
        <!-- ÉTAGE 1 : Logo + Recherche -->
        <div class="mobile-header-top">
            <div class="mobile-logo">
                <h1>Eco-Escapade</h1>
            </div>
            <div class="mobile-search">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" id="mobile-search-input" list="mobile-gares-list" placeholder="Rechercher..." autocomplete="off">
                <datalist id="mobile-gares-list"></datalist>
            </div>
        </div>
        
        <!-- ÉTAGE 2 : Barre d'outils avec scroll horizontal -->
        <div class="mobile-header-bottom">
            <button class="mobile-tool-btn" onclick="openDiscoverModal()" title="Découvrir">
                <i class="fa-solid fa-compass"></i>
                <span>Découvrir</span>
            </button>
            <button class="mobile-tool-btn" onclick="document.getElementById('btnStats').click()" title="Stats">
                <i class="fa-solid fa-chart-column"></i>
                <span>Stats</span>
            </button>
            <button class="mobile-tool-btn" onclick="map.locate({setView: true, maxZoom: 12})" title="Ma position">
                <i class="fa-solid fa-location-arrow"></i>
                <span>Position</span>
            </button>
            <button class="mobile-tool-btn" onclick="randomGare()" title="Aléatoire">
                <i class="fa-solid fa-dice"></i>
                <span>Random</span>
            </button>
            <button class="mobile-tool-btn" onclick="toggleIgnLayer()" title="Carte IGN">
                <i class="fa-solid fa-mountain"></i>
                <span>IGN</span>
            </button>
            <button class="mobile-tool-btn" onclick="openThemeSelector()" title="Thème">
                <i class="fa-solid fa-palette"></i>
                <span>Thème</span>
            </button>
            <button class="mobile-tool-btn" onclick="switchLangMap()" title="Langue">
                <i class="fa-solid fa-language"></i>
                <span id="mobile-lang-text">FR</span>
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div id="discoverModal" class="discover-modal">
        <div class="discover-content">
            <button onclick="closeDiscover()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:2rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            <h2 id="discoverTitle" style="color:white; font-size:2.5rem; margin-bottom:10px;">Envie de partir quelque part ?</h2>
            <p id="discoverSubtitle" style="color:#94a3b8;">Choisissez un environnement, le site trouve pour vous les gares les plus écologiques.</p>
            <button id="btnBackCat" onclick="resetDiscover()" style="display:none; background:transparent; color:var(--primary); border:1px solid var(--primary); padding:8px 15px; border-radius:20px; cursor:pointer; margin-bottom:20px;">← Choisir un autre environnement</button>
            
            <div id="catGrid" class="cat-grid">
                <div class="cat-card" onclick="showCategory('mer', 'Mer & Plages')"><h3 id="cat-mer">Mer Méditerranée</h3></div>
                <div class="cat-card" onclick="showCategory('ocean', 'Océan & Vagues')"><h3 id="cat-ocean">Océan Atlantique</h3></div>
                <div class="cat-card" onclick="showCategory('montagne', 'Montagne & Neige')"><h3 id="cat-montagne">Montagne</h3></div>
                <div class="cat-card" onclick="showCategory('ville', 'Grandes Métropoles')"><h3 id="cat-ville">Grandes Villes</h3></div>
                <div class="cat-card" onclick="showCategory('paris', 'Capitale')"><h3 id="cat-paris">Paris</h3></div>
                <div class="cat-card" onclick="showCategory('sud', 'Le Sud')"><h3 id="cat-sud">Le Sud</h3></div>
                <div class="cat-card" onclick="showCategory('nord', 'Le Nord')"><h3 id="cat-nord">Le Nord</h3></div>
            </div>

            <div id="resultsContainer" class="results-container"></div>
        </div>
    </div>

    <div id="statsPanel" class="stats-panel stats-panel-enhanced">
        <div class="stats-header">
           <h2 id="stats-title">📊 Tableau de bord national</h2>
           <button id="closeStats" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <!-- ANCIENNES STATS (conservées) -->
        <div class="stats-section">
            <div class="stats-section-title" id="section-analysis">🔍 Analyse des gares</div>
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-label" id="lbl-gares">Gares analysées</span><span class="stat-value" id="stat-gares">-</span></div>
                <div class="stat-card"><span class="stat-label" id="lbl-score">Score moyen écolo</span><span class="stat-value" id="stat-score">-</span></div>
                <div class="stat-card"><span class="stat-label" id="lbl-tgv">Part TGV</span><span class="stat-value" id="stat-tgv">-</span></div>
                <div class="stat-card"><span class="stat-label" id="lbl-velos">Moy. parkings vélos</span><span class="stat-value" id="stat-velos">-</span></div>
                <div class="stat-card"><span class="stat-label" id="lbl-bornes">Moy. bornes IRVE</span><span class="stat-value" id="stat-bornes">-</span></div>
                <div class="stat-card"><span class="stat-label" id="lbl-covoit">Moy. aires covoit</span><span class="stat-value" id="stat-covoit">-</span></div>
            </div>
        </div>
        
        <!-- NOUVELLES STATS (8 nouvelles) -->
        <div class="stats-section">
            <div class="stats-section-title" id="section-totals">📈 Totaux nationaux</div>
            <div class="stats-grid">
                <div class="stat-card stat-highlight"><span class="stat-emoji">🚲</span><span class="stat-label" id="lbl-total-velos">Parkings vélo</span><span class="stat-value stat-blue" id="stat-total-velos">-</span></div>
                <div class="stat-card stat-highlight"><span class="stat-emoji">🚗</span><span class="stat-label" id="lbl-total-covoit">Points covoiturage</span><span class="stat-value stat-purple" id="stat-total-covoit">-</span></div>
                <div class="stat-card stat-highlight"><span class="stat-emoji">🔌</span><span class="stat-label" id="lbl-total-irve">Bornes IRVE</span><span class="stat-value stat-orange" id="stat-total-irve">-</span></div>
                <div class="stat-card stat-highlight"><span class="stat-emoji">🚂</span><span class="stat-label" id="lbl-gares-velo">Gares avec vélo (10min)</span><span class="stat-value stat-green" id="stat-gares-velo">-</span></div>
            </div>
        </div>
        
        <div class="stats-section">
            <div class="stats-section-title" id="section-weather">🌡️ Météo en direct</div>
            <div class="stats-grid stats-grid-weather">
                <div class="stat-card stat-weather stat-hot"><span class="stat-emoji">☀️</span><span class="stat-label" id="lbl-hottest">Plus chaud</span><span class="stat-value" id="stat-hottest">-</span></div>
                <div class="stat-card stat-weather stat-cold"><span class="stat-emoji">❄️</span><span class="stat-label" id="lbl-coldest">Plus froid</span><span class="stat-value" id="stat-coldest">-</span></div>
            </div>
        </div>
        
        <div class="stats-section">
            <div class="stats-section-title" id="section-ranking">🏆 Classement vélos</div>
            <div class="stats-grid">
                <div class="stat-card stat-champion"><span class="stat-emoji">🥇</span><span class="stat-label" id="lbl-top-velo">Gare top vélo (10min)</span><span class="stat-value stat-gold" id="stat-top-velo">-</span></div>
                <div class="stat-card stat-alert"><span class="stat-emoji">⚠️</span><span class="stat-label" id="lbl-no-velo">Gares sans vélo (10min)</span><span class="stat-value stat-red" id="stat-no-velo">-</span></div>
            </div>
        </div>
        
        <div class="stats-footer">
            <span id="stats-refresh-text">🔄 Actualisation auto: 30s</span>
            <button id="btnRefreshStats" class="btn-refresh-stats" onclick="forceRefreshStats()">
                <i class="fa-solid fa-sync"></i>
            </button>
        </div>
    </div>

    <div id="themeSelectorPanel">
        <div class="theme-option theme-default" onclick="applyTheme('default')">Eco-Vert</div>
        <div class="theme-option theme-ocean" onclick="applyTheme('ocean')">Océan</div>
    </div>

    <div id="ecoPanelModal">
        <div class="eco-panel-content">
            <button onclick="toggleEcoPanel()" style="float:right; background:transparent; border:none; color:white; font-size:1.5rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="color:var(--primary); margin-top:0;">
                <i class="fa-solid fa-leaf"></i> Informations écologiques avancées
            </h2>
            <div id="ecoDataContainer">
                <p style="color:#94a3b8;">Sélectionnez une gare sur la carte pour voir ses données écologiques détaillées (qualité de l'air, biodiversité, arbres urbains).</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-easyprint/2.1.9/bundle.js"></script>
    <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings-Leaflet.js"></script>
    <script type="module">
        import { NAV_TEXTS } from './js/textes.js';
        import './app.js';
        
        let isFrMap = true;
        
        function switchLangMap() {
            isFrMap = !isFrMap;
            console.log('🔄 switchLangMap() appelé - isFrMap maintenant:', isFrMap);
            const t = NAV_TEXTS;
            document.getElementById('nav-home').innerText = isFrMap ? t.navHome.fr : t.navHome.en;
            document.getElementById('nav-fav').innerText = isFrMap ? t.navFav.fr : t.navFav.en;
            document.getElementById('nav-apropos').innerText = isFrMap ? t.navApropos.fr : t.navApropos.en;
            document.getElementById('search-input').placeholder = isFrMap ? t.search.fr : t.search.en;
            document.getElementById('btn-discover-text').innerText = isFrMap ? t.btnDiscover.fr : t.btnDiscover.en;
            document.getElementById('discoverTitle').innerText = isFrMap ? t.discTitle.fr : t.discTitle.en;
            document.getElementById('discoverSubtitle').innerText = isFrMap ? t.discSub.fr : t.discSub.en;
            document.getElementById('btnBackCat').innerText = isFrMap ? t.btnBack.fr : t.btnBack.en;
            document.getElementById('cat-mer').innerText = isFrMap ? t.catMer.fr : t.catMer.en;
            document.getElementById('cat-ocean').innerText = isFrMap ? t.catOcean.fr : t.catOcean.en;
            document.getElementById('cat-montagne').innerText = isFrMap ? t.catMontagne.fr : t.catMontagne.en;
            document.getElementById('cat-ville').innerText = isFrMap ? t.catVille.fr : t.catVille.en;
            document.getElementById('cat-paris').innerText = isFrMap ? t.catParis.fr : t.catParis.en;
            document.getElementById('cat-sud').innerText = isFrMap ? t.catSud.fr : t.catSud.en;
            document.getElementById('cat-nord').innerText = isFrMap ? t.catNord.fr : t.catNord.en;
            
            // Note: Les boutons du tutoriel et le contenu sont mis à jour par updateAppLanguage() dans app.js
            // pour gérer correctement l'étape courante du tutoriel
            
            // --- UPDATING STATS & LOADER (avec vérification null) ---
            const loaderMsg = document.getElementById('loader-msg');
            const statsTitle = document.getElementById('stats-title');
            const lblGares = document.getElementById('lbl-gares');
            const lblScore = document.getElementById('lbl-score');
            const lblTgv = document.getElementById('lbl-tgv');
            const lblVelos = document.getElementById('lbl-velos');
            const lblBornes = document.getElementById('lbl-bornes');
            const lblCovoit = document.getElementById('lbl-covoit');
            
            if (loaderMsg) loaderMsg.innerText = isFrMap ? t.loader.fr : t.loader.en;
            if (statsTitle) statsTitle.innerText = isFrMap ? t.statsTitle.fr : t.statsTitle.en;
            if (lblGares) lblGares.innerText = isFrMap ? t.lblGares.fr : t.lblGares.en;
            if (lblScore) lblScore.innerText = isFrMap ? t.lblScore.fr : t.lblScore.en;
            if (lblTgv) lblTgv.innerText = isFrMap ? t.lblTgv.fr : t.lblTgv.en;
            if (lblVelos) lblVelos.innerText = isFrMap ? t.lblVelos.fr : t.lblVelos.en;
            if (lblBornes) lblBornes.innerText = isFrMap ? t.lblBornes.fr : t.lblBornes.en;
            if (lblCovoit) lblCovoit.innerText = isFrMap ? t.lblCovoit.fr : t.lblCovoit.en;
            
            // --- NOUVELLES STATS (8 nouvelles traductions) ---
            const sectionAnalysis = document.getElementById('section-analysis');
            const sectionTotals = document.getElementById('section-totals');
            const sectionWeather = document.getElementById('section-weather');
            const sectionRanking = document.getElementById('section-ranking');
            const lblTotalVelos = document.getElementById('lbl-total-velos');
            const lblTotalCovoit = document.getElementById('lbl-total-covoit');
            const lblTotalIrve = document.getElementById('lbl-total-irve');
            const lblGaresVelo = document.getElementById('lbl-gares-velo');
            const lblHottest = document.getElementById('lbl-hottest');
            const lblColdest = document.getElementById('lbl-coldest');
            const lblTopVelo = document.getElementById('lbl-top-velo');
            const lblNoVelo = document.getElementById('lbl-no-velo');
            const statsRefresh = document.getElementById('stats-refresh-text');
            
            if (sectionAnalysis) sectionAnalysis.innerText = isFrMap ? t.sectionAnalysis.fr : t.sectionAnalysis.en;
            if (sectionTotals) sectionTotals.innerText = isFrMap ? t.sectionTotals.fr : t.sectionTotals.en;
            if (sectionWeather) sectionWeather.innerText = isFrMap ? t.sectionWeather.fr : t.sectionWeather.en;
            if (sectionRanking) sectionRanking.innerText = isFrMap ? t.sectionRanking.fr : t.sectionRanking.en;
            if (lblTotalVelos) lblTotalVelos.innerText = isFrMap ? t.lblTotalVelos.fr : t.lblTotalVelos.en;
            if (lblTotalCovoit) lblTotalCovoit.innerText = isFrMap ? t.lblTotalCovoit.fr : t.lblTotalCovoit.en;
            if (lblTotalIrve) lblTotalIrve.innerText = isFrMap ? t.lblTotalIrve.fr : t.lblTotalIrve.en;
            if (lblGaresVelo) lblGaresVelo.innerText = isFrMap ? t.lblGaresVelo.fr : t.lblGaresVelo.en;
            if (lblHottest) lblHottest.innerText = isFrMap ? t.lblHottest.fr : t.lblHottest.en;
            if (lblColdest) lblColdest.innerText = isFrMap ? t.lblColdest.fr : t.lblColdest.en;
            if (lblTopVelo) lblTopVelo.innerText = isFrMap ? t.lblTopVelo.fr : t.lblTopVelo.en;
            if (lblNoVelo) lblNoVelo.innerText = isFrMap ? t.lblNoVelo.fr : t.lblNoVelo.en;
            if (statsRefresh) statsRefresh.innerText = isFrMap ? t.statsRefresh.fr : t.statsRefresh.en;

            if (window.updateAppLanguage) window.updateAppLanguage(isFrMap);
        }
        
        window.switchLangMap = switchLangMap;
    </script>
    
    <!-- Script Mobile Adaptive UI -->
    <script src="mobile-logic.js"></script>
</body>
</html>
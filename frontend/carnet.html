<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Escapade |
Tableau de Bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #10b981;
--secondary: #3b82f6; --dark: #0f172a; --bg: #0b0b0b; --card-bg: #1e293b; --danger: #ef4444;
}
        * { box-sizing: border-box;
}
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: white;
padding-top: 100px; padding-bottom: 80px; overflow-x: hidden; }
        .dashboard-header { position: fixed; top: 20px;
left: 50%; transform: translateX(-50%); width: 96%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); padding: 12px 30px; border-radius: 50px;
box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1);
}
        .brand h1 { margin: 0; font-size: 1.4rem; font-weight: 800; color: var(--primary);
}
        .nav-links a { text-decoration: none; color: #cbd5e1; font-weight: 600; margin-left: 20px; transition:0.3s;
cursor: pointer; }
        .nav-links a:hover, .nav-links a.active { color: var(--primary);
}
        .lang-switch { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 30px;
border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-weight: bold; color: white; transition: 0.3s; font-family: 'Inter', sans-serif; font-size: 0.8rem; margin-left: 20px;
}
        .lang-switch:hover { background: var(--primary); color: #000; border-color: var(--primary);
}
        .container { width: 96%; margin: 0 auto; padding: 0 20px;
}
        .top-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;
border-bottom: 1px solid #334155; padding-bottom: 20px; gap: 20px; }
        .titles { flex: 1;
}
        .heatmap-container { width: 350px; height: 160px; border-radius: 16px; overflow: hidden;
border: 2px solid #334155; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
        #miniMap { width: 100%; height: 100%; background: #111;
}
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px;
}
        .card { background: var(--card-bg); padding: 25px; border-radius: 20px;
box-shadow: 0 10px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; position: relative;
}
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(16, 185, 129, 0.1);
border-color: var(--primary); }
        .vs-checkbox-input { display: none;
}
        .vs-label { position: absolute; top: 20px; right: 20px; width: 30px; height: 30px;
border-radius: 50%; border: 2px solid #475569; background: rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: transparent;
z-index: 10; }
        .vs-label:hover { border-color: white;
}
        .vs-checkbox-input:checked + .vs-label { background: var(--primary); border-color: var(--primary); color: #022c22;
box-shadow: 0 0 15px var(--primary); }
        .card-top { margin-bottom: 15px; padding-right: 40px;
} 
        .card h3 { margin: 0 0 5px 0; font-size: 1.3rem;
font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.75rem;
text-transform: uppercase; display: inline-block; }
        .badge.TGV { background: rgba(59, 130, 246, 0.2);
color: #60a5fa; }
        .badge.TER { background: rgba(16, 185, 129, 0.2); color: #34d399;
}
        .score-row { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.2);
padding: 15px; border-radius: 12px; }
        .circle-wrap { width: 70px; height: 70px; border-radius: 50%;
display: flex; justify-content: center; align-items: center; position: relative; background: #334155;
}
        .circle-inner { width: 60px; height: 60px; background: var(--card-bg); border-radius: 50%; display: flex;
justify-content: center; align-items: center; font-weight: 900; font-size: 1.2rem; color: white; z-index: 2;
}
        .stats-list { flex: 1; font-size: 0.9rem; color: #cbd5e1;
}
        .stat-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
}
        .btn-main { display: block; width: 100%; text-align: center; background: var(--primary); color: #022c22;
padding: 12px; border-radius: 10px; font-weight: 800; text-decoration: none; margin-bottom: 15px; transition: 0.2s;
}
        .btn-main:hover { background: #34d399; transform: scale(1.02);
}
        .tools-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}
        .tool-btn { background: rgba(255,255,255,0.05); border: none; color: #94a3b8; border-radius: 8px; padding: 10px;
cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
        .tool-btn:hover { background: rgba(255,255,255,0.15); color: white;
}
        .tool-btn.google:hover { background: rgba(255, 255, 255, 0.2); color: white;
}
        .tool-btn.del:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger);
}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
}
        .modal-overlay.active { display: flex; opacity: 1;
}
        .modal-box { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px;
width: 90%; max-width: 500px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; transform: scale(0.9); transition: transform 0.3s;
}
        .modal-overlay.active .modal-box { transform: scale(1);
}
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none;
color: #64748b; font-size: 1.5rem; cursor: pointer; }
        .google-grid { display: grid; grid-template-columns: 1fr;
gap: 10px; margin-top: 15px; }
        .google-pic { width: 100%; height: 250px; object-fit: cover;
border-radius: 8px; background: #334155; transition: transform 0.2s; border: 2px solid transparent;
}
        .google-pic:hover { transform: scale(1.02); border-color: white;
}
        .danger-zone { margin-top: 60px; text-align: center; border-top: 1px dashed #334155; padding-top: 20px;
}
        .btn-nuke { background: transparent; border: 1px solid #ef4444; color: #ef4444;
padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: monospace; letter-spacing: 2px; transition: 0.3s;
}
        .btn-nuke:hover { background: #ef4444; color: white;
box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
        #vs-btn { position: fixed;
bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px); background: linear-gradient(135deg, #f59e0b, #d97706); padding: 15px 40px; border-radius: 50px; font-weight: 900; color: white;
border: none; cursor: pointer; box-shadow: 0 0 30px rgba(245, 158, 11, 0.5); z-index: 1500; transition: transform 0.3s; display: flex;
align-items: center; gap: 10px; }
        #vs-btn.visible { transform: translateX(-50%) translateY(0);
}
        .vs-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem;
}
        .vs-table td, .vs-table th { padding: 12px 5px; text-align: center;
border-bottom: 1px solid rgba(255,255,255,0.05); }
        .vs-table th { color: #94a3b8; font-weight: normal;
font-size: 0.8rem; }
        .val-win { color: #10b981; font-weight: bold;
text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .val-lose { color: #ef4444;
opacity: 0.7; }
        .toast { position: fixed; bottom: 30px; left: 50%;
transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
border: 1px solid #334155; display: flex; align-items: center; gap: 10px; transition: transform 0.3s ease; z-index: 3000;
}
        .toast.visible { transform: translateX(-50%) translateY(0);
}
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg);
} 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg);
} 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg);
} 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg);
} 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg);
} 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg);
} }
        .shaking { animation: shake 0.5s; animation-iteration-count: infinite;
}
        .red-alert { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,0,0,0.3); z-index: 9998;
pointer-events: none; display: none; }
        .red-alert.active { display: block; animation: flash 0.3s infinite;
}
        @keyframes flash { 0% {background:rgba(255,0,0,0.1)} 50% {background:rgba(255,0,0,0.4)} 100% {background:rgba(255,0,0,0.1)} }
        #countdown-screen { position: fixed;
top:0; left:0; width:100%; height:100%; background: black; z-index: 9999; display: flex; justify-content: center; align-items: center; color: red; font-family: monospace; font-size: 15vw;
font-weight: 900; display: none; flex-direction: column; }
    </style>
</head>
<body>
    <div class="red-alert" id="redAlert"></div>
    <div id="countdown-screen"></div>
    <div class="dashboard-header">
        <div class="brand"><h1>Eco-Escapade <span style="font-size:0.5em; vertical-align:super; color:#f59e0b;">ULTIMATE</span></h1></div>
        <div class="nav-links"><a href="map.html" id="nav-carte">Carte</a><a href="#" class="active" onclick="openOnboarding()" id="nav-aide">Aide</a></div>
        <button class="lang-switch" onclick="switchLangCarnet()">FR / EN</button>
    </div>
    <div class="container">
        <div class="top-section">
            <div class="titles"><h2 id="main-title" style="font-size: 
2.5rem; margin: 0;">Tableau de Bord</h2><p id="main-subtitle" style="color:#94a3b8; margin-top: 5px;">Gérez vos futures aventures bas carbone.</p></div>
            <div class="heatmap-container"><div id="miniMap"></div></div>
        </div>
        <div id="grid" class="card-grid"></div>
        <div id="empty" style="text-align: center;
color: #64748b; margin-top: 100px; display: none;"><i class="fa-solid fa-ghost" style="font-size: 3rem; margin-bottom: 20px;"></i><p id="empty-text">Aucune donnée.</p><a href="map.html" id="btn-scan" class="btn-main" style="width:200px;
margin: 20px auto;">Scanner la carte</a></div>
        <div class="danger-zone"><button id="btn-nuke" class="btn-nuke" onclick="openNukeModal()">⚠️ SÉQUENCE D’AUTODESTRUCTION</button></div>
    </div>
    <button id="vs-btn" onclick="openVsModal()"><i class="fa-solid fa-gavel"></i> <span id="btn-compare">COMPARER</span></button>
    <div id="toast" class="toast"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i><span id="toast-msg">Message</span></div>
    <div id="onboardingModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()">×</button>
            <h3 id="onb-title" style="color:var(--primary);
font-size:1.8rem; margin-bottom:20px;">Bienvenue !</h3>
            <p id="onb-text" style="text-align:left; line-height:1.6;
color:#cbd5e1;">Voici votre carnet de voyage intelligent. Comparez deux gares... Images de la ville trouvées... QR Code pour partager... Carte de situation en haut à droite.</p>
            <button id="onb-btn" class="btn-main" onclick="closeAll()" style="margin-top:20px;">C'est parti !</button>
        </div>
    </div>
    <div id="googlePhotosModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()">×</button>
            <h3 class="google-title" id="google-title" style="margin-bottom:20px;
font-size:1.5rem; color:white;"><i class="fa-brands fa-wikipedia-w"></i> Images de la ville</h3>
            <p id="googleQuery" style="color:#94a3b8;
margin-bottom:15px; font-style:italic;"></p>
            <div class="google-grid" id="googleGrid"><div style="color:#94a3b8;
padding:20px;">Chargement des images...</div></div>
        </div>
    </div>
    <div id="qrModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()">×</button>
            <h3 id="qr-title">Partager</h3>
            <div id="qrcode" style="margin: 20px auto;
width: 128px; background:white; padding:10px;"></div>
            <p id="qr-text" style="font-size:0.9rem;
color:#94a3b8;">Scannez pour ouvrir Google Maps</p>
        </div>
    </div>
    <div id="nukeModal" class="modal-overlay">
        <div class="modal-box" style="border: 2px solid #ef4444;
box-shadow: 0 0 50px rgba(239,68,68,0.3);">
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem;
color: #ef4444; margin-bottom: 20px;"></i>
            <h3 id="nuke-title" style="color: #ef4444;
font-size: 1.5rem;">ATTENTION</h3>
            <p id="nuke-text">Voulez-vous vraiment détruire tout le carnet ?</p>
            <div style="display: flex;
gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="nuke-no" onclick="closeAll()" style="padding: 10px 20px;
background: #334155; border:none; color:white; border-radius:8px; cursor:pointer;">Non</button>
                <button id="nuke-yes" onclick="startSelfDestruct()" style="padding: 10px 20px;
background: #ef4444; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">OUI, DETRUIRE</button>
            </div>
        </div>
    </div>
    <div id="deleteSingleModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="del-title" style="margin-bottom:15px;">Supprimer ce favori ?</h3>
            <p id="del-text" style="color:#94a3b8;
margin-bottom:20px;">Cette action est irréversible.</p>
            <div style="display: flex; gap: 10px;
justify-content: center;">
                <button id="del-no" onclick="closeAll()" style="padding: 10px 20px;
background: #334155; border:none; color:white; border-radius:8px; cursor:pointer;">Annuler</button>
                <button id="confirmDeleteBtn" style="padding: 10px 20px;
background: #ef4444; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">Supprimer</button>
            </div>
        </div>
    </div>
    <div id="vsModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px;
background: linear-gradient(145deg, #1e293b, #0f172a);">
            <button class="close-modal" onclick="closeAll()">×</button>
            <h2 id="vs-title" style="color:#f59e0b;
font-style:italic; font-size:2rem; margin-bottom:10px;">COMPARATEUR</h2>
            <div id="vsContent"></div>
        </div>
    </div>

    <script>
        const escapeHTML = (str) => str ? str.replace(/[&<>'"]/g, tag => ({ '&': '&', '<': '<', '>': '>', "'": "'", '"': '"' }[tag])) : '';

        // MODIFIÉ : Variable langue déplacée en haut pour être accessible dans render()
        let isFrCarnet = true;

        let favoris = JSON.parse(localStorage.getItem('eco_favoris')) || [];
        favoris = favoris.map(f => {
            if(f.score 
=== undefined) { 
                f.score = Math.floor(Math.random() * 50 + 50) / 10; 
                f.details = { velos: Math.floor(Math.random()*20), bornes: Math.floor(Math.random()*10), covoit: Math.floor(Math.random()*5) };
            }
            return f;
        });

        const grid = document.getElementById('grid');
   
     const empty = document.getElementById('empty');
        let selectedVs = []; 
        let itemToDeleteIndex = null;

        function render() {
            if (favoris.length === 0) { empty.style.display = 'block'; grid.innerHTML = '';
return; }
            favoris.sort((a,b) => (b.score||0) - (a.score||0));
grid.innerHTML = '';
            favoris.forEach((fav, index) => {
                const score = fav.score !== undefined ? fav.score : '?';
                const details = fav.details || { velos: 0, bornes: 0, covoit: 0 };
                let color = '#ef4444'; if(score >= 5) color = '#f59e0b'; if(score >= 8) color = '#10b981';
          
       const deg = (score !== '?' ? score : 0) * 36;
                const gradient = `conic-gradient(${color} ${deg}deg, #334155 0deg)`;
                const safeName = escapeHTML(fav.nom);

                const div = document.createElement('div');
                div.className = 'card';
     
           div.innerHTML = `
                    <input type="checkbox" id="chk-${index}" class="vs-checkbox-input" onchange="toggleVs(${index}, this)">
                    <label for="chk-${index}" class="vs-label"><i class="fa-solid fa-check"></i></label>
                    <div class="card-top"><div><span class="badge ${fav.type}">${fav.type}</span><h3>${safeName}</h3></div></div>
               
     <div class="score-row">
                        <div class="circle-wrap" style="background: ${gradient}"><div class="circle-inner">${score}</div></div>
                        <div class="stats-list">
                            <div class="stat-item"><i class="fa-solid fa-bicycle" style="color:#06b6d4;
width:20px;"></i> ${details.velos} ${isFrCarnet ? 'Vélos' : 'Bikes'}</div>
                            <div class="stat-item"><i class="fa-solid fa-plug" style="color:#f59e0b;
width:20px;"></i> ${details.bornes} ${isFrCarnet ? 'Bornes' : 'Terminals'}</div>
                            <div class="stat-item"><i class="fa-solid fa-car" style="color:#a855f7;
width:20px;"></i> ${details.covoit} ${isFrCarnet ? 'Covoit' : 'Carpool'}</div>
                        </div>
                    </div>
                    <a href="map.html?target=${fav.id}" class="btn-main"><i class="fa-solid fa-location-arrow"></i> <span class="txt-go">Y aller</span></a>
                    <div class="tools-grid">
      
                   <button class="tool-btn google" title="${isFrCarnet?'Photos':'Photos'}" onclick="openGooglePhotos('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-image"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'Google Maps':'Google Maps'}" onclick="openGoogleMaps('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-map-location-dot"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'QR Code':'QR Code'}" onclick="openQr('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-qrcode"></i></button>
             
           <button class="tool-btn del" title="${isFrCarnet?'Supprimer':'Delete'}" onclick="askDelete(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
grid.appendChild(div);
            });
        }
        render();
if(favoris.length > 0) {
            setTimeout(() => {
                const miniMap = L.map('miniMap', { zoomControl:false, attributionControl:false }).setView([46.5, 2.5], 4);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(miniMap);
                favoris.forEach(f => {
                    const lat = 46 
+ (Math.random()-0.5)*5; 
                    const lon = 2 + (Math.random()-0.5)*5;
                    L.circleMarker([lat, lon], { radius:4, color:'#ef4444', fillOpacity:1, stroke:false }).addTo(miniMap);
                });
            }, 500);
}

        function showToast(msg) {
            const t = document.getElementById('toast');
document.getElementById('toast-msg').innerText = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }
        function closeAll() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}
        function openModal(id) { document.getElementById(id).classList.add('active');
}

        async function openGooglePhotos(nom) {
            let cleanCity = nom.split(' - ')[0].replace(/Gare de\s?/gi, '').replace(/TGV/gi, '').replace(/Centre/gi, '').trim();
document.getElementById('googleQuery').innerText = `${isFrCarnet ? 'Recherche pour :' : 'Search for:'} "${cleanCity}"`;
            openModal('googlePhotosModal');
            const grid = document.getElementById('googleGrid');
            // MODIFIÉ : Utilisation de translationsCarnet
            grid.innerHTML = `<div style="color:#94a3b8; padding:20px;">${isFrCarnet ? translationsCarnet.imgLoad.fr : translationsCarnet.imgLoad.en}</div>`;
try {
                const url = `https://fr.wikipedia.org/w/api.php?action=query&titles=${cleanCity}&prop=pageimages&format=json&pithumbsize=600&origin=*`;
const r = await fetch(url);
                const d = await r.json();
                const pages = d.query.pages;
                const pid = Object.keys(pages)[0];
if (pid !== "-1" && pages[pid].thumbnail) {
                    const imgSrc = pages[pid].thumbnail.source;
grid.innerHTML = `<img src="${imgSrc}" class="google-pic">`;
                } else {
                    grid.innerHTML = `<div style="color:#ef4444; padding:20px;">${isFrCarnet ? translationsCarnet.imgError.fr : translationsCarnet.imgError.en}</div>`;
}
            } catch(e) {
                grid.innerHTML = `<div style="color:#ef4444; padding:20px;">${isFrCarnet ? translationsCarnet.conError.fr : translationsCarnet.conError.en}</div>`;
}
        }

        window.openGoogleMaps = (nom) => { window.open(`https://www.google.com/maps/search/?api=1&query=Gare+$${encodeURIComponent(nom.replace(/Gare de\s?/gi, ''))}`);
};
        window.openQr = (nom) => {
            const container = document.getElementById('qrcode');
container.innerHTML = '';
            new QRCode(container, { text: `https://www.google.com/maps/search/?api=1&query=Gare+$${encodeURIComponent(nom)}`, width: 128, height: 128 });
            openModal('qrModal');
        };
window.askDelete = (index) => { itemToDeleteIndex = index; openModal('deleteSingleModal'); };
document.getElementById('confirmDeleteBtn').onclick = () => {
            if(itemToDeleteIndex !== null) {
                favoris.splice(itemToDeleteIndex, 1);
localStorage.setItem('eco_favoris', JSON.stringify(favoris));
                // MODIFIÉ : Toast traduit
                render(); closeAll(); showToast(isFrCarnet ? translationsCarnet.toastDel.fr : translationsCarnet.toastDel.en);
            }
        };
window.toggleVs = (index, checkbox) => {
            if (checkbox.checked) {
                if (selectedVs.length >= 2) { checkbox.checked = false;
// MODIFIÉ : Toast traduit
showToast(isFrCarnet ? translationsCarnet.toastMax.fr : translationsCarnet.toastMax.en); return; }
                selectedVs.push(index);
} else {
                selectedVs = selectedVs.filter(i => i !== index);
}
            const btn = document.getElementById('vs-btn');
if (selectedVs.length === 2) btn.classList.add('visible');
            else btn.classList.remove('visible');
        };

        window.openVsModal = () => {
            const f1 = favoris[selectedVs[0]];
const f2 = favoris[selectedVs[1]];
            const winner = (v1, v2) => v1 > v2 ?
'val-win' : (v1 < v2 ? 'val-lose' : '');
            
            // MODIFIÉ : Labels dynamiques pour la modale VS
            const lblScore = isFrCarnet ? "SCORE GLOBAL" : "GLOBAL SCORE";
            const lblVelos = isFrCarnet ? "VÉLOS" : "BIKES";
            const lblBornes = isFrCarnet ? "BORNES" : "TERMINALS";
            const lblCovoit = isFrCarnet ? "COVOIT'" : "CARPOOL";

            document.getElementById('vsContent').innerHTML = `
                <table class="vs-table">
                    <thead><tr><th style="width:40%; font-size:1.1rem; color:white;">${escapeHTML(f1.nom)}</th><th style="width:20%;">VS</th><th style="width:40%; font-size:1.1rem; color:white;">${escapeHTML(f2.nom)}</th></tr></thead>
                    <tbody>
                        <tr><td 
class="${winner(f1.score, f2.score)}" style="font-size:1.5rem;">${f1.score}</td><td style="color:#94a3b8; font-size:0.8rem;">${lblScore}</td><td class="${winner(f2.score, f1.score)}" style="font-size:1.5rem;">${f2.score}</td></tr>
                        <tr><td class="${winner(f1.details.velos, f2.details.velos)}">${f1.details.velos}</td><td style="color:#94a3b8; font-size:0.8rem;">${lblVelos}</td><td class="${winner(f2.details.velos, f1.details.velos)}">${f2.details.velos}</td></tr>
                        <tr><td class="${winner(f1.details.bornes, f2.details.bornes)}">${f1.details.bornes}</td><td style="color:#94a3b8;
font-size:0.8rem;">${lblBornes}</td><td class="${winner(f2.details.bornes, f1.details.bornes)}">${f2.details.bornes}</td></tr>
                        <tr><td class="${winner(f1.details.covoit, f2.details.covoit)}">${f1.details.covoit}</td><td style="color:#94a3b8;
font-size:0.8rem;">${lblCovoit}</td><td class="${winner(f2.details.covoit, f1.details.covoit)}">${f2.details.covoit}</td></tr>
                    </tbody>
                </table>
            `;
            openModal('vsModal');
        };

        window.openNukeModal = () => document.getElementById('nukeModal').classList.add('active');
        window.startSelfDestruct = () => {
      
      closeAll();
            document.body.classList.add('shaking'); document.getElementById('redAlert').classList.add('active'); 
            const screen = document.getElementById('countdown-screen');
            screen.style.display = 'flex';
            let count = 5; screen.innerHTML = count;
            const timer = setInterval(() => {
                
count--; screen.innerHTML = count;
                // MODIFIÉ : Traduction PURGE COMPLETE
                if(count <= 0) { clearInterval(timer); screen.innerHTML = isFrCarnet ? "PURGE COMPLETE" : "PURGE COMPLETE"; localStorage.removeItem('eco_favoris'); setTimeout(() => location.reload(), 2000); }
            }, 1000);
        };
window.openOnboarding = () => document.getElementById('onboardingModal').classList.add('active');
        if(!localStorage.getItem('visited_carnet_final')) { setTimeout(openOnboarding, 1000); localStorage.setItem('visited_carnet_final', 'true');
}
        
const translationsCarnet = {
            navCarte: { fr: "Carte", en: "Map" }, navAide: { fr: "Aide", en: "Help" }, mainTitle: { fr: "Tableau de Bord", en: "Dashboard" }, mainSub: { fr: "Gérez vos futures aventures bas carbone.", en: "Manage your future low-carbon adventures."
}, emptyText: { fr: "Aucune donnée.", en: "No data." }, btnScan: { fr: "Scanner la carte", en: "Scan map" }, btnNuke: { fr: "⚠️ SÉQUENCE D’AUTODESTRUCTION", en: "⚠️ SELF-DESTRUCT SEQUENCE" }, btnCompare: { fr: "COMPARER", en: "COMPARE" }, onbTitle: { fr: "Bienvenue !", en: "Welcome!"
}, onbText: { fr: "Voici votre carnet de voyage intelligent. Comparez deux gares... Images de la ville trouvées... QR Code pour partager... Carte de situation en haut à droite.", en: "Here is your smart travel journal. Compare two stations... City images found... QR Code to share... Location map on top right."
}, onbBtn: { fr: "C'est parti !", en: "Let's go!"
}, delTitle: { fr: "Supprimer ce favori ?", en: "Delete this favorite?"
}, delText: { fr: "Cette action est irréversible.", en: "This action is irreversible."
}, delNo: { fr: "Annuler", en: "Cancel" }, confirmDeleteBtn: { fr: "Supprimer", en: "Delete" }, nukeTitle: { fr: "ATTENTION", en: "WARNING" }, nukeText: { fr: "Voulez-vous vraiment détruire tout le carnet ?", en: "Do you really want to destroy the entire journal?"
}, nukeNo: { fr: "Non", en: "No" }, nukeYes: { fr: "OUI, DETRUIRE", en: "YES, DESTROY" }, vsTitle: { fr: "COMPARATEUR", en: "COMPARATOR" }, qrTitle: { fr: "Partager", en: "Share" }, qrText: { fr: "Scannez pour ouvrir Google Maps", en: "Scan to open Google Maps" }, txtGo: { fr: "Y aller", en: "Go there" },
            
            // --- NEW TRANSLATIONS ---
            googleTitle: { fr: '<i class="fa-brands fa-wikipedia-w"></i> Images de la ville', en: '<i class="fa-brands fa-wikipedia-w"></i> City Images' },
            toastMax: { fr: "Maximum 2 gares !", en: "Maximum 2 stations!" },
            toastDel: { fr: "Favori supprimé", en: "Favorite deleted" },
            imgLoad: { fr: "Chargement des images...", en: "Loading images..." },
            imgError: { fr: "Aucune image trouvée.", en: "No image found." },
            conError: { fr: "Erreur de connexion.", en: "Connection error." }
        };
function switchLangCarnet() {
            isFrCarnet = !isFrCarnet;
const t = translationsCarnet;
            document.getElementById('nav-carte').innerText = isFrCarnet ? t.navCarte.fr : t.navCarte.en;
            document.getElementById('nav-aide').innerText = isFrCarnet ? t.navAide.fr : t.navAide.en;
document.getElementById('main-title').innerText = isFrCarnet ? t.mainTitle.fr : t.mainTitle.en;
            document.getElementById('main-subtitle').innerText = isFrCarnet ? t.mainSub.fr : t.mainSub.en;
            document.getElementById('empty-text').innerText = isFrCarnet ?
t.emptyText.fr : t.emptyText.en;
            document.getElementById('btn-scan').innerText = isFrCarnet ? t.btnScan.fr : t.btnScan.en;
            document.getElementById('btn-nuke').innerText = isFrCarnet ? t.btnNuke.fr : t.btnNuke.en;
document.getElementById('btn-compare').innerText = isFrCarnet ? t.btnCompare.fr : t.btnCompare.en;
            document.getElementById('onb-title').innerText = isFrCarnet ? t.onbTitle.fr : t.onbTitle.en;
            document.getElementById('onb-text').innerText = isFrCarnet ?
t.onbText.fr : t.onbText.en;
            document.getElementById('onb-btn').innerText = isFrCarnet ? t.onbBtn.fr : t.onbBtn.en;
            document.getElementById('del-title').innerText = isFrCarnet ? t.delTitle.fr : t.delTitle.en;
document.getElementById('del-text').innerText = isFrCarnet ? t.delText.fr : t.delText.en;
            document.getElementById('del-no').innerText = isFrCarnet ? t.delNo.fr : t.delNo.en;
            document.getElementById('confirmDeleteBtn').innerText = isFrCarnet ?
t.confirmDeleteBtn.fr : t.confirmDeleteBtn.en;
            document.getElementById('nuke-title').innerText = isFrCarnet ? t.nukeTitle.fr : t.nukeTitle.en;
            document.getElementById('nuke-text').innerText = isFrCarnet ? t.nukeText.fr : t.nukeText.en;
document.getElementById('nuke-no').innerText = isFrCarnet ? t.nukeNo.fr : t.nukeNo.en;
            document.getElementById('nuke-yes').innerText = isFrCarnet ? t.nukeYes.fr : t.nukeYes.en;
            document.getElementById('vs-title').innerText = isFrCarnet ?
t.vsTitle.fr : t.vsTitle.en;
            document.getElementById('qr-title').innerText = isFrCarnet ? t.qrTitle.fr : t.qrTitle.en;
            document.getElementById('qr-text').innerText = isFrCarnet ? t.qrText.fr : t.qrText.en;
            document.getElementById('google-title').innerHTML = isFrCarnet ? t.googleTitle.fr : t.googleTitle.en;
            
document.querySelectorAll('.txt-go').forEach(el => el.innerText = isFrCarnet ? t.txtGo.fr : t.txtGo.en);

            // Re-render les cartes pour mettre à jour Vélos/Bikes etc.
            render();
        }
    </script>
</body>
</html>
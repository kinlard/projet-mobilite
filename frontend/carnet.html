<!-- Déclaration HTML5 : version moderne du langage web -->
<!DOCTYPE html>
<!-- Balise racine avec langue française pour l'accessibilité -->
<html lang="fr">
<head>
    <!-- Encodage UTF-8 : permet d'afficher tous les caractères accentués correctement -->
    <meta charset="UTF-8">
    <!-- Configuration responsive : adaptation automatique aux smartphones et tablettes -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Commentaire explicatif du rôle de cette page -->
    <!-- Page de gestion des gares favorites enregistrées par l'utilisateur -->
    <!-- Titre de l'onglet du navigateur -->
    <title>Eco-Escapade |
Tableau de Bord</title>
    <!-- Police Google Fonts Inter : police moderne et lisible pour tout le texte du tableau de bord -->
    <!-- Plusieurs graisses importées (300=light, 400=normal, 600=semi-bold, 800=extra-bold, 900=black) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <!-- Bibliothèque Font Awesome : fournit toutes les icônes (poubelle, marteau, QR code, vélo...) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliothèque Leaflet pour afficher la mini-carte des favoris -->
    <!-- CSS de Leaflet pour le style de la carte interactive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- JavaScript de Leaflet pour la logique de la carte -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Bibliothèque pour générer des QR codes partageables -->
    <!-- Permet de créer des codes QR pour partager les gares favorites -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Feuille de style principale partagée avec les autres pages -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Alerte rouge affichée lors de la séquence d'autodestruction -->
    <!-- Fond rouge clignotant qui envahit l'écran quand l'utilisateur lance la suppression totale -->
    <div class="red-alert" id="redAlert"></div>
    <!-- Écran de compte à rebours pour l'autodestruction -->
    <!-- Affiche le décompte de 5 à 0 avant la suppression définitive de toutes les données -->
    <div id="countdown-screen"></div>
    <!-- Barre de navigation du haut de page -->
    <!-- Identique aux autres pages pour cohérence de navigation -->
    <div class="dashboard-header">
        <!-- Logo du site -->
        <div class="brand"><h1>Eco-Escapade</h1></div>
        <!-- Liens de navigation vers les autres pages -->
        <div class="nav-links">
            <!-- Lien vers la page d'accueil -->
            <a href="index.html">Accueil</a>
            <!-- Lien vers la carte interactive (élément traduit dynamiquement) -->
            <a href="map.html" id="nav-carte">Carte</a>
            <!-- Lien vers la page à propos -->
            <a href="apropos.html" id="nav-about">À propos</a>
            <!-- Lien aide : ouvre la modale de présentation des fonctionnalités -->
            <!-- return false empêche le comportement par défaut du lien -->
            <a href="#" id="nav-aide" onclick="openOnboarding(); return false;">Aide</a>
        </div>
        <!-- Bouton de changement de langue FR/EN -->
        <button class="lang-switch" onclick="switchLangCarnet()">FR / EN</button>
    </div>
    <!-- Conteneur principal du tableau de bord -->
    <!-- margin-top: 120px : espace pour ne pas être masqué par la barre de navigation fixe -->
    <div class="container" style="margin-top: 120px;">
        <!-- Section supérieure avec titre et mini-carte de chaleur des favoris -->
        <!-- Affiche le titre de la page + une carte géographique montrant où sont les gares favorites -->
        <div class="top-section">
            <!-- Zone de titres -->
            <div class="titles">
                <!-- Titre principal du tableau de bord (traduit dynamiquement) -->
                <h2 id="main-title" style="font-size: 
2.5rem; margin: 0;">Tableau de Bord</h2>
                <!-- Sous-titre explicatif (traduit dynamiquement) -->
                <p id="main-subtitle" style="color:#94a3b8; margin-top: 5px;">Gérez vos futures aventures bas carbone.</p>
            </div>
            <!-- Mini-carte montrant la répartition géographique des favoris -->
            <!-- Affiche une carte Leaflet miniature avec des points rouges pour chaque gare favorite -->
            <div class="heatmap-container"><div id="miniMap"></div></div>
        </div>
        <!-- Grille contenant toutes les cartes de gares favorites -->
        <!-- Remplie dynamiquement par JavaScript avec les gares enregistrées dans localStorage -->
        <div id="grid" class="card-grid"></div>
        <!-- Message affiché si aucune gare n'est enregistrée -->
        <!-- Apparaît uniquement quand le localStorage est vide (aucun favori) -->
        <!-- display: none par défaut, devient visible si favoris.length === 0 -->
        <div id="empty" style="text-align: center;
color: #64748b; margin-top: 100px; display: none;">
            <!-- Icône fantôme pour illustrer le vide -->
            <i class="fa-solid fa-ghost" style="font-size: 3rem; margin-bottom: 20px;"></i>
            <!-- Message "Aucune donnée" (traduit dynamiquement) -->
            <p id="empty-text">Aucune donnée.</p>
            <!-- Bouton pour retourner à la carte et ajouter des favoris -->
            <a href="map.html" id="btn-scan" class="btn-main" style="width:200px;
margin: 20px auto;">Scanner la carte</a>
        </div>
        <!-- Bouton pour supprimer toutes les données enregistrées -->
        <!-- Zone de danger : action irréversible qui efface tout le localStorage -->
        <div class="danger-zone">
            <!-- Bouton rouge avec emoji explosion : déclenche la séquence d'autodestruction -->
            <button id="btn-nuke" class="btn-nuke" onclick="openNukeModal()">💥 SÉQUENCE D'AUTODESTRUCTION</button>
        </div>
    </div>
    <!-- Bouton flottant pour comparer deux gares côte à côte -->
    <!-- Visible uniquement quand exactement 2 gares sont cochées dans la grille -->
    <!-- Icône marteau : symbole de comparaison/jugement -->
    <button id="vs-btn" onclick="openVsModal()"><i class="fa-solid fa-gavel"></i> <span id="btn-compare">COMPARER</span></button>
    <!-- Notification temporaire pour informer l'utilisateur -->
    <!-- Apparaît en bas de l'écran pendant 3 secondes pour confirmer les actions -->
    <!-- Exemples : "Favori supprimé", "Max 2 sélections" -->
    <div id="toast" class="toast"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i><span id="toast-msg">Message</span></div>
    <!-- Fenêtre modale de présentation des fonctionnalités -->
    <!-- S'affiche automatiquement à la première visite pour expliquer comment utiliser le tableau de bord -->
    <!-- Peut être réouverte via le lien "Aide" dans la navigation -->
    <div id="onboardingModal" class="modal-overlay">
        <!-- Boîte de la modale avec design sombre et bordure verte -->
        <!-- max-width: 600px : largeur maximale pour lisibilité -->
        <!-- background: linear-gradient : dégradé bleu-noir pour élégance -->
        <div class="modal-box" style="max-width: 600px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border: 1px solid rgba(16, 185, 129, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(16, 185, 129, 0.1);">
            <!-- Bouton de fermeture en haut à droite (croix) -->
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            
            <!-- En-tête de la modale avec icône et titres -->
            <div style="text-align: center; margin-bottom: 30px;">
                <!-- Icône de carte dans un cercle vert avec ombre -->
                <div style="display: inline-block; background: linear-gradient(135deg, var(--primary), #059669); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                    <i class="fa-solid fa-map-marked-alt" style="color: #022c22; font-size: 3rem;"></i>
                </div>
                <!-- Titre principal de bienvenue (traduit dynamiquement) -->
                <h3 id="onb-title" style="color: white; font-size: 2rem; margin-bottom: 10px; font-weight: 900; text-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);">Bienvenue dans votre carnet de voyage !</h3>
                <!-- Sous-titre explicatif (traduit dynamiquement) -->
                <p id="onb-subtitle" style="color: #94a3b8; font-size: 1rem;">Découvrez toutes les fonctionnalités de votre tableau de bord</p>
            </div>
            
            <!-- Liste des fonctionnalités sous forme de cartes colorées -->
            <!-- Chaque carte a une couleur différente et une animation au survol -->
            <div id="onb-text" style="text-align: left; line-height: 1.8; color: #cbd5e1; display: flex; flex-direction: column; gap: 16px; margin-bottom: 30px;">
                <!-- Carte 1 : COMPARER 2 GARES -->
                <!-- Couleur verte (primary) pour la fonctionnalité principale -->
                <!-- onmouseover/onmouseout : animation de déplacement horizontal au survol -->
                <div style="display: flex; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-radius: 12px; border-left: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 12px rgba(16, 185, 129, 0.2)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
                    <!-- Icône marteau dans un carré vert -->
                    <div style="background: var(--primary); width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-solid fa-gavel" style="color: #022c22; font-size: 1.4rem;"></i>
                    </div>
                    <!-- Titre et description de la fonctionnalité (traduits dynamiquement) -->
                    <div>
                        <strong id="onb-item1-title" style="color: white; font-size: 1.05rem; display: block; margin-bottom: 4px;">Comparez 2 gares</strong>
                        <span id="onb-item1-desc" style="color: #94a3b8; font-size: 0.95rem;">Sélectionnez deux favoris pour voir leurs scores côte à côte</span>
                    </div>
                </div>
                
                <!-- Carte 2 : EXPLORER LES VILLES -->
                <!-- Couleur bleue (#3b82f6) pour l'encyclopédie Wikipedia -->
                <!-- Permet de visualiser des galeries d'images des villes desservies -->
                <div style="display: flex; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05)); border-radius: 12px; border-left: 4px solid #3b82f6; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 12px rgba(59, 130, 246, 0.2)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
                    <!-- Icône Wikipedia (W) dans un carré bleu -->
                    <div style="background: #3b82f6; width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-brands fa-wikipedia-w" style="color: white; font-size: 1.4rem;"></i>
                    </div>
                    <!-- Titre et description (traduits dynamiquement) -->
                    <div>
                        <strong id="onb-item2-title" style="color: white; font-size: 1.05rem; display: block; margin-bottom: 4px;">Explorez les villes</strong>
                        <span id="onb-item2-desc" style="color: #94a3b8; font-size: 0.95rem;">Accédez aux images Wikipedia pour découvrir chaque destination</span>
                    </div>
                </div>
                
                <!-- Carte 3 : GÉNÉRER UN QR CODE -->
                <!-- Couleur orange (#f59e0b) pour le partage/export -->
                <!-- Crée un code scannable pour partager une gare via Google Maps -->
                <div style="display: flex; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05)); border-radius: 12px; border-left: 4px solid #f59e0b; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 12px rgba(245, 158, 11, 0.2)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
                    <!-- Icône QR Code dans un carré orange -->
                    <div style="background: #f59e0b; width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-solid fa-qrcode" style="color: white; font-size: 1.4rem;"></i>
                    </div>
                    <!-- Titre et description (traduits dynamiquement) -->
                    <div>
                        <strong id="onb-item3-title" style="color: white; font-size: 1.05rem; display: block; margin-bottom: 4px;">Générez un QR Code</strong>
                        <span id="onb-item3-desc" style="color: #94a3b8; font-size: 0.95rem;">Partagez facilement vos gares préférées via code scannable</span>
                    </div>
                </div>
                
                <!-- Carte 4 : VISUALISER LA CARTE -->
                <!-- Couleur verte (#10b981) pour la géolocalisation -->
                <!-- Mini heatmap Leaflet affichée en haut du tableau de bord -->
                <div style="display: flex; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border-radius: 12px; border-left: 4px solid #10b981; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 12px rgba(16, 185, 129, 0.2)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
                    <!-- Icône carte avec épingle dans un carré vert -->
                    <div style="background: #10b981; width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-solid fa-map-location-dot" style="color: white; font-size: 1.4rem;"></i>
                    </div>
                    <!-- Titre et description (traduits dynamiquement) -->
                    <div>
                        <strong id="onb-item4-title" style="color: white; font-size: 1.05rem; display: block; margin-bottom: 4px;">Visualisez la carte</strong>
                        <span id="onb-item4-desc" style="color: #94a3b8; font-size: 0.95rem;">Voyez tous vos favoris en temps réel sur la mini-carte heatmap</span>
                    </div>
                </div>
                
                <!-- Carte 5 : GÉRER VOS FAVORIS -->
                <!-- Couleur rouge (#ef4444) pour les actions destructives -->
                <!-- Suppression individuelle via clic sur carte OU autodestruction totale -->
                <div style="display: flex; gap: 15px; padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); border-radius: 12px; border-left: 4px solid #ef4444; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.2s ease, box-shadow 0.2s ease;" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 12px rgba(239, 68, 68, 0.2)';" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';">
                    <!-- Icône poubelle dans un carré rouge -->
                    <div style="background: #ef4444; width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fa-solid fa-trash-alt" style="color: white; font-size: 1.4rem;"></i>
                    </div>
                    <!-- Titre traduit, description fixe (pas d'ID car texte unique) -->
                    <div>
                        <strong id="onb-item5-title" style="color: white; font-size: 1.05rem; display: block; margin-bottom: 4px;">Gérez vos favoris</strong>
                        <span style="color: #94a3b8; font-size: 0.95rem;">Supprimez individuellement ou lancez une séquence d'autodestruction complète</span>
                    </div>
                </div>
            </div>
            
            <!-- Bouton principal pour fermer le tutoriel et commencer -->
            <!-- Design élaboré avec dégradé, ombre, transition smooth -->
            <!-- onclick="closeAll()" : ferme toutes les modales -->
            <button id="onb-btn" class="btn-main" onclick="closeAll()" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, var(--primary), #059669); color: white; font-weight: 900; border: none; padding: 16px 24px; border-radius: 12px; cursor: pointer; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden;">
                <!-- Contenu du bouton avec icône fusée et texte -->
                <!-- position: relative; z-index: 1 : assure que le texte reste au-dessus de l'ombre -->
                <span style="position: relative; z-index: 1; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fa-solid fa-rocket"></i>
                    Commencer l'exploration !
                </span>
            </button>
            
            <!-- Styles CSS pour le bouton d'onboarding -->
            <!-- Animation de soulèvement au survol + effet lumineux balayé -->
            <style>
                /* Animation au survol : bouton monté de 2px + ombre élargie */
                #onb-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 15px 35px rgba(16, 185, 129, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.2);
                }
                /* Retour à la position normale quand le bouton est cliqué */
                #onb-btn:active {
                    transform: translateY(0);
                }
                /* Pseudo-élément pour l'effet de lumière qui traverse le bouton */
                /* Bande blanche semi-transparente positionnée hors du bouton */
                #onb-btn::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    transition: left 0.5s ease;
                }
                /* Au survol : la bande traverse de gauche à droite en 0.5s */
                #onb-btn:hover::before {
                    left: 100%;
                }
            </style>
        </div>
    </div>
    <!-- Modale pour afficher la galerie d'images Wikipedia d'une ville -->
    <!-- S'ouvre quand l'utilisateur clique sur une carte de favori -->
    <!-- Récupère les images via l'API Wikimedia Commons -->
    <div id="googlePhotosModal" class="modal-overlay">
        <div class="modal-box">
            <!-- Bouton de fermeture en haut à droite -->
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <!-- Titre avec icône Wikipedia (W) en couleur primaire -->
            <!-- id="google-title" pour le ciblage CSS -->
            <h3 class="google-title" id="google-title" style="margin-bottom:10px; font-size:1.6rem; color:var(--primary); display:flex; align-items:center; gap:12px;"><i class="fa-brands fa-wikipedia-w"></i> <span id="google-title-text">Images de la ville</span></h3>
            <!-- Affiche le nom de la ville recherchée (injecté par JavaScript) -->
            <p id="googleQuery" style="color:#94a3b8; margin-bottom:20px; font-style:italic; font-size:0.95rem;"></p>
            <!-- Grille d'images remplie dynamiquement par fetchWikimediaImage() -->
            <!-- Par défaut : spinner de chargement -->
            <div class="google-grid" id="googleGrid"><div style="color:#94a3b8; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i></div></div>
        </div>
    </div>
    <!-- Modale pour afficher le QR Code d'une gare -->
    <!-- Génère un code scannable pour ouvrir Google Maps avec les coordonnées de la gare -->
    <div id="qrModal" class="modal-overlay">
        <div class="modal-box">
            <!-- Bouton de fermeture -->
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <!-- Titre avec icône QR Code centré -->
            <h3 id="qr-title" style="margin-bottom:20px; font-size:1.6rem; color:var(--primary); display:flex; align-items:center; justify-content:center; gap:10px;"><i class="fa-solid fa-qrcode"></i> <span>Partager</span></h3>
            <!-- Conteneur du QR Code : fond blanc pour meilleure lisibilité du code -->
            <!-- Dimensions : 160x160px + padding 15px = carré de 190px total -->
            <!-- animation: slideUp : apparition animée depuis le bas -->
            <div id="qrcode" style="margin: 30px auto; width: 160px; height: 160px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); animation: slideUp 0.5s ease-out;"></div>
            <!-- Instruction de scan avec flèche montante -->
            <p id="qr-text" style="font-size:0.95rem; color:#94a3b8; margin-top: 20px; font-style: italic;">
                <i class="fa-solid fa-arrow-up" style="margin-right: 8px;"></i>
                Scannez pour ouvrir Google Maps
            </p>
        </div>
    </div>
    <!-- Modale de confirmation pour l'autodestruction -->
    <!-- Demande confirmation avant d'effacer TOUS les favoris -->
    <!-- Design alarmant avec bordure rouge et ombres rouges -->
    <div id="nukeModal" class="modal-overlay">
        <!-- Boîte modale avec bordure rouge épaisse et éclat rouge -->
        <div class="modal-box" style="border: 2px solid #ef4444; box-shadow: 0 0 60px rgba(239,68,68,0.3), 0 20px 60px rgba(0,0,0,0.4);">
            <!-- Icône triangle d'avertissement pulsante (animation pulse) -->
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px; animation: pulse 2s ease-in-out infinite;"></i>
            <!-- Titre "ATTENTION" en rouge vif -->
            <h3 id="nuke-title" style="color: #ef4444; font-size: 1.6rem; margin-bottom: 15px;">ATTENTION</h3>
            <!-- Texte de confirmation (traduit dynamiquement) -->
            <p id="nuke-text" style="color: #cbd5e1; margin-bottom: 25px;">Voulez-vous vraiment détruire tout le carnet ?</p>
            <!-- Deux boutons : Annuler (gris) et OUI, DÉTRUIRE (rouge) -->
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <!-- Bouton Annuler : fond semi-transparent, bordure blanche -->
                <button id="nuke-no" onclick="closeAll()" style="padding: 12px 28px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Annuler</button>
                <!-- Bouton Détruire : rouge vif avec ombre rouge, déclenche startSelfDestruct() -->
                <button id="nuke-yes" onclick="startSelfDestruct()" style="padding: 12px 28px; background: #ef4444; border: none; color: white; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">OUI, DÉTRUIRE</button>
            </div>
        </div>
    </div>
    
    <!-- Styles CSS pour les animations de la modale d'autodestruction -->
    <style>
        /* Animation pulsation pour l'icône d'avertissement */
        /* Agrandit l'icône de 10% toutes les secondes */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        /* Animation au survol du bouton Annuler : fond plus clair + zoom 5% */
        #nuke-no:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        /* Animation au survol du bouton Détruire : rouge plus foncé + zoom + ombre élargie */
        #nuke-yes:hover {
            background: #dc2626;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.5);
        }
    </style>
    <!-- Modale de confirmation pour supprimer UN seul favori -->
    <!-- S'ouvre quand l'utilisateur clique sur une carte de gare dans la grille -->
    <div id="deleteSingleModal" class="modal-overlay">
        <div class="modal-box">
            <!-- Bouton de fermeture -->
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <!-- Titre avec icône poubelle en rouge -->
            <h3 id="del-title" style="margin-bottom: 15px; font-size: 1.6rem; color: #ef4444;"><i class="fa-solid fa-trash-alt" style="margin-right: 10px;"></i>Supprimer ce favori ?</h3>
            <!-- Avertissement : action irréversible -->
            <p id="del-text" style="color: #94a3b8; margin-bottom: 25px; font-size: 0.95rem;">Cette action est <strong style="color: #ef4444;">irréversible</strong></p>
            <!-- Deux boutons : Annuler (gris) et Supprimer (rouge) -->
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button id="del-no" onclick="closeAll()" style="padding: 12px 28px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Annuler</button>
                <!-- Le onclick sera attaché dynamiquement par JavaScript avec l'ID du favori à supprimer -->
                <button id="confirmDeleteBtn" style="padding: 12px 28px; background: #ef4444; border: none; color: white; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">Supprimer</button>
            </div>
        </div>
    </div>
    
    <!-- Styles CSS pour les animations de la modale de suppression individuelle -->
    <style>
        /* Animation au survol du bouton Annuler */
        #del-no:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        /* Animation au survol du bouton Supprimer */
        #confirmDeleteBtn:hover {
            background: #dc2626;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.5);
        }
    </style>
    <!-- Modale de comparaison côte à côte de 2 gares -->
    <!-- S'ouvre quand exactement 2 gares sont sélectionnées via les checkboxes -->
    <div id="vsModal" class="modal-overlay">
        <!-- Boîte modale large (850px) avec fond bleu très foncé -->
        <div class="modal-box" style="max-width: 850px; background: #0f172a; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);">
            <!-- Bouton de fermeture -->
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            
            <!-- En-tête avec titre et sous-titre -->
            <!-- border-bottom : ligne de séparation en bas de l'en-tête -->
            <div style="border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 25px; margin-bottom: 35px;">
                <!-- Titre "COMPARATEUR" en majuscules avec espacement de lettres -->
                <h2 id="vs-title" style="color: white; font-size: 1.8rem; margin: 0; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;">
                    Comparateur
                </h2>
                <!-- Sous-titre descriptif en gris -->
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 10px;">Analyse comparative des équipements</p>
            </div>
            
            <!-- Conteneur principal de la comparaison -->
            <!-- Rempli dynamiquement par JavaScript avec les données des 2 gares -->
            <div id="vsContent"></div>
        </div>
    </div>

    <!-- BLOC JAVASCRIPT PRINCIPAL -->
    <!-- Gère toute la logique du tableau de bord : affichage, modales, favoris, carte -->
    <script>
        // Fonction de sécurité : échappe les caractères HTML pour éviter les injections XSS
        // Remplace &, <, >, ', " par leurs équivalents HTML sécurisés
        const escapeHTML = (str) => str ? str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag])) : '';

        // Variable de langue : true = Français, false = Anglais
        // MODIFIÉ : Déplacée en haut pour être accessible dans render()
        let isFrCarnet = true;
        
        // Placeholder pour les textes traduits du tableau de bord
        // Sera rempli par l'import du module textes.js
        let DASHBOARD_TEXTS = {};
        
        // Cache pour les images Wikipedia préchargées
        // Évite de refaire des appels API pour les mêmes villes
        let wikiImageCache = {};

        // Récupération des favoris depuis le localStorage
        // Si aucune donnée enregistrée : tableau vide par défaut
        let favoris = JSON.parse(localStorage.getItem('eco_favoris')) || [];
        // Migration des anciens favoris : ajoute score et détails manquants
        // Boucle sur chaque favori pour vérifier la présence du score
        favoris = favoris.map(f => {
            // Si le score n'existe pas : génère un score aléatoire entre 5.0 et 10.0
            if(f.score === undefined) { 
                f.score = Math.floor(Math.random() * 50 + 50) / 10; 
                // Génère aussi des détails aléatoires pour vélos, bornes électriques, covoiturage
                f.details = { velos: Math.floor(Math.random()*20), bornes: Math.floor(Math.random()*10), covoit: Math.floor(Math.random()*5) };
            }
            return f;
        });

        // Références DOM pour manipuler les éléments HTML
        const grid = document.getElementById('grid');  // Grille de cartes
        const empty = document.getElementById('empty');  // Message "Aucune donnée"
        let selectedVs = [];  // Tableau des indices sélectionnés pour comparaison (max 2)
        let itemToDeleteIndex = null;  // Index du favori à supprimer

        // FONCTION PRINCIPALE : Affiche la liste des favoris sous forme de grille de cartes
        // Appelée au chargement initial et après chaque modification (ajout/suppression)
        function render() {
            // Si aucun favori : affiche le message vide et arrête l'exécution
            if (favoris.length === 0) { empty.style.display = 'block'; grid.innerHTML = ''; return; }
            // Tri des favoris par score décroissant (meilleurs scores en premier)
            favoris.sort((a,b) => (b.score||0) - (a.score||0));
            // Vide la grille avant de la remplir
            grid.innerHTML = '';
            // Boucle sur chaque favori pour créer une carte HTML
            favoris.forEach((fav, index) => {
                // Récupère le score (ou '?' si undefined)
                const score = fav.score !== undefined ? fav.score : '?';
                // Récupère les détails (vélos, bornes, covoiturage) ou valeurs par défaut
                const details = fav.details || { velos: 0, bornes: 0, covoit: 0 };
                // Détermine la couleur selon le score : rouge < 5, orange 5-8, vert >= 8
                let color = '#ef4444'; if(score >= 5) color = '#f59e0b'; if(score >= 8) color = '#10b981';
                // Calcule l'angle pour le graphique circulaire (score sur 10 × 36° = 360°)
                const deg = (score !== '?' ? score : 0) * 36;
                // Crée un dégradé conique pour visualiser le score
                const gradient = `conic-gradient(${color} ${deg}deg, #334155 0deg)`;
                // Sécurise le nom de la gare contre les injections XSS
                const safeName = escapeHTML(fav.nom);

                // Crée un élément div pour la carte
                const div = document.createElement('div');
                div.className = 'card';
                // Génère le HTML de la carte avec toutes ses fonctionnalités
                div.innerHTML = `
                    <!-- Checkbox pour sélectionner la gare pour comparaison (max 2) -->
                    <input type="checkbox" id="chk-${index}" class="vs-checkbox-input" onchange="toggleVs(${index}, this)">
                    <!-- Label avec icône check personnalisée -->
                    <label for="chk-${index}" class="vs-label"><i class="fa-solid fa-check"></i></label>
                    <!-- Haut de la carte : badge de type (TGV/TER) + nom de la gare -->
                    <div class="card-top"><div><span class="badge ${fav.type}">${fav.type}</span><h3>${safeName}</h3></div></div>
                    <!-- Ligne du score : graphique circulaire + statistiques -->
                    <div class="score-row">
                        <!-- Cercle de score avec dégradé conique visualisant la note sur 10 -->
                        <div class="circle-wrap" style="background: ${gradient}"><div class="circle-inner">${score}</div></div>
                        <!-- Liste des statistiques : vélos, bornes, covoiturage -->
                        <div class="stats-list">
                            <!-- Stat 1 : Nombre de vélos disponibles (icône cyan) -->
                            <div class="stat-item"><i class="fa-solid fa-bicycle" style="color:#06b6d4; width:20px;"></i> ${details.velos} ${isFrCarnet ? 'Vélos' : 'Bikes'}</div>
                            <!-- Stat 2 : Nombre de bornes électriques (icône orange) -->
                            <div class="stat-item"><i class="fa-solid fa-plug" style="color:#f59e0b; width:20px;"></i> ${details.bornes} ${isFrCarnet ? 'Bornes' : 'Terminals'}</div>
                            <!-- Stat 3 : Nombre de places covoiturage (icône violet) -->
                            <div class="stat-item"><i class="fa-solid fa-car" style="color:#a855f7; width:20px;"></i> ${details.covoit} ${isFrCarnet ? 'Covoit' : 'Carpool'}</div>
                        </div>
                    </div>
                    <a href="map.html?target=${fav.id}" class="btn-main"><i class="fa-solid fa-location-arrow"></i> <span class="txt-go">Y aller</span></a>
                    <div class="tools-grid">
      
                   <button class="tool-btn google" title="${isFrCarnet?'Photos':'Photos'}" onclick="openGooglePhotos('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-image"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'Google Maps':'Google Maps'}" onclick="openGoogleMaps('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-map-location-dot"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'QR Code':'QR Code'}" onclick="openQr('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-qrcode"></i></button>
             
           <button class="tool-btn del" title="${isFrCarnet?'Supprimer':'Delete'}" onclick="askDelete(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(div);
            });
            
            // Précharge les images Wikipedia en arrière-plan après l'affichage
            // Améliore la vitesse d'ouverture des galeries
            preloadWikipediaImages();
        }
        
        // FONCTION : Précharge les images Wikipedia en arrière-plan
        // Appelée à la fin de render() pour accélérer l'ouverture des galeries
        // Charge les images silencieusement sans bloquer l'interface
        async function preloadWikipediaImages() {
            // Boucle sur tous les favoris
            favoris.forEach((fav) => {
                // Lance la requête de recherche d'image pour chaque ville
                fetchWikimediaImage(fav.nom).catch(() => {
                    // Erreur silencieuse : n'affecte pas l'expérience utilisateur
                    // Les images seront simplement rechargées à la demande
                });
            });
        }
        
        // FONCTION : Recherche une image sur Wikimedia Commons pour une gare
        // Utilisée pour le preload ET pour l'affichage en galerie
        // Retourne l'URL de la première image trouvée (500px de largeur)
        async function fetchWikimediaImage(nom) {
            // Nettoyage du nom de la gare : retire "Gare de", "TGV", "Centre"
            const cleanName = nom.split(' - ')[0].replace(/Gare de\s?/gi, '').replace(/TGV/gi, '').replace(/Centre/gi, '').trim();
            // Extrait le nom de la ville (premier mot avant tiret ou espace)
            const villeName = cleanName.split(/[-\s]/)[0];
            
            // Liste de termes de recherche à tester (du plus précis au plus général)
            const searchTerms = [
                `${villeName} gare SNCF`,  // Ex: "Lyon gare SNCF"
                `Gare de ${cleanName}`,     // Ex: "Gare de Lyon Part-Dieu"
                `${villeName} train station`,  // Version anglaise
                villeName                   // Juste le nom de la ville                   // Juste le nom de la ville
            ];
            
            // Essaie chaque terme de recherche jusqu'à trouver une image
            for (const term of searchTerms) {
                try {
                    // API Wikimedia Commons : recherche de fichiers par mot-clé
                    // srnamespace=6 : espace de noms "Fichier:"
                    // srlimit=5 : maximum 5 résultats par recherche
                    const url = `https://commons.wikimedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(term)}&srnamespace=6&srlimit=5&format=json&origin=*`;
                    // Timeout de 5 secondes pour éviter les blocages
                    const r = await fetch(url, { signal: AbortSignal.timeout(5000) });
                    const d = await r.json();
                    
                    // Vérifie si des résultats ont été trouvés
                    if (d.query?.search?.length > 0) {
                        // Parcourt les résultats pour trouver une image
                        for (const result of d.query.search) {
                            // Vérifie que le fichier est bien une image (jpg, png, gif, webp)
                            if (/\.(jpg|jpeg|png|gif|webp)$/i.test(result.title)) {
                                // Retire le préfixe "File:" du nom
                                const fileName = result.title.replace(/^File:/i, '');
                                // Retourne l'URL de l'image redimensionnée à 500px
                                return `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(fileName)}?width=500`;
                            }
                        }
                    }
                } catch (e) {
                    // Erreur : passe au terme de recherche suivant
                    continue;
                }
            }
            // Aucune image trouvée avec aucun des termes : lance une erreur
            throw new Error('Pas d\'image trouvée');
        }
        
        // Appel initial : affiche les favoris au chargement de la page
        render();
        // Si des favoris existent : crée la mini-carte Leaflet en haut du tableau de bord
        if(favoris.length > 0) {
            // Délai de 500ms pour laisser le temps au DOM de se charger complètement
            setTimeout(() => {
                // Initialise la carte Leaflet dans le conteneur #miniMap
                // zoomControl:false : désactive les boutons +/- de zoom
                // attributionControl:false : cache le copyright Leaflet
                // setView([46.5, 2.5], 5) : centre sur la France, zoom niveau 5
                const miniMap = L.map('miniMap', { zoomControl:false, attributionControl:false }).setView([46.5, 2.5], 5);
                // Ajoute le fond de carte sombre (CartoDB Dark)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(miniMap);
                
                // Tableau pour stocker les coordonnées de tous les favoris
                const bounds = [];
                // Boucle sur chaque favori pour ajouter un marqueur
                favoris.forEach((f, idx) => {
                    // Utilise les coordonnées réelles si disponibles, sinon génère des positions cohérentes
                    let lat, lon;
                    if (f.lat && f.lon) {
                        // Coordonnées GPS réelles de la gare
                        lat = f.lat;
                        lon = f.lon;
                    } else {
                        // Génère des coordonnées cohérentes basées sur un hash du nom
                        // Hash = somme des codes ASCII des caractères du nom
                        const hash = f.nom.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                        lat = 43 + (hash % 10); // Latitude entre 43 et 53 (France)
                        lon = -2 + (hash % 8);  // Longitude entre -2 et 6 (France)
                    }
                    
                    // Ajoute les coordonnées au tableau bounds
                    bounds.push([lat, lon]);
                    // Crée un marqueur circulaire rouge à cette position
                    L.circleMarker([lat, lon], { 
                        radius: 6,              // Rayon de 6 pixels
                        color: '#ef4444',       // Bordure rouge
                        fillColor: '#ef4444',   // Remplissage rouge
                        fillOpacity: 0.9,       // Opacité 90%
                        weight: 2,              // Épaisseur de la bordure
                        stroke: true            // Affiche la bordure
                    }).addTo(miniMap);
                });
                
                // Ajuste automatiquement la vue pour afficher tous les marqueurs
                // padding: [30, 30] : marge de 30px autour des marqueurs
                // maxZoom: 6 : ne zoom pas plus que le niveau 6 (vue régionale)
                if (bounds.length > 0) {
                    miniMap.fitBounds(bounds, { padding: [30, 30], maxZoom: 6 });
                }
            }, 500);
        }

        // FONCTION : Affiche une notification toast en bas de l'écran
        // Utilisée pour confirmer les actions (suppression, sélection, etc.)
        function showToast(msg) {
            const t = document.getElementById('toast');
            // Met le message dans le span #toast-msg
            document.getElementById('toast-msg').innerText = msg;
            // Ajoute la classe 'visible' pour l'animation d'apparition
            t.classList.add('visible');
            // Retire la classe après 3 secondes (disparition automatique)
            setTimeout(() => t.classList.remove('visible'), 3000);
        }
        // FONCTION : Ferme toutes les modales ouvertes
        function closeAll() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }
        // FONCTION : Ouvre une modale spécifique par son ID
        function openModal(id) { document.getElementById(id).classList.add('active'); }

        // FONCTION : Ouvre la galerie d'images Wikipedia pour une gare
        // Recherche d'abord sur Wikimedia Commons, puis fallback sur Wikipedia
        async function openGooglePhotos(nom) {
            // Nettoie le nom de la gare : retire "Gare de", "TGV", "Centre"
            let cleanCity = nom.split(' - ')[0].replace(/Gare de\s?/gi, '').replace(/TGV/gi, '').replace(/Centre/gi, '').trim();
            // Extrait le nom de la ville (premier mot)
            const villeName = cleanCity.split(/[-\s]/)[0];
            // Affiche le nom recherché dans la modale
            document.getElementById('googleQuery').innerText = `${isFrCarnet ? 'Recherche pour :' : 'Search for:'} "${cleanCity}"`;
            // Ouvre la modale de galerie
            openModal('googlePhotosModal');
            const grid = document.getElementById('googleGrid');
            
            // Vérifie si l'image est déjà en cache (preloadée ou déjà chargée)
            if (wikiImageCache[villeName]) {
                console.log('✅ Image en cache:', villeName);
                // Affiche directement l'image en cache, fallback sur Unsplash si erreur
                grid.innerHTML = `<img src="${wikiImageCache[villeName]}" class="google-pic" alt="${cleanCity}" onerror="this.src='https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=600&q=80'">`;
                return;
            }
            
            // Affiche un spinner de chargement pendant la requête
            grid.innerHTML = `<div style="color:#94a3b8; padding:20px;"><i class="fa-solid fa-spinner fa-spin"></i> ${isFrCarnet ? 'Chargement des images...' : 'Loading images...'}</div>`;
            
            try {
                // Utilise la fonction fetchWikimediaImage pour chercher sur Wikimedia Commons
                const imgSrc = await fetchWikimediaImage(nom);
                // Met l'image en cache pour les prochaines utilisations
                wikiImageCache[villeName] = imgSrc;
                // Affiche l'image trouvée, avec fallback Unsplash si chargement échoue
                grid.innerHTML = `<img src="${imgSrc}" class="google-pic" alt="${cleanCity}" onerror="this.src='https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=600&q=80'">`;
            } catch(e) {
                // Si Wikimedia Commons échoue : tente l'API Wikipedia
                console.log('Fallback: No Wikimedia image, trying Wikipedia');
                try {
                    // API Wikipedia : recherche de l'image principale de la page
                    const wikiUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(villeName)}&prop=pageimages&format=json&pithumbsize=600&origin=*`;
                    const wr = await fetch(wikiUrl);
                    const wd = await wr.json();
                    const wpages = wd.query.pages;
                    const wpid = Object.keys(wpages)[0];
                    
                    // Vérifie si une page et une miniature existent
                    if (wpid !== "-1" && wpages[wpid].thumbnail) {
                        const imgSrc = wpages[wpid].thumbnail.source;
                        // Met en cache
                        wikiImageCache[villeName] = imgSrc;
                        grid.innerHTML = `<img src="${imgSrc}" class="google-pic" alt="${cleanCity}" onerror="this.src='https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=600&q=80'">`;
                    } else {
                        // Aucune image Wikipedia : fallback final sur Unsplash (photo de train)
                        grid.innerHTML = `<img src="https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=600&q=80" class="google-pic" alt="${cleanCity}">`;
                    }
                } catch(e2) {
                    // Échec total : affiche l'image Unsplash par défaut
                    grid.innerHTML = `<img src="https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=600&q=80" class="google-pic" alt="${cleanCity}">`;
                }
            }
        }

        // FONCTION : Ouvre Google Maps avec la recherche de la gare
        // Exposée globalement via window pour être accessible depuis le HTML généré dynamiquement
        window.openGoogleMaps = (nom) => { window.open(`https://www.google.com/maps/search/?api=1&query=Gare+${encodeURIComponent(nom.replace(/Gare de\s?/gi, ''))}`);
        };
        // FONCTION : Génère et affiche un QR Code pour partager la gare
        // Le QR Code contient un lien Google Maps direct
        window.openQr = (nom) => {
            const container = document.getElementById('qrcode');
            // Vide le conteneur avant de générer un nouveau QR Code
            container.innerHTML = '';
            // Génère le QR Code (128x128px) avec la bibliothèque QRCode.js
            new QRCode(container, { text: `https://www.google.com/maps/search/?api=1&query=Gare+${encodeURIComponent(nom)}`, width: 128, height: 128 });
            // Ouvre la modale QR Code
            openModal('qrModal');
        };
        // FONCTION : Demande confirmation avant de supprimer un favori
        window.askDelete = (index) => { itemToDeleteIndex = index; openModal('deleteSingleModal'); };
        // Événement : Confirmation de suppression d'un favori
        document.getElementById('confirmDeleteBtn').onclick = () => {
            if(itemToDeleteIndex !== null) {
                // Supprime le favori du tableau
                favoris.splice(itemToDeleteIndex, 1);
                // Sauvegarde dans localStorage
                localStorage.setItem('eco_favoris', JSON.stringify(favoris));
                // Réaffiche la grille, ferme modales, affiche confirmation
                render(); closeAll(); showToast(isFrCarnet ? '✅ Favori supprimé' : '✅ Favorite removed');
            }
        };
        // FONCTION : Gère la sélection/désélection des gares pour comparaison
        // Maximum 2 gares sélectionnées simultanément
        window.toggleVs = (index, checkbox) => {
            if (checkbox.checked) {
                // Vérifie la limite de 2 sélections
                if (selectedVs.length >= 2) { checkbox.checked = false;
                    // Affiche un avertissement si l'utilisateur essaie de sélectionner une 3ème gare
                    showToast(isFrCarnet ? '⚠️ Max 2 sélections' : '⚠️ Max 2 selections'); return; }
                // Ajoute l'index au tableau des sélections
                selectedVs.push(index);
            } else {
                // Retire l'index du tableau des sélections
                selectedVs = selectedVs.filter(i => i !== index);
            }
            // Référence au bouton flottant "COMPARER"
            const btn = document.getElementById('vs-btn');
            // Affiche le bouton uniquement quand exactement 2 gares sont sélectionnées
            if (selectedVs.length === 2) btn.classList.add('visible');
            else btn.classList.remove('visible');
        };

        // FONCTION : Ouvre la modale de comparaison côte à côte de 2 gares
        // Affiche scores et équipements avec mise en surbrillance du meilleur
        window.openVsModal = () => {
            // Récupère les 2 gares sélectionnées
            const f1 = favoris[selectedVs[0]];
            const f2 = favoris[selectedVs[1]];
            // Fonction pour déterminer le gagnant : retourne une classe CSS
            // 'val-win' si v1 > v2, 'val-lose' si v1 < v2, '' si égalité
            const winner = (v1, v2) => v1 > v2 ? 'val-win' : (v1 < v2 ? 'val-lose' : '');
            
            // Labels traduits pour la modale de comparaison
            const lblScore = isFrCarnet ? "Score global" : "Global score";
            const lblVelos = isFrCarnet ? "Vélos" : "Bikes";
            const lblBornes = isFrCarnet ? "Bornes électriques" : "Charging stations";
            const lblCovoit = isFrCarnet ? "Covoiturage" : "Carpool";

            // Génère le HTML de la modale de comparaison
            // Grille 3 colonnes : Gare 1 | VS | Gare 2
            document.getElementById('vsContent').innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 35px; align-items: start;">
                    <div>
                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(96, 165, 250, 0.15); display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-train" style="color: #60a5fa; font-size: 1.1rem;"></i>
                                </div>
                                <h3 style="margin: 0; font-size: 1.05rem; font-weight: 600; color: white; flex: 1;">${escapeHTML(f1.nom)}</h3>
                            </div>
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="display: inline-block; width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(#60a5fa ${(f1.score * 36)}deg, rgba(255,255,255,0.06) 0deg); padding: 6px; box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);">
                                    <div style="width: 100%; height: 100%; border-radius: 50%; background: #0f172a; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <div style="font-size: 2rem; font-weight: 900; color: #60a5fa;">${f1.score}</div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-top: -2px; letter-spacing: 0.5px;">/10</div>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Score global</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 6px; background: rgba(6, 182, 212, 0.15); display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-bicycle" style="color: #06b6d4; font-size: 0.9rem;"></i>
                                        </div>
                                        <span style="font-size: 0.9rem; color: #cbd5e1; font-weight: 500;">${lblVelos}</span>
                                    </div>
                                    <span class="${winner(f1.details.velos, f2.details.velos)}" style="font-size: 1.2rem; font-weight: 800;">${f1.details.velos}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 6px; background: rgba(245, 158, 11, 0.15); display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-plug" style="color: #f59e0b; font-size: 0.9rem;"></i>
                                        </div>
                                        <span style="font-size: 0.9rem; color: #cbd5e1; font-weight: 500;">${lblBornes}</span>
                                    </div>
                                    <span class="${winner(f1.details.bornes, f2.details.bornes)}" style="font-size: 1.2rem; font-weight: 800;">${f1.details.bornes}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 6px; background: rgba(168, 85, 247, 0.15); display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-car" style="color: #a855f7; font-size: 0.9rem;"></i>
                                        </div>
                                        <span style="font-size: 0.9rem; color: #cbd5e1; font-weight: 500;">${lblCovoit}</span>
                                    </div>
                                    <span class="${winner(f1.details.covoit, f2.details.covoit)}" style="font-size: 1.2rem; font-weight: 800;">${f1.details.covoit}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; padding-top: 80px;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.04); border: 2px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);">
                            <span style="font-size: 1.1rem; font-weight: 800; color: #94a3b8; letter-spacing: 1px;">VS</span>
                        </div>
                    </div>
                    
                    <div>
                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                                <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(59, 130, 246, 0.15); display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-train" style="color: #3b82f6; font-size: 1.1rem;"></i>
                                </div>
                                <h3 style="margin: 0; font-size: 1.05rem; font-weight: 600; color: white; flex: 1;">${escapeHTML(f2.nom)}</h3>
                            </div>
                            <div style="text-align: center; margin-bottom: 25px;">
                                <div style="display: inline-block; width: 90px; height: 90px; border-radius: 50%; background: conic-gradient(#3b82f6 ${(f2.score * 36)}deg, rgba(255,255,255,0.06) 0deg); padding: 6px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);">
                                    <div style="width: 100%; height: 100%; border-radius: 50%; background: #0f172a; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;">${f2.score}</div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-top: -2px; letter-spacing: 0.5px;">/10</div>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Score global</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 6px; background: rgba(6, 182, 212, 0.15); display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-bicycle" style="color: #06b6d4; font-size: 0.9rem;"></i>
                                        </div>
                                        <span style="font-size: 0.9rem; color: #cbd5e1; font-weight: 500;">${lblVelos}</span>
                                    </div>
                                    <span class="${winner(f2.details.velos, f1.details.velos)}" style="font-size: 1.2rem; font-weight: 800;">${f2.details.velos}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 6px; background: rgba(245, 158, 11, 0.15); display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-plug" style="color: #f59e0b; font-size: 0.9rem;"></i>
                                        </div>
                                        <span style="font-size: 0.9rem; color: #cbd5e1; font-weight: 500;">${lblBornes}</span>
                                    </div>
                                    <span class="${winner(f2.details.bornes, f1.details.bornes)}" style="font-size: 1.2rem; font-weight: 800;">${f2.details.bornes}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 6px; background: rgba(168, 85, 247, 0.15); display: flex; align-items: center; justify-content: center;">
                                            <i class="fa-solid fa-car" style="color: #a855f7; font-size: 0.9rem;"></i>
                                        </div>
                                        <span style="font-size: 0.9rem; color: #cbd5e1; font-weight: 500;">${lblCovoit}</span>
                                    </div>
                                    <span class="${winner(f2.details.covoit, f1.details.covoit)}" style="font-size: 1.2rem; font-weight: 800;">${f2.details.covoit}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            openModal('vsModal');
        };
        // FONCTION : Ouvre la modale de confirmation d'autodestruction
        window.openNukeModal = () => document.getElementById('nukeModal').classList.add('active');
        // FONCTION : Lance la séquence d'autodestruction (compte à rebours + suppression totale)
        window.startSelfDestruct = () => {
            closeAll();
            // Active les effets visuels : tremblement + alerte rouge
            document.body.classList.add('shaking'); document.getElementById('redAlert').classList.add('active'); 
            // Affiche l'écran de compte à rebours
            const screen = document.getElementById('countdown-screen');
            screen.style.display = 'flex';
            // Initialise le compteur à 5
            let count = 5; screen.innerHTML = count;
            // Démarre le timer : décrémente chaque seconde
            const timer = setInterval(() => {
                count--; screen.innerHTML = count;
                // Quand le compte atteint 0 : supprime tout et recharge la page
                if(count <= 0) { clearInterval(timer); screen.innerHTML = isFrCarnet ? "PURGE TERMINÉE" : "PURGE COMPLETE"; localStorage.removeItem('eco_favoris'); setTimeout(() => location.reload(), 2000); }
            }, 1000);
        };
        // FONCTION : Ouvre la modale d'onboarding (tutoriel de bienvenue)
        window.openOnboarding = () => document.getElementById('onboardingModal').classList.add('active');
        // Si première visite : affiche automatiquement le tutoriel après 1 seconde
        if(!localStorage.getItem('visited_carnet_final')) { setTimeout(openOnboarding, 1000); localStorage.setItem('visited_carnet_final', 'true');
        }
        
        // Initialise les traductions au chargement de la page
        // Double toggle pour s'assurer que tous les textes sont correctement chargés
        document.addEventListener('DOMContentLoaded', () => {
            if (window.switchLangCarnet) {
                // Bascule vers français puis anglais pour forcer le chargement des textes
                isFrCarnet = true;
                switchLangCarnet();
                isFrCarnet = false;
                switchLangCarnet();
            }
        });
    </script>
    
    <!-- Script placeholder : définit switchLangCarnet vide pour éviter les erreurs -->
    <!-- Sera redéfini par le script module ci-dessous -->
    <script>
        // Définit la fonction globalement pour éviter les erreurs avant le chargement du module
        window.switchLangCarnet = function() {};
    </script>
    
    <!-- Script module ES6 : importe les traductions et gère le changement de langue -->
    <script type="module">
        // Importe les textes traduits depuis textes.js
        import { DASHBOARD_TEXTS as DT } from './js/textes.js';
        
        // Rend DASHBOARD_TEXTS accessible globalement pour le script non-module
        window.DASHBOARD_TEXTS = DT;

        // FONCTION : Change la langue de l'interface (FR ⇄ EN)
        // Met à jour tous les textes de la page en temps réel
        function switchLangCarnet() {
            // Inverse la langue actuelle
            isFrCarnet = !isFrCarnet;
            // Récupère les textes traduits
            const t = window.DASHBOARD_TEXTS;
            // Met à jour tous les éléments de navigation
            document.getElementById('nav-carte').innerText = isFrCarnet ? t.navCarte.fr : t.navCarte.en;
            document.getElementById('nav-aide').innerText = isFrCarnet ? t.navAide.fr : t.navAide.en;
            // Met à jour le titre principal et sous-titre
            document.getElementById('main-title').innerText = isFrCarnet ? t.mainTitle.fr : t.mainTitle.en;
            document.getElementById('main-subtitle').innerText = isFrCarnet ? t.mainSub.fr : t.mainSub.en;
            // Met à jour le message d'état vide
            document.getElementById('empty-text').innerText = isFrCarnet ? t.emptyText.fr : t.emptyText.en;
            document.getElementById('btn-scan').innerText = isFrCarnet ? t.btnScan.fr : t.btnScan.en;
            // Met à jour le bouton d'autodestruction
            document.getElementById('btn-nuke').innerText = isFrCarnet ? t.btnNuke.fr : t.btnNuke.en;
            document.getElementById('btn-compare').innerText = isFrCarnet ? t.btnCompare.fr : t.btnCompare.en;
            // Met à jour tous les textes de la modale onboarding
            document.getElementById('onb-title').innerText = isFrCarnet ? t.onbTitle.fr : t.onbTitle.en;
            document.getElementById('onb-subtitle').innerText = isFrCarnet ? t.onbSubtitle.fr : t.onbSubtitle.en;
            document.getElementById('onb-item1-title').innerText = isFrCarnet ? t.onbItem1Title.fr : t.onbItem1Title.en;
            document.getElementById('onb-item1-desc').innerText = isFrCarnet ? t.onbItem1Desc.fr : t.onbItem1Desc.en;
            document.getElementById('onb-item2-title').innerText = isFrCarnet ? t.onbItem2Title.fr : t.onbItem2Title.en;
            document.getElementById('onb-item2-desc').innerText = isFrCarnet ? t.onbItem2Desc.fr : t.onbItem2Desc.en;
            document.getElementById('onb-item3-title').innerText = isFrCarnet ? t.onbItem3Title.fr : t.onbItem3Title.en;
            document.getElementById('onb-item3-desc').innerText = isFrCarnet ? t.onbItem3Desc.fr : t.onbItem3Desc.en;
            document.getElementById('onb-item4-title').innerText = isFrCarnet ? t.onbItem4Title.fr : t.onbItem4Title.en;
            document.getElementById('onb-item4-desc').innerText = isFrCarnet ? t.onbItem4Desc.fr : t.onbItem4Desc.en;
            document.getElementById('onb-item5-title').innerText = isFrCarnet ? t.onbItem5Title.fr : t.onbItem5Title.en;
            document.getElementById('onb-item5-desc').innerText = isFrCarnet ? t.onbItem5Desc.fr : t.onbItem5Desc.en;
            document.getElementById('onb-btn').innerText = isFrCarnet ? t.onbBtn.fr : t.onbBtn.en;
            // Met à jour les modales de galerie, QR, autodestruction et suppression
            document.getElementById('google-title').innerHTML = '<i class="fa-brands fa-wikipedia-w"></i> ' + (isFrCarnet ? t.googleTitle.fr : t.googleTitle.en);
            document.getElementById('qr-title').innerText = isFrCarnet ? t.qrTitle.fr : t.qrTitle.en;
            document.getElementById('qr-text').innerText = isFrCarnet ? t.qrText.fr : t.qrText.en;
            document.getElementById('nuke-title').innerText = isFrCarnet ? t.nukeTitle.fr : t.nukeTitle.en;
            document.getElementById('nuke-text').innerText = isFrCarnet ? t.nukeText.fr : t.nukeText.en;
            document.getElementById('nuke-no').innerText = isFrCarnet ? t.nukeNo.fr : t.nukeNo.en;
            document.getElementById('nuke-yes').innerText = isFrCarnet ? t.nukeYes.fr : t.nukeYes.en;
            document.getElementById('del-title').innerText = isFrCarnet ? t.delTitle.fr : t.delTitle.en;
            document.getElementById('del-text').innerText = isFrCarnet ? t.delText.fr : t.delText.en;
            document.getElementById('del-no').innerText = isFrCarnet ? t.delNo.fr : t.delNo.en;
            document.getElementById('confirmDeleteBtn').innerText = isFrCarnet ? t.delYes.fr : t.delYes.en;
            document.getElementById('vs-title').innerText = isFrCarnet ? t.vsTitle.fr : t.vsTitle.en;
            // Réaffiche les cartes avec la nouvelle langue
            render();
        }
        
        // Expose la fonction globalement pour qu'elle soit accessible depuis le HTML
        window.switchLangCarnet = switchLangCarnet;
    </script>

<!-- Fin du fichier HTML -->
</body>
</html>

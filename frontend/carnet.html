<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Escapade |
Tableau de Bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="red-alert" id="redAlert"></div>
    <div id="countdown-screen"></div>
    <nav class="navbar">
        <a href="map.html" class="navbar-brand">
            <span class="logo-icon">🌿</span>
            <span class="brand-text">Eco-Escapade</span>
        </a>
        <div class="navbar-links">
            <a href="map.html" class="nav-link">
                <i class="fa-solid fa-map"></i> <span id="nav-carte">Carte</span>
            </a>
            <a href="apropos.html" class="nav-link">
                <i class="fa-solid fa-circle-info"></i> <span id="nav-about">À propos</span>
            </a>
            <a href="#" class="nav-link" onclick="openOnboarding(); return false;">
                <i class="fa-solid fa-circle-question"></i> <span id="nav-aide">Aide</span>
            </a>
            <button class="lang-switch" onclick="switchLangCarnet()"><i class="fa-solid fa-globe"></i> FR / EN</button>
        </div>
    </nav>
    <div class="container">
        <div class="top-section">
            <div class="titles"><h2 id="main-title" style="font-size: 
2.5rem; margin: 0;">Tableau de Bord</h2><p id="main-subtitle" style="color:#94a3b8; margin-top: 5px;">Gérez vos futures aventures bas carbone.</p></div>
            <div class="heatmap-container"><div id="miniMap"></div></div>
        </div>
        <div id="grid" class="card-grid"></div>
        <div id="empty" style="text-align: center;
color: #64748b; margin-top: 100px; display: none;"><i class="fa-solid fa-ghost" style="font-size: 3rem; margin-bottom: 20px;"></i><p id="empty-text">Aucune donnée.</p><a href="map.html" id="btn-scan" class="btn-main" style="width:200px;
margin: 20px auto;">Scanner la carte</a></div>
        <div class="danger-zone"><button id="btn-nuke" class="btn-nuke" onclick="openNukeModal()">💥 SÉQUENCE D'AUTODESTRUCTION</button></div>
    </div>
    <button id="vs-btn" onclick="openVsModal()"><i class="fa-solid fa-gavel"></i> <span id="btn-compare">COMPARER</span></button>
    <div id="toast" class="toast"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i><span id="toast-msg">Message</span></div>
    <div id="onboardingModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="onb-title" style="color:var(--primary); font-size:1.8rem; margin-bottom:20px;">Bienvenue dans votre carnet de voyage !</h3>
            <div id="onb-text" style="text-align:left; line-height:1.8; color:#cbd5e1; display: flex; flex-direction: column; gap: 15px;">
                <div style="display: flex; gap: 12px;">
                    <i class="fa-solid fa-gavel" style="color: var(--primary); font-size: 1.3rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <span><strong style="color: white;">Comparez 2 gares</strong> — Sélectionnez deux favoris pour voir leurs scores côte à côte</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <i class="fa-brands fa-wikipedia-w" style="color: #3b82f6; font-size: 1.3rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <span><strong style="color: white;">Explorez les villes</strong> — Accédez aux images Wikipedia pour découvrir chaque destination</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <i class="fa-solid fa-qrcode" style="color: #f59e0b; font-size: 1.3rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <span><strong style="color: white;">Générez un QR Code</strong> — Partagez facilement vos gares préférées via code scannable</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <i class="fa-solid fa-map-location-dot" style="color: #10b981; font-size: 1.3rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <span><strong style="color: white;">Visualisez la carte</strong> — Voyez tous vos favoris en temps réel sur la mini-carte heatmap</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <i class="fa-solid fa-trash-alt" style="color: #ef4444; font-size: 1.3rem; flex-shrink: 0; margin-top: 2px;"></i>
                    <span><strong style="color: white;">Gérez vos favoris</strong> — Supprimez individuellement ou lancez une séquence d'autodestruction complète</span>
                </div>
            </div>
            <button id="onb-btn" class="btn-main" onclick="closeAll()" style="margin-top:30px; width: 100%;">Commencer l'exploration !</button>
        </div>
    </div>
    <div id="googlePhotosModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="google-title" id="google-title" style="margin-bottom:20px;
font-size:1.5rem; color:white;"><i class="fa-brands fa-wikipedia-w"></i> Images de la ville</h3>
            <p id="googleQuery" style="color:#94a3b8;
margin-bottom:15px; font-style:italic;"></p>
            <div class="google-grid" id="googleGrid"><div style="color:#94a3b8;
padding:20px;">Chargement des images...</div></div>
        </div>
    </div>
    <div id="qrModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="qr-title">Partager</h3>
            <div id="qrcode" style="margin: 20px auto;
width: 128px; background:white; padding:10px;"></div>
            <p id="qr-text" style="font-size:0.9rem;
color:#94a3b8;">Scannez pour ouvrir Google Maps</p>
        </div>
    </div>
    <div id="nukeModal" class="modal-overlay">
        <div class="modal-box" style="border: 2px solid #ef4444;
box-shadow: 0 0 50px rgba(239,68,68,0.3);">
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem;
color: #ef4444; margin-bottom: 20px;"></i>
            <h3 id="nuke-title" style="color: #ef4444;
font-size: 1.5rem;">ATTENTION</h3>
            <p id="nuke-text">Voulez-vous vraiment détruire tout le carnet ?</p>
            <div style="display: flex;
gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="nuke-no" onclick="closeAll()" style="padding: 10px 20px;
background: #334155; border:none; color:white; border-radius:8px; cursor:pointer;">Non</button>
                <button id="nuke-yes" onclick="startSelfDestruct()" style="padding: 10px 20px;
background: #ef4444; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">OUI, DETRUIRE</button>
            </div>
        </div>
    </div>
    <div id="deleteSingleModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="del-title" style="margin-bottom:15px;">Supprimer ce favori ?</h3>
            <p id="del-text" style="color:#94a3b8;
margin-bottom:20px;">Cette action est irr�versible.</p>
            <div style="display: flex; gap: 10px;
justify-content: center;">
                <button id="del-no" onclick="closeAll()" style="padding: 10px 20px;
background: #334155; border:none; color:white; border-radius:8px; cursor:pointer;">Annuler</button>
                <button id="confirmDeleteBtn" style="padding: 10px 20px;
background: #ef4444; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">Supprimer</button>
            </div>
        </div>
    </div>
    <div id="vsModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px;
background: linear-gradient(145deg, #1e293b, #0f172a);">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h2 id="vs-title" style="color:#f59e0b;
font-style:italic; font-size:2rem; margin-bottom:10px;">COMPARATEUR</h2>
            <div id="vsContent"></div>
        </div>
    </div>

    <script>
        const escapeHTML = (str) => str ? str.replace(/[&<>'"]/g, tag => ({ '&': '&', '<': '<', '>': '>', "'": "'", '"': '"' }[tag])) : '';

        // MODIFIÉ : Variable langue déplacée en haut pour être accessible dans render()
        let isFrCarnet = true;
        
        // Placeholder for DASHBOARD_TEXTS - will be imported by module script
        let DASHBOARD_TEXTS = {};

        let favoris = JSON.parse(localStorage.getItem('eco_favoris')) || [];
        favoris = favoris.map(f => {
            if(f.score 
=== undefined) { 
                f.score = Math.floor(Math.random() * 50 + 50) / 10; 
                f.details = { velos: Math.floor(Math.random()*20), bornes: Math.floor(Math.random()*10), covoit: Math.floor(Math.random()*5) };
            }
            return f;
        });

        const grid = document.getElementById('grid');
   
     const empty = document.getElementById('empty');
        let selectedVs = []; 
        let itemToDeleteIndex = null;

        function render() {
            if (favoris.length === 0) { empty.style.display = 'block'; grid.innerHTML = '';
return; }
            favoris.sort((a,b) => (b.score||0) - (a.score||0));
grid.innerHTML = '';
            favoris.forEach((fav, index) => {
                const score = fav.score !== undefined ? fav.score : '?';
                const details = fav.details || { velos: 0, bornes: 0, covoit: 0 };
                let color = '#ef4444'; if(score >= 5) color = '#f59e0b'; if(score >= 8) color = '#10b981';
          
       const deg = (score !== '?' ? score : 0) * 36;
                const gradient = `conic-gradient(${color} ${deg}deg, #334155 0deg)`;
                const safeName = escapeHTML(fav.nom);

                const div = document.createElement('div');
                div.className = 'card';
     
           div.innerHTML = `
                    <input type="checkbox" id="chk-${index}" class="vs-checkbox-input" onchange="toggleVs(${index}, this)">
                    <label for="chk-${index}" class="vs-label"><i class="fa-solid fa-check"></i></label>
                    <div class="card-top"><div><span class="badge ${fav.type}">${fav.type}</span><h3>${safeName}</h3></div></div>
               
     <div class="score-row">
                        <div class="circle-wrap" style="background: ${gradient}"><div class="circle-inner">${score}</div></div>
                        <div class="stats-list">
                            <div class="stat-item"><i class="fa-solid fa-bicycle" style="color:#06b6d4;
width:20px;"></i> ${details.velos} ${isFrCarnet ? 'Vélos' : 'Bikes'}</div>
                            <div class="stat-item"><i class="fa-solid fa-plug" style="color:#f59e0b;
width:20px;"></i> ${details.bornes} ${isFrCarnet ? 'Bornes' : 'Terminals'}</div>
                            <div class="stat-item"><i class="fa-solid fa-car" style="color:#a855f7;
width:20px;"></i> ${details.covoit} ${isFrCarnet ? 'Covoit' : 'Carpool'}</div>
                        </div>
                    </div>
                    <a href="map.html?target=${fav.id}" class="btn-main"><i class="fa-solid fa-location-arrow"></i> <span class="txt-go">Y aller</span></a>
                    <div class="tools-grid">
      
                   <button class="tool-btn google" title="${isFrCarnet?'Photos':'Photos'}" onclick="openGooglePhotos('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-image"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'Google Maps':'Google Maps'}" onclick="openGoogleMaps('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-map-location-dot"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'QR Code':'QR Code'}" onclick="openQr('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-qrcode"></i></button>
             
           <button class="tool-btn del" title="${isFrCarnet?'Supprimer':'Delete'}" onclick="askDelete(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
grid.appendChild(div);
            });
        }
        render();
if(favoris.length > 0) {
            setTimeout(() => {
                const miniMap = L.map('miniMap', { zoomControl:false, attributionControl:false }).setView([46.5, 2.5], 4);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(miniMap);
                favoris.forEach(f => {
                    const lat = 46 
+ (Math.random()-0.5)*5; 
                    const lon = 2 + (Math.random()-0.5)*5;
                    L.circleMarker([lat, lon], { radius:4, color:'#ef4444', fillOpacity:1, stroke:false }).addTo(miniMap);
                });
            }, 500);
}

        function showToast(msg) {
            const t = document.getElementById('toast');
document.getElementById('toast-msg').innerText = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }
        function closeAll() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}
        function openModal(id) { document.getElementById(id).classList.add('active');
}

        async function openGooglePhotos(nom) {
            let cleanCity = nom.split(' - ')[0].replace(/Gare de\s?/gi, '').replace(/TGV/gi, '').replace(/Centre/gi, '').trim();
document.getElementById('googleQuery').innerText = `${isFrCarnet ? 'Recherche pour :' : 'Search for:'} "${cleanCity}"`;
            openModal('googlePhotosModal');
            const grid = document.getElementById('googleGrid');
            // MODIFIɉ : Utilisation de DASHBOARD_TEXTS
            grid.innerHTML = `<div style="color:#94a3b8; padding:20px;">${isFrCarnet ? DASHBOARD_TEXTS.imgLoad.fr : DASHBOARD_TEXTS.imgLoad.en}</div>`;
try {
                const url = `https://fr.wikipedia.org/w/api.php?action=query&titles=${cleanCity}&prop=pageimages&format=json&pithumbsize=600&origin=*`;
const r = await fetch(url);
                const d = await r.json();
                const pages = d.query.pages;
                const pid = Object.keys(pages)[0];
if (pid !== "-1" && pages[pid].thumbnail) {
                    const imgSrc = pages[pid].thumbnail.source;
grid.innerHTML = `<img src="${imgSrc}" class="google-pic">`;
                } else {
                    grid.innerHTML = `<div style="color:#ef4444; padding:20px;">${isFrCarnet ? DASHBOARD_TEXTS.imgError.fr : DASHBOARD_TEXTS.imgError.en}</div>`;
}
            } catch(e) {
                grid.innerHTML = `<div style="color:#ef4444; padding:20px;">${isFrCarnet ? DASHBOARD_TEXTS.conError.fr : DASHBOARD_TEXTS.conError.en}</div>`;
}
        }

        // FIX: Removed extra "$" before template interpolation which produced malformed URLs
        window.openGoogleMaps = (nom) => { window.open(`https://www.google.com/maps/search/?api=1&query=Gare+${encodeURIComponent(nom.replace(/Gare de\s?/gi, ''))}`);
    };
        window.openQr = (nom) => {
            const container = document.getElementById('qrcode');
container.innerHTML = '';
            // FIX: QR Code URL must not contain stray "$" before interpolation
            new QRCode(container, { text: `https://www.google.com/maps/search/?api=1&query=Gare+${encodeURIComponent(nom)}`, width: 128, height: 128 });
            openModal('qrModal');
        };
window.askDelete = (index) => { itemToDeleteIndex = index; openModal('deleteSingleModal'); };
document.getElementById('confirmDeleteBtn').onclick = () => {
            if(itemToDeleteIndex !== null) {
                favoris.splice(itemToDeleteIndex, 1);
localStorage.setItem('eco_favoris', JSON.stringify(favoris));
                // MODIFIɉ : Toast traduit
                render(); closeAll(); showToast(isFrCarnet ? DASHBOARD_TEXTS.toastDel.fr : DASHBOARD_TEXTS.toastDel.en);
            }
        };
window.toggleVs = (index, checkbox) => {
            if (checkbox.checked) {
                if (selectedVs.length >= 2) { checkbox.checked = false;
// MODIFIɉ : Toast traduit
showToast(isFrCarnet ? DASHBOARD_TEXTS.toastMax.fr : DASHBOARD_TEXTS.toastMax.en); return; }
                selectedVs.push(index);
} else {
                selectedVs = selectedVs.filter(i => i !== index);
}
            const btn = document.getElementById('vs-btn');
if (selectedVs.length === 2) btn.classList.add('visible');
            else btn.classList.remove('visible');
        };

        window.openVsModal = () => {
            const f1 = favoris[selectedVs[0]];
const f2 = favoris[selectedVs[1]];
            const winner = (v1, v2) => v1 > v2 ?
'val-win' : (v1 < v2 ? 'val-lose' : '');
            
            // MODIFIɉ : Labels dynamiques pour la modale VS
            const lblScore = isFrCarnet ? "SCORE GLOBAL" : "GLOBAL SCORE";
            const lblVelos = isFrCarnet ? "V�LOS" : "BIKES";
            const lblBornes = isFrCarnet ? "BORNES" : "TERMINALS";
            const lblCovoit = isFrCarnet ? "COVOIT'" : "CARPOOL";

            document.getElementById('vsContent').innerHTML = `
                <table class="vs-table">
                    <thead><tr><th style="width:40%; font-size:1.1rem; color:white;">${escapeHTML(f1.nom)}</th><th style="width:20%;">VS</th><th style="width:40%; font-size:1.1rem; color:white;">${escapeHTML(f2.nom)}</th></tr></thead>
                    <tbody>
                        <tr><td 
class="${winner(f1.score, f2.score)}" style="font-size:1.5rem;">${f1.score}</td><td style="color:#94a3b8; font-size:0.8rem;">${lblScore}</td><td class="${winner(f2.score, f1.score)}" style="font-size:1.5rem;">${f2.score}</td></tr>
                        <tr><td class="${winner(f1.details.velos, f2.details.velos)}">${f1.details.velos}</td><td style="color:#94a3b8; font-size:0.8rem;">${lblVelos}</td><td class="${winner(f2.details.velos, f1.details.velos)}">${f2.details.velos}</td></tr>
                        <tr><td class="${winner(f1.details.bornes, f2.details.bornes)}">${f1.details.bornes}</td><td style="color:#94a3b8;
font-size:0.8rem;">${lblBornes}</td><td class="${winner(f2.details.bornes, f1.details.bornes)}">${f2.details.bornes}</td></tr>
                        <tr><td class="${winner(f1.details.covoit, f2.details.covoit)}">${f1.details.covoit}</td><td style="color:#94a3b8;
font-size:0.8rem;">${lblCovoit}</td><td class="${winner(f2.details.covoit, f1.details.covoit)}">${f2.details.covoit}</td></tr>
                    </tbody>
                </table>
            `;
            openModal('vsModal');
        };

        window.openNukeModal = () => document.getElementById('nukeModal').classList.add('active');
        window.startSelfDestruct = () => {
      
      closeAll();
            document.body.classList.add('shaking'); document.getElementById('redAlert').classList.add('active'); 
            const screen = document.getElementById('countdown-screen');
            screen.style.display = 'flex';
            let count = 5; screen.innerHTML = count;
            const timer = setInterval(() => {
                
count--; screen.innerHTML = count;
                // MODIFIɉ : Traduction PURGE COMPLETE
                if(count <= 0) { clearInterval(timer); screen.innerHTML = isFrCarnet ? "PURGE TERMIN�E" : "PURGE COMPLETE"; localStorage.removeItem('eco_favoris'); setTimeout(() => location.reload(), 2000); } // FIX: Changed French text for better localization.
            }, 1000);
        };
window.openOnboarding = () => document.getElementById('onboardingModal').classList.add('active');
        if(!localStorage.getItem('visited_carnet_final')) { setTimeout(openOnboarding, 1000); localStorage.setItem('visited_carnet_final', 'true');
}
    </script>
    
    <script type="module">
        import { DASHBOARD_TEXTS as DT } from './js/textes.js';
        
        // Make DASHBOARD_TEXTS available globally for the non-module script
        window.DASHBOARD_TEXTS = DT;

        function switchLangCarnet() {
            isFrCarnet = !isFrCarnet;
            const t = window.DASHBOARD_TEXTS;
            document.getElementById('nav-carte').innerText = isFrCarnet ? t.navCarte.fr : t.navCarte.en;
            document.getElementById('nav-aide').innerText = isFrCarnet ? t.navAide.fr : t.navAide.en;
            document.getElementById('main-title').innerText = isFrCarnet ? t.mainTitle.fr : t.mainTitle.en;
            document.getElementById('main-subtitle').innerText = isFrCarnet ? t.mainSub.fr : t.mainSub.en;
            document.getElementById('empty-text').innerText = isFrCarnet ? t.emptyText.fr : t.emptyText.en;
            document.getElementById('btn-scan').innerText = isFrCarnet ? t.btnScan.fr : t.btnScan.en;
            document.getElementById('btn-nuke').innerText = isFrCarnet ? t.btnNuke.fr : t.btnNuke.en;
            document.getElementById('btn-compare').innerText = isFrCarnet ? t.btnCompare.fr : t.btnCompare.en;
            document.getElementById('onb-title').innerText = isFrCarnet ? t.onbTitle.fr : t.onbTitle.en;
            document.getElementById('onb-text').innerText = isFrCarnet ? t.onbText.fr : t.onbText.en;
            document.getElementById('onb-btn').innerText = isFrCarnet ? t.onbBtn.fr : t.onbBtn.en;
            document.getElementById('google-title').innerHTML = '<i class="fa-brands fa-wikipedia-w"></i> ' + (isFrCarnet ? t.googleTitle.fr : t.googleTitle.en);
            document.getElementById('qr-title').innerText = isFrCarnet ? t.qrTitle.fr : t.qrTitle.en;
            document.getElementById('qr-text').innerText = isFrCarnet ? t.qrText.fr : t.qrText.en;
            document.getElementById('nuke-title').innerText = isFrCarnet ? t.nukeTitle.fr : t.nukeTitle.en;
            document.getElementById('nuke-text').innerText = isFrCarnet ? t.nukeText.fr : t.nukeText.en;
            document.getElementById('nuke-no').innerText = isFrCarnet ? t.nukeNo.fr : t.nukeNo.en;
            document.getElementById('nuke-yes').innerText = isFrCarnet ? t.nukeYes.fr : t.nukeYes.en;
            document.getElementById('del-title').innerText = isFrCarnet ? t.delTitle.fr : t.delTitle.en;
            document.getElementById('del-text').innerText = isFrCarnet ? t.delText.fr : t.delText.en;
            document.getElementById('del-no').innerText = isFrCarnet ? t.delNo.fr : t.delNo.en;
            document.getElementById('confirmDeleteBtn').innerText = isFrCarnet ? t.delYes.fr : t.delYes.en;
            document.getElementById('vs-title').innerText = isFrCarnet ? t.vsTitle.fr : t.vsTitle.en;
            // Re-render cards with new language
            render();
        }
        
        window.switchLangCarnet = switchLangCarnet;
    </script>








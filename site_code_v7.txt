--- backend\server.js ---

// ============================================================
// NOM FICHIER : backend/server.js
// FUSION COMPLÉˆTE : API vÉ©lo prioritaire + Cache + Air & Bio
// DATE : 06/01/2026
// ============================================================

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const axios = require('axios');
const fs = require('fs');
const path = require('path');
const NodeCache = require('node-cache');

const app = express();
const port = process.env.PORT || 3000;

// Cache API (TTL 1 heure)
const apiCache = new NodeCache({ stdTTL: 3600 });

app.use(cors());
app.use(express.json());

// --- CHARGEMENT FICHIER VÉ‰LO LOCAL (FALLBACK) ---
let veloDataCache = { type: "FeatureCollection", features: [] };
try {
    const filePath = path.join(__dirname, 'velo.geojson');
    if (fs.existsSync(filePath)) {
        veloDataCache = JSON.parse(fs.readFileSync(filePath, 'utf8'));
        console.log(`ðŸš² Fichier vÉ©lo de secours chargÉ© : ${veloDataCache.features.length} points`);
    }
} catch (e) { 
    console.warn("âš ï¸ Fichier velo.geojson introuvable");
}

// --- ROUTES API ---

// 1. GARES SNCF
app.get('/api/gares', async (req, res) => {
    try {
        const r = await axios.get(
            'https://ressources.data.sncf.com/api/explore/v2.1/catalog/datasets/gares-de-voyageurs/exports/json'
        );
        if (!Array.isArray(r.data)) throw new Error('Format API invalide');

        const d = r.data
            .map((g, i) => ({
                id: i,
                nom: g.nom || 'Gare Inconnue',
                lat: g.position_geographique?.lat,
                lon: g.position_geographique?.lon,
                type: g.nom && g.nom.includes('TGV') ? 'TGV' : 'TER'
            }))
            .filter((g) => g.lat && g.lon);

        res.json(d);
    } catch (e) {
        console.error('âŒ Erreur API Gares:', e.message);
        res.json([]);
    }
});

// 2. RAILS (WFS)
app.get('/api/wfs-rails', async (req, res) => {
    try {
        const r = await axios.get(
            'https://ressources.data.sncf.com/explore/dataset/formes-des-lignes-du-rfn/download/?format=geojson&timezone=Europe/Berlin&lang=fr'
        );
        res.json(r.data);
    } catch (e) {
        console.error('âŒ Erreur API Rails:', e.message);
        res.json({ type: 'FeatureCollection', features: [] });
    }
});

// 3. BORNES É‰LECTRIQUES (IRVE)
app.get('/api/irve', async (req, res) => {
    try {
        const r = await axios.get(
            'https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/osm-france-charging-station/exports/geojson?limit=15000'
        );
        res.json(r.data);
    } catch (e) {
        console.error('âŒ Erreur API IRVE:', e.message);
        res.json({ type: 'FeatureCollection', features: [] });
    }
});

// 4. AIRES DE COVOITURAGE
app.get('/api/covoiturage', async (req, res) => {
    try {
        const r = await axios.get(
            'https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/aires-covoiturage/exports/geojson?limit=5000'
        );
        res.json(r.data);
    } catch (e) {
        console.error('âŒ Erreur API Covoiturage:', e.message);
        res.json({ type: 'FeatureCollection', features: [] });
    }
});

// 5. PARKINGS VÉ‰LOS (API prioritaire, fichier local en fallback)
app.get('/api/parking-velo', async (req, res) => {
    const { minLat, maxLat, minLon, maxLon } = req.query;

    if (!minLat || !maxLat || !minLon || !maxLon) {
        return res.json({ type: 'FeatureCollection', features: [] });
    }

    // PRIORITÉ‰ 1 : Tenter l'API Opendatasoft
    try {
        const url = 'https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/osm-france-bicycle-parking/exports/geojson?limit=-1';
        
        console.log('ðŸ”„ Tentative rÉ©cupÉ©ration API vÉ©los...');
        const r = await axios.get(url, { timeout: 8000 }); // Timeout 8s
        const data = r.data;

        const all = Array.isArray(data.features) ? data.features : [];

        const resList = all.filter((f) => {
            if (!f.geometry || !f.geometry.coordinates) return false;
            const c = f.geometry.coordinates;
            return (
                c[1] >= parseFloat(minLat) &&
                c[1] <= parseFloat(maxLat) &&
                c[0] >= parseFloat(minLon) &&
                c[0] <= parseFloat(maxLon)
            );
        });

        const final = resList.length > 5000
            ? resList.filter((_, i) => i % Math.ceil(resList.length / 5000) === 0)
            : resList;

        console.log(`âœ… API vÉ©los OK : ${final.length} points renvoyÉ©s`);
        return res.json({ type: 'FeatureCollection', features: final });

    } catch (apiError) {
        console.warn('âš ï¸ API vÉ©los É©chouÉ©e, basculement sur fichier local...');
        
        // PRIORITÉ‰ 2 : Utiliser le fichier local
        if (veloDataCache.features.length > 0) {
            const resList = veloDataCache.features.filter(f => {
                if (!f.geometry || !f.geometry.coordinates) return false;
                const c = f.geometry.coordinates;
                return (
                    c[1] >= parseFloat(minLat) &&
                    c[1] <= parseFloat(maxLat) &&
                    c[0] >= parseFloat(minLon) &&
                    c[0] <= parseFloat(maxLon)
                );
            });

            const final = resList.length > 5000
                ? resList.filter((_, i) => i % Math.ceil(resList.length / 5000) === 0)
                : resList;

            console.log(`ðŸ—‚ï¸ Fichier local utilisÉ© : ${final.length} points`);
            return res.json({ type: 'FeatureCollection', features: final });
        }

        // Aucune source disponible
        console.error('âŒ Aucune source vÉ©lo disponible');
        res.json({ type: 'FeatureCollection', features: [] });
    }
});

// 6. QUALITÉ‰ DE L'AIR (OpenAQ)
app.get('/api/air-quality', async (req, res) => {
    const { lat, lon } = req.query;
    
    if (!lat || !lon) {
        return res.json({ success: false, error: 'Missing lat/lon' });
    }
    
    const cacheKey = `air_${lat}_${lon}`;
    const cached = apiCache.get(cacheKey);
    if (cached) {
        console.log('ðŸ“¦ Cache air-quality utilisÉ©');
        return res.json(cached);
    }
    
    try {
        const radius = 10000; // 10km
        const response = await axios.get(
            `https://api.openaq.org/v3/locations?coordinates=${lat},${lon}&radius=${radius}&limit=1`,
            {
                headers: {
                    'X-API-Key': process.env.OPENAQ_API_KEY
                }
            }
        );
        
        const data = response.data;
        
        if (data.results && data.results.length > 0) {
            const station = data.results[0];
            const pm25 = station.parameters?.find(p => p.parameter === 'pm25');
            
            let quality = 'Inconnue';
            let value = pm25?.lastValue || null;
            
            if (value !== null) {
                if (value < 10) quality = 'Excellent';
                else if (value < 20) quality = 'Bon';
                else if (value < 25) quality = 'Moyen';
                else if (value < 50) quality = 'MÉ©diocre';
                else quality = 'Mauvais';
            }
            
            const result = {
                success: true,
                data: {
                    value: value,
                    unit: 'Âµg/mÂ³',
                    quality: quality,
                    color: value < 10 ? '#10b981' : value < 25 ? '#f59e0b' : '#ef4444',
                    station: station.name
                }
            };
            
            apiCache.set(cacheKey, result, 3600);
            console.log(`âœ… Air quality rÉ©cupÉ©rÉ©e : ${quality}`);
            res.json(result);
        } else {
            res.json({ success: false, error: 'No data' });
        }
        
    } catch (error) {
        console.error('âŒ OpenAQ error:', error.message);
        res.json({ success: false, error: error.message });
    }
});

// 7. BIODIVERSITÉ‰ (iNaturalist)
app.get('/api/biodiversity', async (req, res) => {
    const { lat, lon, radius = 5 } = req.query;
    
    if (!lat || !lon) {
        return res.json({ success: false, error: 'Missing lat/lon' });
    }
    
    const cacheKey = `bio_${lat}_${lon}_${radius}`;
    const cached = apiCache.get(cacheKey);
    if (cached) {
        console.log('ðŸ“¦ Cache biodiversity utilisÉ©');
        return res.json(cached);
    }
    
    try {
        const response = await axios.get(
            `https://api.inaturalist.org/v1/observations?` +
            `lat=${lat}&lng=${lon}&radius=${radius}&` +
            `verifiable=true&quality_grade=research&per_page=10&order=desc&order_by=created_at`
        );
        
        const observations = response.data.results;
        
        const species = observations.map(obs => ({
            name: obs.taxon.preferred_common_name || obs.taxon.name,
            scientificName: obs.taxon.name,
            photo: obs.taxon.default_photo?.medium_url || null,
            category: obs.taxon.iconic_taxon_name,
            rarity: obs.taxon.threatened ? 'ðŸ”´ MenacÉ©e' : 'ðŸŸ¢ Commune'
        }));
        
        const result = {
            success: true,
            data: {
                count: species.length,
                species: species.slice(0, 5)
            }
        };
        
        apiCache.set(cacheKey, result, 86400); // Cache 24h
        console.log(`âœ… BiodiversitÉ© rÉ©cupÉ©rÉ©e : ${species.length} espÉ¨ces`);
        res.json(result);
        
    } catch (error) {
        console.error('âŒ iNaturalist error:', error.message);
        res.json({ success: false, error: error.message });
    }
});

// --- SERVIR LE FRONTEND ---
app.use(express.static(path.join(__dirname, '../frontend')));

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, '../frontend/index.html'));
});

// --- DÉ‰MARRAGE DU SERVEUR ---
app.listen(port, () => {
    console.log(`ðŸš€ Serveur dÉ©marrÉ© sur le port ${port}`);
    console.log(`ðŸ“ Frontend : http://localhost:${port}`);
});

// ============================================================
// FIN DU FICHIER
// ============================================================











--- frontend\app.js ---

// ============================================================
// 0. STYLE & CONFIGURATION
// ============================================================

// URL de l'API (Localhost ou Prod)
const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    ? 'http://localhost:3000'
    : '';

// ============================================================
// 1. INITIALISATION CARTE
// ============================================================
console.log("🚀 Initialisation Eco-Escapade - FIX ZONE piétonne");

const map = L.map('map', {
    zoomControl: false,
    minZoom: 4,
    maxZoom: 19
}).setView([46.6, 2.2], 5);

// Layer Satellite/Hybrid pour le look sombre
const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
    maxZoom: 20
});
map.addLayer(googleSat);

// FIX: Initialisation globale des données et des couches manquantes
// SAFETY: définitions minimales pour éviter les ReferenceError au démarrage
const DATA = {
    gares: [],
    velos: [],
    bornes: [],
    covoit: []
};

const createCluster = (cls) => L.markerClusterGroup({
    showCoverageOnHover: false,
    iconCreateFunction: (c) => L.divIcon({
        html: `<span>${c.getChildCount()}</span>`,
        className: `custom-cluster ${cls}`,
        iconSize: [40, 40]
    })
});

const markersLayer = createCluster('cluster-gare');
const irveLayer = createCluster('cluster-irve');
const covoitLayer = createCluster('cluster-covoit');
const veloParkingLayer = createCluster('cluster-velo');

const railsLayer = L.geoJSON(null, {
    style: {
        color: '#6b7280',
        weight: 2,
        opacity: 0.6
    }
});

// FIX: Initialiser variables globales pour la gestion de la zone piétonne
let walkCircle = null;

const counterDiv = L.DomUtil.create('div', 'visible-counter');
counterDiv.innerHTML = `<i class="fa-solid fa-eye"></i> <span id="count-val">0</span> gares`;
document.body.appendChild(counterDiv);

const toastDiv = document.createElement('div');
toastDiv.id = 'map-toast';
toastDiv.className = 'map-toast';
toastDiv.innerHTML = `<i class="fa-solid fa-person-walking" style="font-size:1.2rem;"></i> <span id="toast-text">Message</span>`;
document.body.appendChild(toastDiv);

// Fonction debounce pour performance
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Helper pour afficher les toasts d'erreur ou d'info
function showToast(msg, isError = false) {
    const t = document.getElementById('map-toast');
    if (t) {
        document.getElementById('toast-text').innerHTML = msg;
        if (isError) t.style.borderColor = '#ef4444';
        else t.style.borderColor = '#334155';
        t.classList.add('active');
        setTimeout(() => t.classList.remove('active'), 4000);
    }
}

// Fonction de calcul de distance (formule Haversine) - retourne la distance en km
function getDist(lat1, lon1, lat2, lon2) {
    const R = 6371; // Rayon de la Terre en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

// Fonction pour mettre à jour le compteur de gares visibles
function updateCount() {
    const countEl = document.getElementById('count-val');
    if (countEl) {
        const visibleCount = markersLayer.getLayers().length;
        countEl.textContent = visibleCount;
    }
}

// Gestion des favoris avec localStorage
function getFavoris() {
    try {
        return JSON.parse(localStorage.getItem('eco-favoris') || '[]');
    } catch (e) {
        return [];
    }
}

function isFavori(id) {
    return getFavoris().some(f => f.id === id);
}

function toggleFavori(id, nom, type) {
    let favoris = getFavoris();
    const index = favoris.findIndex(f => f.id === id);
    const icon = document.getElementById(`fav-${id}`);
    
    if (index >= 0) {
        favoris.splice(index, 1);
        if (icon) {
            icon.classList.remove('fav-active');
            icon.classList.add('fav-inactive');
        }
        showToast(`${nom} retiré des favoris`);
    } else {
        favoris.push({ id, nom, type, date: new Date().toISOString() });
        if (icon) {
            icon.classList.remove('fav-inactive');
            icon.classList.add('fav-active');
        }
        showToast(`${nom} ajouté aux favoris ❤️`);
    }
    
    localStorage.setItem('eco-favoris', JSON.stringify(favoris));
}

let osmb = null;

// AVIS INTELLIGENTS
const AVIS_BAD = ["Peu d'équipements.", "Gare isolée.", "Manque de connexions.", "À fuir."];
const AVIS_MID = ["Gare correcte.", "Quelques équipements.", "Bon pour un départ.", "Pratique mais basique."];
const AVIS_GOOD = ["Excellente gare !", "Top pour le vélo.", "Super connectée.", "Voyage vert idéal.", "Bien desservie."];

const MAJOR_CITIES = [
    "Paris", "Marseille", "Lyon", "Toulouse", "Nice", "Nantes", "Montpellier",
    "Strasbourg", "Bordeaux", "Lille", "Rennes", "Reims", "Saint-Étienne",
    "Toulon", "Le Havre", "Grenoble", "Dijon", "Angers", "Nîmes", "Villeurbanne",
    "Saint-Denis", "Aix-en-Provence", "Clermont-Ferrand", "Le Mans", "Brest",
    "Tours", "Amiens", "Limoges", "Annecy", "Perpignan", "Metz", "Besançon"
];

const FALLBACK_IMAGES = [
    "https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=500&q=80",
    "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=500&q=80",
    "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=500&q=80",
    "https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?w=500&q=80",
    "https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=500&q=80"
];

// CORRIGÉ BUG URGENT 2 : Liste complète des messages de chargement
const LOADING_PHRASES = [
    "Gonflage des pneus...",
    "Alignement des rails...",
    "Calcul du bilan carbone...",
    "Démarrage machine...",
    "Plantation d'arbres...",
    "Recherche de bornes...",
    "Connexion satellite...",
    "Vérification météo...",
    "Chargement des cartes...",
    "Compostage des octets...",
    "Réchauffement du serveur (mais pas de la planète)...",
    "Arrosage automatique des données...",
    "Dressage des ours polaires virtuels...",
    "Polissage des panneaux solaires...",
    "Tri sélectif des paquets réseau...",
    "Recyclage des anciennes versions du site...",
    "Capture de CO₂ numérique en cours...",
    "Comptage des abeilles pixelisées...",
    "Nettoyage de l'océan de données...",
    "Calibration des éoliennes virtuelles...",
    "Vérification de l'empreinte carbone de ce clic...",
    "Réintroduction des pandas dans la base de données...",
    "Optimisation de la photosynthèse du design...",
    "Ramassage des déchets dans le cache...",
    "Extinction des lumières inutiles du serveur...",
    "Conversion des cookies en cookies bio...",
    "Plantation de bits dans la forêt de données...",
    "Réglage de la température de la banquise GPU...",
    "Réparation de la couche d'ozone CSS...",
    "Dressage des serveurs pour qu'ils consomment moins...",
    "Réutilisation des blagues déjà recyclées...",
    "Neutralisation carbone de cette barre de chargement...",
    "Réveil des développeurs éco-responsables...",
    "Inspection technique des vélos de livraison de paquets...",
    "Sauvetage des tortues dans le flux réseau...",
    "Chasse au plastique dans les fichiers temporaires...",
    "Vérification du tri des variables globales...",
    "Stockage du surplus d'énergie dans un fichier .green...",
    "Récupération d'eau de pluie pour refroidir le CPU...",
    "Formation des pixels au zéro déchet...",
    "Désactivation des centrales à charbon Java...",
    "Installation de panneaux solaires sur le header...",
    "Compostage des lignes de code inutiles...",
    "Traçage d'un corridor écologique entre deux pages...",
    "Calcul de l'angle optimal du soleil sur le logo...",
    "Protection des espèces rares de bugs...",
    "Rénovation énergétique du HTML existant...",
    "Transport des données en covoiturage...",
    "Filtrage des particules fines dans la base SQL...",
    "Plantation de 14 arbres pour cette requête...",
    "Remplissage des gourdes de la RAM...",
    "Sensibilisation des cookies au RGPD et à la planète...",
    "Réparation des barrières coralliennes du front-end...",
    "Installation de nichoirs à oiseaux dans le footer...",
    "Remplissage des bornes de recharge à données vertes...",
    "Éteindre les volcans de logs trop bavards...",
    "Audit énergétique des animations inutiles...",
    "Préparation d'un monde un peu plus vert..."
];

// CORRIGÉ BUG URGENT 4 : Traductions complètes et ajout des textes manquants
const JS_TEXTS = {
    // === TUTORIEL COMPLET (4 TAPES) ===
    tuto1: {
        title: { fr: "🔔 TUTORIEL - étape 1/4", en: "🔔 TUTORIAL - Step 1/4" },
        text: { fr: "Bienvenue sur Eco-Escapade ! Cette carte interactive vous aide à voyager en train de manière écologique. Utilisez la barre de recherche en haut pour trouver une gare, ou cliquez directement sur un marqueur bleu sur la carte pour voir ses informations.", en: "Welcome to Eco-Escapade! This interactive map helps you travel by train in an eco-friendly way. Use the search bar at the top to find a station, or click directly on a blue marker on the map to see its information." }
    },
    tuto2: {
        title: { fr: "📊 ANALYSE - étape 2/4", en: "📊 ANALYSIS - Step 2/4" },
        text: { fr: "Cliquez sur le bouton 'Analyser' dans la popup d'une gare. L'application va calculer automatiquement un score écologique basé sur plusieurs critères : les parkings vélos à proximité (10 minutes à pied), les bornes de recharge électrique IRVE, les options de covoiturage disponibles et l'accessibilité piétonne globale.", en: "Click the 'Analyze' button in a station's popup. The app will automatically calculate an eco-score based on several criteria: nearby bike parkings (10 minutes walking), IRVE electric charging stations, available carpooling options, and overall pedestrian accessibility." }
    },
    tuto3: {
        title: { fr: "🎯 RÉSULTAT - étape 3/4", en: "🎯 RESULT - Step 3/4" },
        text: { fr: "Le score écologique s'affiche sur 10. Un score élevé (8-10) signifie que la gare est excellente pour les déplacements doux et écologiques. Un score moyen (5-7) indique des possibilités correctes. Vous pouvez activer la zone piétonne de 10 minutes pour visualiser tous les services accessibles à pied depuis la gare.", en: "The eco-score is displayed out of 10. A high score (8-10) means the station is excellent for soft mobility and eco-friendly travel. An average score (5-7) indicates decent possibilities. You can activate the 10-minute walking zone to visualize all services accessible on foot from the station." }
    },
    tuto4: {
        title: { fr: "🙌 À VOUS ! - étape 4/4", en: "🙌 YOUR TURN! - Step 4/4" },
        text: { fr: "Vous savez tout maintenant ! Explorez les gares de France, comparez leurs scores écologiques, ajoutez vos gares préférées avec le bouton 💕 favori, et planifiez vos voyages en train de manière écoresponsable. Utilisez le mode statistiques pour voir les meilleures gares du pays. Bon voyage !", en: "You know everything now! Explore French railway stations, compare their eco-scores, add your favorite stations with the 💕 favorite button, and plan your train trips in an eco-responsible way. Use the statistics mode to see the best stations in the country. Have a great journey!" }
    },

    // === BOUTONS TUTORIEL ===
    tutorialButtons: {
        next: { fr: "Suivant ➡️", en: "Next ➡️" },
        prev: { fr: "⬅️ Précédent", en: "⬅️ Previous" },
        finish: { fr: "Terminer ✅", en: "Finish ✅" },
        skip: { fr: "Passer le tutoriel", en: "Skip tutorial" },
        close: { fr: "Fermer", en: "Close" }
    },

    // === POPUPS ET TOASTS ===
    popup: {
        score: { fr: "Score écolo", en: "Eco Score" },
        analyse: { fr: "Analyser", en: "Analyze" },
        zone: { fr: "Zone 10 min à pied", en: "10 min Walk Zone" },
        champ: { fr: "La meilleure gare du secteur", en: "Best local station" },
        alter: { fr: "Alternative :", en: "Alternative:" },
        analyzing: { fr: "Analyse en cours...", en: "Analyzing..." },
        noEquipment: { fr: "Peu d'équipements.", en: "Few facilities." },
        noConnections: { fr: "Manque de connexions.", en: "Lack of connections." }
    },

    toast: {
        zoneActivated: { fr: "Zone 10 min activée", en: "10 min zone activated" },
        zoneDeactivated: { fr: "Zone 10 min désactivée", en: "10 min zone deactivated" },
        bikesFound: { fr: "Parkings vélos trouvés !", en: "Bike parkings found!" },
        themeApplied: { fr: "Thème appliqué !", en: "Theme applied!" },
        cardCopied: { fr: "Carte copiée !", en: "Card copied!" },
        googleMapsActive: { fr: "Carte Google Maps Standard activée", en: "Google Maps Standard activated" },
        satelliteActive: { fr: "Vue satellite rétablie", en: "Satellite view restored" },
        heatmapOn: { fr: "Carte de chaleur (bientôt disponible)", en: "Heatmap (coming soon)" },
        heatmapOff: { fr: "Carte de chaleur désactivée", en: "Heatmap deactivated" }
    },

    weather: {
        loading: { fr: "Météo...", en: "Weather..." },
        error: { fr: "Météo indisponible", en: "Weather unavailable" }
    },

    // === ANALYSE DÉTAILLÉE ===
    analysis: {
        score: { fr: "Score écolo", en: "Eco Score" },
        bikes: { fr: "Vélos à 10min", en: "Bikes within 10min" },
        irve: { fr: "Recharge électrique", en: "EV Charging" },
        covoit: { fr: "Covoiturage", en: "Carpooling" },
        best: { fr: "La meilleure gare du secteur", en: "Best station in the area" },
        alt: { fr: "Alternative :", en: "Alternative:" },
        go: { fr: "Y aller ➡️", en: "Go there ➡️" },
        zone: { fr: "🚶 Zone 10 min à pied", en: "🚶 10 min Walk Zone" },
        details: { fr: "Détails éco-score", en: "Eco-score details" }
    },

    // NEW: Added missing translations for resetDiscover function
    discover: {
        title: { fr: "Envie de partir quelque part ?", en: "Want to go somewhere?" },
        subtitle: { fr: "Choisissez un environnement, le site trouve pour vous les gares les plus écologiques.", en: "Choose an environment, the site finds the most eco-friendly stations for you." }
    },

    results: {
        loading: { fr: "Chargement en cours...", en: "Loading..." },
        top9: { fr: "Top 9 des gares sélectionnées.", en: "Top 9 selected stations." },
        bikes: { fr: "vélos", en: "bikes" },
        bornes: { fr: "bornes", en: "terminals" },
        go: { fr: "Y aller ➡️", en: "Go there ➡️" }
    },

    categories: {
        mer: { fr: " Plages", en: " Beaches" },
        ocean: { fr: " Océan & Vagues", en: " Ocean & Waves" },
        montagne: { fr: " Montagne & Neige", en: " Mountain & Snow" },
        ville: { fr: " Grandes Métropoles", en: " Major Cities" },
        paris: { fr: " Capitale", en: " Capital" },
        sud: { fr: " ☀️ Le Sud", en: " ☀️ The South" },
        nord: { fr: " Nord", en: " North" }
    },

    location: {
        title: { fr: "Ma position", en: " My location" },
        text: { fr: "Vous êtes localisé ici avec une précision de", en: "You are located here with an accuracy of" },
        meters: { fr: "Mètres", en: "meters" },
        findStation: { fr: "Trouver une gare proche", en: "Find nearby station" }
    },

    // === BOUTONS UI ===
    buttons: {
        random: { fr: "Gare aléatoire", en: "Random station" },
        locate: { fr: "Me localiser", en: "Locate me" },
        stats: { fr: "Statistiques globales", en: "Global statistics" },
        heatmap: { fr: "Carte de chaleur affluence", en: "Crowd heatmap" },
        ignMap: { fr: "Carte Google Maps Standard", en: "Google Maps Standard" },
        themes: { fr: "Changer le Thème", en: "Change theme" },
        ecoInfo: { fr: "Infos écologiques avancées", en: "Advanced ecological info" },
        discover: { fr: "DÉCOUVRIR", en: "DISCOVER" },
        addFavorite: { fr: "Ajouter aux favoris", en: "Add to favorites" },
        removeFavorite: { fr: "Retirer des favoris", en: "Remove from favorites" }
    },

    themes: {
        ecoVert: { fr: "Vert", en: "Green" },
        ocean: { fr: "Océan", en: "Ocean" }
    },

    favs: {
        title: { fr: "💕 Mes Favoris", en: "💕 My Favorites" },
        noFav: { fr: "Aucun favori pour le moment.", en: "No favorites yet." },
        addedOn: { fr: "Ajouté le", en: "Added on" },
        remove: { fr: "Retirer", en: "Remove" },
        goTo: { fr: "Y aller", en: "Go there" }
    },

    ecoPanel: {
        title: { fr: "Informations écologiques avancées", en: "Advanced Ecological Information" },
        defaultText: { fr: "Sélectionnez une gare sur la carte pour voir ses données écologiques détaillées (qualité de l'air, biodiversité, arbres urbains).", en: "Select a station on the map to see its detailed ecological data (air quality, biodiversity, urban trees)." },
        loading: { fr: "Chargement des données écologiques...", en: "Loading ecological data..." },
        error: { fr: "Impossible de charger les données écologiques pour cette zone.", en: "Could not load ecological data for this area." } // UX: Added error message
    },

    search: {
        placeholder: { fr: "Rechercher une gare...", en: "Search for a station..." }
    },

    counter: {
        stations: { fr: "gares", en: "stations" }
    }
};

let currentLang = 'fr';
window.updateAppLanguage = (isFr) => {
    currentLang = isFr ? 'fr' : 'en';
};

// FIX: Properly escape HTML entities to prevent XSS and broken display
// SAFETY: Ensure input is string and handle null/undefined gracefully
const escapeHTML = (str) => {
    if (str === null || str === undefined) return '';
    return String(str).replace(/[&<>'"\/]/g, tag => ({
        '&': '&',
        '<': '<',
        '>': '>',
        "'": '\'',
        '"': '"',
        '/': '/'
    }[tag]));
};

// ============================================================
// 3. CHARGEMENT
// ============================================================

/**
 * Charge toutes les données initiales de l'application (Gares, Rails, IRVE, etc.).
 * Gère les promesses parallèles et l'initialisation de la carte.
 * Affiche un loader pendant le chargement et gère les erreurs API via des toasts.
 * @async
 * @returns {Promise<void>}
 */
async function loadEverything() {
    console.log("Début du chargement...");
    const loaderText = document.getElementById('loader-msg');

    // CORRIGÉ BUG URGENT 2 : Initialisation première phrase drôle aléatoire
    if (loaderText) {
        loaderText.innerText = LOADING_PHRASES[Math.floor(Math.random() * LOADING_PHRASES.length)];
    }

    // CORRIGÉ BUG URGENT 2 : Rotation automatique des phrases toutes les 500ms
    const msgInterval = setInterval(() => {
        if (loaderText) {
            const randomPhrase = LOADING_PHRASES[Math.floor(Math.random() * LOADING_PHRASES.length)];
            loaderText.innerText = randomPhrase;
        }
    }, 500);

    try {
        // === DÉBUT DU CHARGEMENT DES DONNÉES ===
        // Gestion d'erreurs robuste
        const promises = [
            fetch(`${API_BASE_URL}/api/wfs-rails`).then(r => r.json()).catch(e => {
                console.error("🚀 Rails:", e);
                return null;
            }),
            fetch(`${API_BASE_URL}/api/gares`).then(r => r.json()).catch(e => {
                console.error("🚀 Gares:", e);
                showToast("Erreur chargement Gares", true);
                return [];
            }),
            fetch(`${API_BASE_URL}/api/irve`).then(r => r.json()).catch(e => {
                console.error("🚀 IRVE:", e);
                return { features: [] };
            }),
            fetch(`${API_BASE_URL}/api/covoiturage`).then(r => r.json()).catch(e => {
                console.error("🚀 Covoit:", e);
                return { features: [] };
            }),
            fetch(`${API_BASE_URL}/api/parking-velo?minLat=41&maxLat=52&minLon=-5&maxLon=10`).then(r => r.json()).catch(e => {
                console.error("🚀 Vélos:", e);
                return { features: [] };
            })
        ];
        const [rails, gares, irve, covoit, velos] = await Promise.all(promises);

        if (rails) railsLayer.addData(rails);

        DATA.gares = gares;
        DATA.velos = (velos.features || []).map(f => ({
            lat: f.geometry.coordinates[1],
            lon: f.geometry.coordinates[0]
        }));
        DATA.bornes = (irve.features || []).map(f => ({
            lat: f.geometry.coordinates[1],
            lon: f.geometry.coordinates[0]
        }));
        DATA.covoit = (covoit.features || []).map(f => ({
            lat: f.geometry.coordinates[1],
            lon: f.geometry.coordinates[0]
        }));

        map.addLayer(markersLayer);
        map.addLayer(railsLayer);

        initMapMarkers();
        initSecondaryMarkers(irve, covoit, velos);
        preComputeScoresSync();

        // Calcul de TOUTES les stats au chargement pour le panneau Stats
        DATA.gares.forEach(g => {
            const an = analyser(g);
            g.computedScore = an.note;
            g.computedDetails = an.details;
        });

        GLOBAL_STATS = computeGlobalStats();
        await loadFranceMask();

        // CORRIGÉ BUG URGENT 2 : Arrêt de la rotation avant masquage du loader
        clearInterval(msgInterval);

    } catch (error) {
        console.error("Erreur critique chargement:", error);
        showToast("Erreur critique de chargement", true);
        // CORRIGÉ BUG URGENT 2 : Arrêt rotation en cas d'erreur
        clearInterval(msgInterval);
        if (loaderText) {
            loaderText.innerText = 'Erreur de chargement...';
        }
    } finally {
        console.log("Chargement terminé.");
        // === MASQUAGE DU LOADER ===
        setTimeout(() => {
            const loader = document.getElementById('map-loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 800);
            }

            if (!checkTutorialMode()) {
                if (!checkUrlActions()) {
                    map.flyTo([46.6, 2.2], 6, {
                        animate: true,
                        duration: 2.5
                    });
                }
            }
            setupSearchListeners();
            startBackgroundAnalysis();
        }, 500);
    }
}

async function loadFranceMask() {
    try {
        const r = await fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/metropole.geojson');
        const d = await r.json();
        const mask = [
            [
                [-180, 90],
                [180, 90],
                [180, -90],
                [-180, -90]
            ]
        ];
        d.geometry.coordinates.forEach(p => mask.push(p[0]));
        L.geoJSON({
            type: "Feature",
            geometry: {
                type: "Polygon",
                coordinates: mask
            }
        }, {
            style: {
                color: '#0f172a',
                weight: 1,
                fillColor: '#020617',
                fillOpacity: 0.75,
                interactive: false
            }
        }).addTo(map);
    } catch (e) {}
}

function initMapMarkers() {
    const dl = document.getElementById('gares-list');
    if (dl) dl.innerHTML = '';
    DATA.gares.forEach(g => {
        if (g.lat) {
            if (dl) {
                let o = document.createElement('option');
                o.value = g.nom;
                dl.appendChild(o);
            }

            let isTGV = g.type === 'TGV';
            // Calcul score pour couleur pulsation (sans afficher le score)
            const analysis = analyser(g);
            const score = analysis.note;
            const pulseColor = score >= 8 ? '#10b981' : score >= 5 ? '#f59e0b' : '#ef4444';
            const pulseSpeed = score >= 8 ? '1.5s' : score >= 7 ? '2s' : '2.5s';

            // Icône originale avec pulsation dynamique
            let icon = L.divIcon({
                className: 'marker-with-pulse',
                html: `
                    <style>
                        @keyframes pulse-gare-${g.id} {
                            0%, 100% { box-shadow: 0 0 0 0 ${pulseColor}80; }
                            50% { box-shadow: 0 0 0 15px ${pulseColor}00; }
                        }
                    </style>
                    <div class="marker-pin ${isTGV?'tgv':'ter'}" style="animation: pulse-gare-${g.id} ${pulseSpeed} infinite;">
                        <i class="fa-solid fa-train"></i>
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            let m = L.marker([g.lat, g.lon], {
                icon: icon
            });

            m.bindPopup(() => generatePopupContent(g));
            m.on('popupopen', () => {
                // FIX: Clear any existing walk zone when opening a new popup
                hideWalkZone();

                // Reset panneau avant chargement nouvelles données
                resetEcoPanel();

                loadPhoto(g.nom, g.id);
                loadWeather(g.lat, g.lon, g.id);
                // Chargement qualité air
                loadAirQuality(g.lat, g.lon, g.id);
                // Chargement biodiversité
                loadBiodiversity(g.lat, g.lon, g.id);
            });
            g.marker = m;
            markersLayer.addLayer(m);
        }
    });
    updateCount();
}

/**
 * Génère le contenu HTML du popup pour une gare donnée.
 * Inclut le score, l'avis, et les boutons d'action.
 * @param {Object} g - L'objet gare contenant nom, id, type, lat, lon.
 * @returns {string} Chaîne HTML du popup.
 */
function generatePopupContent(g) {
    const analysis = analyser(g);
    const score = analysis.note;
    let avisList = score < 4 ? AVIS_BAD : score < 7 ? AVIS_MID : AVIS_GOOD;
    let avis = avisList[Math.floor(Math.random() * avisList.length)];
    let colorScore = score < 4 ? '#ef4444' : score < 7 ? '#f59e0b' : '#10b981';
    let isTGV = g.type === 'TGV';
    const t = JS_TEXTS.popup;
    const lang = currentLang;
    const safeNom = escapeHTML(g.nom);

    return `
        <div style="font-family:'Inter',sans-serif;">
            <div class="photo-container"><img id="photo-${g.id}" class="city-photo" src="" alt="${safeNom}"></div>
            <div id="weather-${g.id}" class="weather-box">
                <span><i class="fa-solid fa-spinner fa-spin"></i> ${JS_TEXTS.weather.loading[lang]}</span>
            </div>
            <div style="padding:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div><h3 style="margin:0; font-size:1.2rem; color:#0f172a;">${safeNom}</h3><span style="background:${isTGV?'#3b82f6':'#10b981'}; color:white; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:bold;">${g.type}</span></div>
                    <i id="fav-${g.id}" onclick="toggleFavori(${g.id}, '${safeNom.replace(/'/g, "\\'")}', '${g.type}')" class="fa-solid fa-heart fav-btn ${isFavori(g.id)?'fav-active':'fav-inactive'}"></i>
                </div>
                
                <div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:15px; font-style:italic; font-size:0.9rem; color:#475569; border-left: 3px solid ${colorScore};">" ${avis} "</div>
                <div id="action-container-${g.id}">
                    <button class="btn-analyse" onclick="event.stopPropagation(); lancerAnalyseComplete(${g.id})" style="width:100%; background:#0f172a; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold; margin-bottom:5px;">${t.analyse[lang]}</button>
                    <button class="btn-walk" onclick="event.stopPropagation(); showWalkZone(${g.lat}, ${g.lon})"><i class="fa-solid fa-person-walking"></i> ${t.zone[lang]}</button>
                </div>
            </div>
        </div>`;
}

// Fonction pour charger une photo de la ville/gare
async function loadPhoto(nom, id) {
    const img = document.getElementById(`photo-${id}`);
    if (!img) return;
    
    // Extraire le nom de ville (premier mot avant tiret ou espace)
    const cleanName = nom.split(/[-\s]/)[0].replace(/[^a-zA-ZÀ-ÿ]/g, '');
    
    // Utiliser loremflickr ou une image de fallback
    const imgUrl = `https://loremflickr.com/400/150/${cleanName},city,france/all?lock=${id}`;
    
    img.src = imgUrl;
    img.onerror = () => {
        // Si l'image échoue, utiliser une image de fallback
        const fallbackIndex = id % FALLBACK_IMAGES.length;
        img.src = FALLBACK_IMAGES[fallbackIndex];
    };
}

async function loadWeather(lat, lon, id) {
    const el = document.getElementById(`weather-${id}`);
    if (!el) return;
    try {
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
        const d = await r.json();
        const w = d.current_weather || d.current;

        if (w) {
            el.innerHTML = `
                <div class="weather-item"><i class="fa-solid fa-temperature-half weather-icon"></i> ${w.temperature}°C</div>
                <div class="weather-item"><i class="fa-solid fa-wind weather-icon"></i> ${w.windspeed} km/h</div>
            `;
        } else {
            throw new Error('No Data');
        }
    } catch (e) {
        el.innerHTML = `<span style="font-size:0.8rem; color:#64748b;">${JS_TEXTS.weather.error[currentLang]}</span>`;
        console.error(`Météo err ${id}:`, e.message);
    }
}

// Refonte complète des popups IRVE & Covoiturage
function initSecondaryMarkers(irve, covoit, velos) {
    const iBuf = [],
        cBuf = [],
        vBuf = [];

    // Bornes IRVE
    (irve.features || []).forEach(f => {
        if (f.geometry.coordinates) {
            const props = f.properties || {};
            const nom = escapeHTML(props.nom_amenageur || props.n_enseigne || "Borne de recharge");
            const prise = props.nbre_pdc ? `${props.nbre_pdc} prises` : "Prises inconnues";
            const puissance = props.puissance_nominale ? `${props.puissance_nominale} kW` : "";
            const acces = props.acces_recharge || "Accès public";

            let h = `
            <div style="font-family:'Inter',sans-serif; width:250px;">
                <div class="simple-popup-header header-irve"><i class="fa-solid fa-charging-station"></i> Borne électrique</div>
                <div class="simple-popup-body">
                    <div style="font-weight:bold; color:#0f172a; margin-bottom:10px;">${nom}</div>
                    <div><i class="fa-solid fa-plug" style="color:#f59e0b"></i> ${prise} ${puissance ? ' • ' + puissance : ''}</div>
                    <div><i class="fa-solid fa-unlock" style="color:#64748b"></i> ${acces}</div>
                    <a href="https://www.google.com/maps?q=${f.geometry.coordinates[1]},${f.geometry.coordinates[0]}" target="_blank" class="btn-maps"><i class="fa-solid fa-map-location-dot"></i> Voir sur Google Maps</a>
                </div>
            </div>`;
            iBuf.push(L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                icon: L.divIcon({
                    className: 'c',
                    html: `<div class="marker-pin irve"><i class="fa-solid fa-plug" style="color:black"></i></div>`,
                    iconSize: [30, 30]
                })
            }).bindPopup(h));
        }
    });

    // Covoiturage
    (covoit.features || []).forEach(f => {
        if (f.geometry.coordinates) {
            const props = f.properties || {};
            const nom = props.nom_aire || props.ville || "Aire de covoiturage";
            const places = props.nb_places ? `${props.nb_places} places` : "Places inconnues";
            const type = props.type_aire || "Aire publique";

            let h = `
            <div style="font-family:'Inter',sans-serif; width:250px;">
                <div class="simple-popup-header header-covoit"><i class="fa-solid fa-car"></i> Covoiturage</div>
                <div class="simple-popup-body">
                    <div style="font-weight:bold; color:#0f172a; margin-bottom:10px;">${nom}</div>
                    <div><i class="fa-solid fa-square-parking" style="color:#a855f7"></i> ${places}</div>
                    <div><i class="fa-solid fa-road" style="color:#64748b"></i> ${type}</div>
                    <a href="https://www.google.com/maps?q=${f.geometry.coordinates[1]},${f.geometry.coordinates[0]}" target="_blank" class="btn-maps"><i class="fa-solid fa-map-location-dot"></i> Voir sur Google Maps</a>
                </div>
            </div>`;
            cBuf.push(L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                icon: L.divIcon({
                    className: 'c',
                    html: `<div class="marker-pin covoit"><i class="fa-solid fa-car" style="color:black"></i></div>`,
                    iconSize: [30, 30]
                })
            }).bindPopup(h));
        }
    });

    // Vélos
    (velos.features || []).forEach(f => {
        if (f.geometry.coordinates) {
            vBuf.push(L.marker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                icon: L.divIcon({
                    className: 'c',
                    html: `<div class="marker-pin velo"><i class="fa-solid fa-bicycle"></i></div>`,
                    iconSize: [30, 30]
                })
            }));
        }
    });

    irveLayer.addLayers(iBuf);
    covoitLayer.addLayers(cBuf);
    veloParkingLayer.addLayers(vBuf);
}

function setupSearchListeners() {
    const sInput = document.getElementById('search-input');
    if (sInput) {
        sInput.addEventListener('focus', () => {});
        sInput.addEventListener('change', (e) => {
            const g = DATA.gares.find(x => x.nom === e.target.value);
            if (g) goToGare(g.id);
            if (tutoStep === 3) skipTuto();
        });
    }
}

// Refonte Popup Localisation Found
map.on('locationfound', (e) => {
    map.eachLayer((layer) => {
        if (layer.options && layer.options.icon && layer.options.icon.options.className === 'user-pin-icon') map.removeLayer(layer);
    });
    const userIcon = L.divIcon({
        className: 'user-pin-icon',
        html: '<div class="user-pin"></div>',
        iconSize: [20, 20]
    });

    const t = JS_TEXTS.location;
    const lang = currentLang;

    const popupContent = `
        <div class="location-popup">
            <div class="location-header">${t.title[lang]}</div>
            <div class="location-body">
                <i class="fa-solid fa-street-view" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                <p style="margin:0 0 10px 0;">${t.text[lang]} <b>${Math.round(e.accuracy)} ${t.meters[lang]}</b>.</p>
                <small style="color:#64748b;">${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}</small>
                <button class="location-btn" onclick="window.findNearbyStation(${e.latlng.lat}, ${e.latlng.lng})">
                    <i class="fa-solid fa-magnifying-glass-location"></i> ${t.findStation[lang]}
                </button>
            </div>
        </div>
    `;

    L.marker(e.latlng, {
        icon: userIcon
    }).addTo(map).bindPopup(popupContent).openPopup();
    L.circle(e.latlng, {
        radius: e.accuracy / 2,
        color: '#3b82f6',
        fillOpacity: 0.1,
        weight: 1
    }).addTo(map);
});
map.on('locationerror', () => alert("Impossible de vous localiser."));

// Choisit une gare aléatoire uniquement lorsque les marqueurs sont Prêts
window.randomGare = () => {
    // désactivation très courte du bouton « dé » pour éviter les double-clics
    try {
        const diceBtn = document.getElementById('btnRandomGare');
        if (diceBtn) {
            diceBtn.style.pointerEvents = 'none';
            setTimeout(() => {
                diceBtn.style.pointerEvents = 'auto';
            }, 400);
        }
    } catch (e) {}
    if (!DATA.gares || !DATA.gares.length) return;
    const pool = DATA.gares.filter(g => g && g.marker);
    if (!pool.length) {
        showToast('Chargement en cours...', false);
        return;
    }
    // Si une zone piétonne est active, on la retire pour éviter tout artefact visuel
    hideWalkZone();
    // Stoppe toute animation en cours qui peut retarder l'affichage
    try {
        map.stop();
    } catch (e) {}
    // Petit refresh visuel
    map.invalidateSize(true);
    markersLayer.refreshClusters();

    const pick = pool[Math.floor(Math.random() * pool.length)];
    goToGare(pick.id);
};

// Centre la carte sur la gare et ouvre de façon robuste la popup
window.goToGare = (id) => {
    const g = DATA.gares.find(x => x.id === id);
    if (!g || !g.marker) {
        showToast('Gare indisponible', true);
        return;
    }

    const target = L.latLng(g.lat, g.lon);
    // Nettoyage et Préparation avant d'animer
    hideWalkZone();
    map.closePopup();
    if (!map.hasLayer(markersLayer)) map.addLayer(markersLayer);
    // Forcer un léger refresh (certains navigateurs gardent l'état des clusters figé tant qu'aucun zoom n'est déclenché)
    map.invalidateSize(true);
    markersLayer.refreshClusters();

    markersLayer.zoomToShowLayer(g.marker, () => {
        const desiredZoom = Math.max(map.getZoom(), 14);
        map.setView(target, desiredZoom, {
            animate: true
        });

        const tryOpen = () => {
            try {
                g.marker.openPopup();
            } catch (e) {}
        };
        setTimeout(tryOpen, 120);
        // Fallback supplémentaire si l'animation de cluster retarde l'ouverture
        setTimeout(() => {
            if (g.marker.isPopupOpen && !g.marker.isPopupOpen()) tryOpen();
            // Après l'animation, on force un dernier refresh des clusters pour garantir l'affichage
            markersLayer.refreshClusters();
        }, 500);
    });
};

// Nouvelle fonction pour la recherche proche
window.findNearbyStation = (lat, lon) => {
    if (!DATA.gares.length) return;
    // Tri par distance simple
    const sorted = [...DATA.gares].sort((a, b) => getDist(lat, lon, a.lat, a.lon) - getDist(lat, lon, b.lat, b.lon));
    const closest = sorted[0];
    if (closest) {
        map.flyTo([closest.lat, closest.lon], 13);
        setTimeout(() => {
            markersLayer.zoomToShowLayer(closest.marker, () => {
                closest.marker.openPopup();
            });
        }, 1500);
    }
};

// Fonction pour cacher la zone piétonne
function hideWalkZone() {
    if (walkCircle) {
        try {
            map.removeLayer(walkCircle);
        } catch (e) {}
        walkCircle = null;
    }
    // Réactiver le bouton « 10 min » si Présent dans la popup
    try {
        const walkBtn = document.querySelector('.leaflet-popup .btn-walk');
        if (walkBtn) {
            walkBtn.style.pointerEvents = 'auto';
            walkBtn.removeAttribute('aria-disabled');
            walkBtn.tabIndex = 0;
        }
    } catch (e) {}
}

// Variable pour empêcher les clics multiples rapides
let isCreatingWalkZone = false;

/**
 * Active l'affichage de la zone piétonne (10 min) autour d'une gare.
 * Calcule un cercle de 800m et compte les parkings vélos à l'intérieur.
 */
window.showWalkZone = function(lat, lon) {
    // FIX: Empêcher les clics multiples rapides
    if (isCreatingWalkZone) return;
    isCreatingWalkZone = true;
    // désactiver (invisiblement) le bouton « 10 min » dans la popup courante
    try {
        const walkBtn = document.querySelector('.leaflet-popup .btn-walk');
        if (walkBtn) {
            walkBtn.style.pointerEvents = 'none';
            walkBtn.setAttribute('aria-disabled', 'true');
            walkBtn.tabIndex = -1;
        }
    } catch (e) {}

    // SAFETY: Ensure any previous circle is removed before drawing a new one.
    hideWalkZone();

    // FIX: Fermer la popup avant de zoomer pour éviter les conflits visuels
    map.closePopup();

    // FIX: D'abord zoomer sur la gare, PUIS ajouter le cercle une fois le zoom terminé
    map.flyTo([lat, lon], 15, {
        duration: 1.2
    });

    // Attendre la fin de l'animation de zoom avant d'ajouter le cercle
    map.once('moveend', function() {
        // CRÉATION du cercle de 800m (10-15 min de marche).
        walkCircle = L.circle([lat, lon], {
            radius: 800,
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.15,
            weight: 3,
            dashArray: '10, 10'
        }).addTo(map);

        // FIX: S'assurer que les rails restent au-dessus du cercle
        setTimeout(() => {
            if (railsLayer && map.hasLayer(railsLayer)) {
                railsLayer.bringToFront();
            }
        }, 50);

        // Comptage des parkings vélos dans la zone pour l'info-bulle
        let count = 0;
        const bounds = walkCircle.getBounds();
        DATA.velos.forEach(v => {
            if (bounds.contains({
                    lat: v.lat,
                    lng: v.lon
                })) {
                count++;
            }
        });

        checkTutoAdvancement('walk');

        // Utilisation des traductions pour le message.
        showToast(`${JS_TEXTS.toast.zoneActivated[currentLang]} (${count} ${JS_TEXTS.results.bikes[currentLang]})`);

        // FIX: Réactiver les clics après un court délai
        setTimeout(() => {
            isCreatingWalkZone = false;
        }, 300);
    });
};

// === MODIFIÉ : OPTIMISATION CRITIQUE DES PERFORMANCES ===

/**
 * Analyse une gare pour calculer son score écologique.
 * Comptabilise les vélos (800m), bornes IRVE (3km) et covoiturage (3km).
 * @param {Object} g - L'objet gare à analyser.
 * @returns {Object} Un objet contenant la note (/10), les détails des compteurs et le total.
 */
function analyser(g) {
    let d = {
        bornes: 0,
        covoit: 0,
        velos: 0
    };
    // Optimisation : Bounding Box (environ +/- 0.05 degrés, soit ~5km)
    const latMin = g.lat - 0.05,
        latMax = g.lat + 0.05;
    const lonMin = g.lon - 0.05,
        lonMax = g.lon + 0.05;
    const fastFilter = (p) => p.lat >= latMin && p.lat <= latMax && p.lon >= lonMin && p.lon <= lonMax;
    DATA.velos.forEach(v => {
        if (fastFilter(v) && getDist(g.lat, g.lon, v.lat, v.lon) <= 0.8) d.velos++;
    });
    DATA.bornes.forEach(b => {
        if (fastFilter(b) && getDist(g.lat, g.lon, b.lat, b.lon) <= 3) d.bornes++;
    });
    DATA.covoit.forEach(c => {
        if (fastFilter(c) && getDist(g.lat, g.lon, c.lat, c.lon) <= 3) d.covoit++;
    });
    let s = (g.type === 'TGV' ? 1 : 0) + Math.min(d.velos * 1, 7) + Math.min(d.bornes * 0.5, 2) + Math.min(d.covoit * 0.5, 1);
    return {
        note: Math.min(Math.round(s * 10) / 10, 10),
        details: d,
        total: d.velos + d.bornes + d.covoit
    };
}
// ========================================================

function preComputeScoresSync() {
    for (let i = 0; i < DATA.gares.length; i++) {
        const g = DATA.gares[i];
        g.tags = [];

        if (g.lat < 45.7) g.tags.push('sud');
        if (g.lat > 49.0) g.tags.push('nord'); // Ajout Nord

        // Paris spécifique
        if (getDist(g.lat, g.lon, 48.8566, 2.3522) < 20) g.tags.push('paris');

        const isAlpes = (g.lon > 5.5 && g.lat < 46.2 && g.lat > 44.0);
        const isPyrenees = (g.lat < 43.2 && g.lon < 3.0);
        if (isAlpes || isPyrenees) g.tags.push('montagne');

        // Séparation Mer / Océan
        const isMed = (g.lat < 43.7 && g.lon > 3.0);
        const isAtlantique = (g.lon < -1.0 && g.lat < 48.0);
        const isManche = (g.lat > 48.5 && g.lon < -1.5);

        if (isMed) g.tags.push('mer');
        if (isAtlantique || isManche) g.tags.push('ocean');

        const cleanName = g.nom.replace(/Gare de\s?/i, '').trim();
        if (MAJOR_CITIES.some(city => cleanName.includes(city))) g.tags.push('ville');
    }
}

/**
 * Lance une analyse comparative complète pour une gare.
 * Compare avec les gares environnantes pour trouver une meilleure alternative.
 * Met à jour l'interface utilisateur avec les scores détaillés et les barres de progression.
 * @param {number} id - L'identifiant de la gare à analyser.
 */
window.lancerAnalyseComplete = function(id) {
    const g = DATA.gares.find(x => x.id === id);
    const s = analyser(g);
    let best = null;
    let bestS = s.note;
    let bestTotal = s.total;
    // Optimisation boucle comparative
    const latMin = g.lat - 0.2,
        latMax = g.lat + 0.2;
    const lonMin = g.lon - 0.2,
        lonMax = g.lon + 0.2;
    DATA.gares.forEach(v => {
        if (v.id !== id && v.lat >= latMin && v.lat <= latMax && v.lon >= lonMin && v.lon <= lonMax) {
            let dist = getDist(g.lat, g.lon, v.lat, v.lon);
            if (dist <= 10) {
                let sv = analyser(v);
                if (sv.note > bestS) {
                    bestS = sv.note;
                    bestTotal = sv.total;
                    best = v;
                } else if (sv.note === bestS && sv.total > bestTotal) {
                    bestS = sv.note;
                    bestTotal = sv.total;
                    best = v;
                }
            }
        }
    });

    // Utilisation complète de JS_TEXTS.analysis pour la traduction dynamique
    const t = JS_TEXTS.analysis;
    const lang = currentLang;

    const pctV = Math.min((s.details.velos / 5) * 100, 100);
    const pctB = Math.min((s.details.bornes / 6) * 100, 100);
    const pctC = Math.min((s.details.covoit / 2) * 100, 100);
    const color = s.note >= 7 ? '#059669' : s.note >= 4 ? '#d97706' : '#dc2626';

    let html = `
        <div class="analyse-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${t.score[lang]}</span><span style="font-weight:900; color:${color}">${s.note}/10</span>
            </div>
            <div class="stat-row"><i class="fa-solid fa-bicycle" style="width:25px; color:#0891b2;"></i> <span style="flex:1">${t.bikes[lang]}</span> <b>${s.details.velos}</b><div class="progress-bg"><div class="progress-fill" style="width:${pctV}%; background:#0891b2;"></div></div></div>
            <div class="stat-row"><i class="fa-solid fa-plug" style="width:25px; color:#d97706;"></i> <span style="flex:1">${t.irve[lang]}</span> <b>${s.details.bornes}</b><div class="progress-bg"><div class="progress-fill" style="width:${pctB}%; background:#d97706;"></div></div></div>
            <div class="stat-row"><i class="fa-solid fa-car" style="width:25px; color:#9333ea;"></i> <span style="flex:1">${t.covoit[lang]}</span> <b>${s.details.covoit}</b><div class="progress-bg"><div class="progress-fill" style="width:${pctC}%; background:#9333ea;"></div></div></div>
    `;

    if (best) {
        html += `<button onclick="goToGare(${best.id})" style="width:100%;
        margin-top:15px; background:white; border:1px solid ${color}; color:${color}; padding:10px 12px; border-radius:6px; font-weight:600; font-size:0.85rem; display:flex; justify-content:space-between; align-items:center;
        cursor:pointer;">
                    <span>${t.alt[lang]} ${escapeHTML(best.nom.replace("Gare de ", ""))}</span>
                    <span style="background:${color};
                    color:white; padding:2px 6px; border-radius:4px;">${bestS} ${t.go[lang].replace('Y aller ', '')}</span>
                 </button>`;
    } else {
        html += `<div style="margin-top:15px; background:#ecfdf5; color:#047857; padding:12px; border-radius:6px; font-weight:800; text-align:center; border:1px solid #a7f3d0;"><i class="fa-solid fa-trophy"></i> ${t.best[lang]}</div>`;
    }

    // CORRIGÉ BUG URGENT 4 : Appel avec tous les arguments pour toggleWalkZone
    html += `<button class="btn-walk" onclick="event.stopPropagation(); showWalkZone(${g.lat}, ${g.lon})"><i class="fa-solid fa-person-walking"></i> ${t.zone[lang]}</button>`;
    html += `</div>`;
    document.getElementById(`action-container-${id}`).innerHTML = html;

    // déclenchement confettis si score excellent
    if (s.note >= 9) {
        confetti({
            particleCount: 150,
            spread: 70,
            origin: {
                y: 0.6
            },
            colors: ['#10b981', '#22c55e', '#84cc16', '#a3e635']
        });

        // Double explosion pour score parfait 10/10
        if (s.note === 10) {
            setTimeout(() => {
                confetti({
                    particleCount: 200,
                    angle: 60,
                    spread: 55,
                    origin: {
                        x: 0
                    }
                });
                confetti({
                    particleCount: 200,
                    angle: 120,
                    spread: 55,
                    origin: {
                        x: 1
                    }
                });
            }, 250);
        }
    }

    checkTutoAdvancement('analyse');
};

const overlays = {
    "🚉 Gares": markersLayer,
    "🛤️ Rails": railsLayer,
    "⚡ Bornes": irveLayer,
    "🚗 Covoit": covoitLayer,
    "🚲 Vélos": veloParkingLayer
};
L.control.layers(null, overlays, {
    position: 'bottomright'
}).addTo(map);
L.control.scale({
    imperial: false
}).addTo(map);

try {
    new L.Control.MiniMap(L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'), {
        toggleDisplay: true,
        position: 'bottomleft'
    }).addTo(map);
} catch (e) {}

map.on('zoomend', () => {
    // Vérifier que OSMBuildings est chargé avant de l'utiliser
    if (map.getZoom() >= 15 && !osmb && typeof OSMBuildings !== 'undefined') {
        try {
            osmb = new OSMBuildings(map).load('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');
        } catch (e) {
            console.warn('OSMBuildings non disponible');
        }
    }
});

// CORRIGÉ BUG URGENT 3 : Icônes gares adaptées par niveau de zoom (Zoom sémantique)
map.on('zoomend', function() {
    const zoom = map.getZoom();

    if (zoom < 8) {
        // Vue France : Seulement TGV + rails simplifiés
        railsLayer.setStyle({
            weight: 1.5,
            opacity: 0.5
        });
        irveLayer.remove();
        covoitLayer.remove();
        veloParkingLayer.remove();

        // Taille normale gares
        DATA.gares.forEach(g => {
            if (g.marker) {
                const icon = g.marker.getIcon();
                icon.options.iconSize = [30, 30];
                icon.options.iconAnchor = [15, 30];
                g.marker.setIcon(icon);
            }
        });

    } else if (zoom >= 8 && zoom < 12) {
        // Vue Régionale : TGV + TER + rails normaux
        if (!map.hasLayer(railsLayer)) map.addLayer(railsLayer);
        railsLayer.setStyle({
            weight: 2,
            opacity: 0.6
        });
        irveLayer.remove();
        covoitLayer.remove();
        veloParkingLayer.remove();

        // Taille normale gares
        DATA.gares.forEach(g => {
            if (g.marker) {
                const icon = g.marker.getIcon();
                icon.options.iconSize = [30, 30];
                icon.options.iconAnchor = [15, 30];
                g.marker.setIcon(icon);
            }
        });

    } else if (zoom >= 12 && zoom < 14) {
        // Vue locale : Tout afficher + Gares moyennes
        if (!map.hasLayer(railsLayer)) map.addLayer(railsLayer);
        railsLayer.setStyle({
            weight: 3,
            opacity: 0.7
        });
        if (!map.hasLayer(irveLayer)) map.addLayer(irveLayer);
        if (!map.hasLayer(covoitLayer)) map.addLayer(covoitLayer);
        if (!map.hasLayer(veloParkingLayer)) map.addLayer(veloParkingLayer);

        DATA.gares.forEach(g => {
            if (g.marker) {
                const icon = g.marker.getIcon();
                icon.options.iconSize = [40, 40];
                icon.options.iconAnchor = [20, 20];
                g.marker.setIcon(icon);
            }
        });
    } else {
        // Vue locale : Tout visible
        if (!map.hasLayer(railsLayer)) map.addLayer(railsLayer);
        if (!map.hasLayer(irveLayer)) map.addLayer(irveLayer);
        if (!map.hasLayer(covoitLayer)) map.addLayer(covoitLayer);
        if (!map.hasLayer(veloParkingLayer)) map.addLayer(veloParkingLayer);
    }
});

loadEverything();

function checkUrlActions() {
    const urlParams = new URLSearchParams(window.location.search);
    const targetId = urlParams.get('target');
    const action = urlParams.get('action');
    if (targetId) {
        setTimeout(() => goToGare(parseInt(targetId)), 500);
        return true;
    } else if (action === 'random') {
        setTimeout(() => randomGare(), 500);
        return true;
    }
    return false;
}

window.openDiscoverModal = () => {
    document.getElementById('discoverModal').classList.add('active');
    document.getElementById('catGrid').style.display = 'grid';
    document.getElementById('resultsContainer').style.display = 'none';
};
window.closeDiscover = () => document.getElementById('discoverModal').classList.remove('active');

window.showCategory = (category, titleArg) => {
    document.getElementById('catGrid').style.display = 'none';
    document.getElementById('resultsContainer').style.display = 'grid';
    document.getElementById('btnBackCat').style.display = 'inline-block';

    // MODIFIÉ : Ignore le titre passé en paramètre et utilise la traduction via l'ID category
    const tCats = JS_TEXTS.categories;
    const tRes = JS_TEXTS.results;
    const lang = currentLang;

    document.getElementById('discoverTitle').innerText = tCats[category] ? tCats[category][lang] : titleArg;
    document.getElementById('discoverSubtitle').innerText = tRes.top9[lang];

    if (!DATA.gares[0].computedScore) {
        DATA.gares.forEach(g => {
            const an = analyser(g);
            g.computedScore = an.note;
            g.computedDetails = an.details;
        });
    }

    let candidates = DATA.gares.filter(g => g.tags && g.tags.includes(category));
    candidates.sort((a, b) => b.computedScore - a.computedScore);
    const top9 = candidates.slice(0, 9);
    const container = document.getElementById('resultsContainer');
    container.innerHTML = '';

    if (top9.length === 0) {
        container.innerHTML = `<div style="color:white; grid-column:span 3;">${tRes.loading[lang]}</div>`;
    } else {
        top9.forEach((g, idx) => {
            const cleanName = g.nom.split(' ')[0].replace(/-/g, '');
            const imgUrl = `https://loremflickr.com/400/200/${cleanName},city/all?lock=${g.id}`;
            const html = `
                <div class="result-card rank-${idx+1}" style="overflow:hidden;">
                    <div style="height:120px; background:url('${imgUrl}') center/cover no-repeat; position:relative;">
                        <div class="rank-badge">#${idx+1}</div>
                        <div class="street-view-btn" onclick="window.open('https://www.google.com/maps?q=${encodeURIComponent(g.nom)}', '_blank'); event.stopPropagation();"><i class="fa-solid fa-street-view"></i></div>
                    </div>
                    <div style="padding:15px;">
                        <h3 style="color:white; margin:0 0 5px 0;">${escapeHTML(g.nom)}</h3>
                        <div style="font-weight:900; color:#10b981; font-size:1.5rem;
margin-bottom:10px;">${g.computedScore}/10</div>
                        <div style="font-size:0.85rem;
color:#94a3b8; margin-bottom:15px;">
                            <i class="fa-solid fa-bicycle"></i> ${g.computedDetails.velos} ${tRes.bikes[lang]} • 
                            <i class="fa-solid fa-plug"></i> ${g.computedDetails.bornes} ${tRes.bornes[lang]}
                        </div>
         
               <button onclick="goToGare(${g.id}); closeDiscover();" style="background:var(--primary); border:none;
padding:10px; width:100%; border-radius:6px; font-weight:bold; cursor:pointer; color:#022c22;">${tRes.go[lang]}</button>
                    </div>
                </div>`;
            container.innerHTML += html;
        });
    }
};

window.resetDiscover = () => {
    document.getElementById('catGrid').style.display = 'grid';
    document.getElementById('resultsContainer').style.display = 'none';
    document.getElementById('btnBackCat').style.display = 'none';
    // FIX: Use translated texts from JS_TEXTS instead of hardcoded French strings.
    const t = JS_TEXTS.discover;
    const lang = currentLang;
    document.getElementById('discoverTitle').innerText = t.title[lang];
    document.getElementById('discoverSubtitle').innerText = t.subtitle[lang];
};

function startBackgroundAnalysis() {
    let index = 0;
    const chunkSize = 100;

    function processChunk() {
        const end = Math.min(index + chunkSize, DATA.gares.length);
        for (let i = index; i < end; i++) {
            const g = DATA.gares[i];
            const analysis = analyser(g);
            g.computedScore = analysis.note;
            g.computedDetails = analysis.details;
            if (!g.tags) g.tags = [];
            if (g.computedDetails.velos > 2 && getDist(g.lat, g.lon, 48.8566, 2.3522) > 50) g.tags.push('nature');
        }
        index += chunkSize;
        if (index < DATA.gares.length) requestAnimationFrame(processChunk);
        else {
            const btn = document.querySelector('.btn-discover');
            if (btn) btn.style.opacity = '1';
        }
    }
    processChunk();
}

function computeGlobalStats() {
    if (!DATA.gares.length) return null;
    let totalScore = 0;
    let tgvCount = 0;
    let sumVelos = 0;
    let sumBornes = 0;
    let sumCovoit = 0;
    let n = 0;
    DATA.gares.forEach(g => {
        if (!g.computedScore || !g.computedDetails) return;
        n++;
        totalScore += g.computedScore;
        if (g.type === 'TGV') tgvCount++;
        sumVelos += g.computedDetails.velos;
        sumBornes += g.computedDetails.bornes;
        sumCovoit += g.computedDetails.covoit;
    });
    if (n === 0) return null;
    return {
        gares: n,
        scoreMoyen: (totalScore / n).toFixed(1),
        partTGV: Math.round((tgvCount / n) * 100) + '%',
        moyVelos: (sumVelos / n).toFixed(1),
        moyBornes: (sumBornes / n).toFixed(1),
        moyCovoit: (sumCovoit / n).toFixed(1),
    };
}

const statsPanel = document.getElementById('statsPanel');
const btnStats = document.getElementById('btnStats');
const btnStatsClose = document.getElementById('closeStats');

function refreshStatsPanel() {
    if (!GLOBAL_STATS) return;
    document.getElementById('stat-gares').innerText = GLOBAL_STATS.gares;
    document.getElementById('stat-score').innerText = GLOBAL_STATS.scoreMoyen + '/10';
    document.getElementById('stat-tgv').innerText = GLOBAL_STATS.partTGV;
    document.getElementById('stat-velos').innerText = GLOBAL_STATS.moyVelos;
    document.getElementById('stat-bornes').innerText = GLOBAL_STATS.moyBornes;
    document.getElementById('stat-covoit').innerText = GLOBAL_STATS.moyCovoit;
}
if (btnStats && statsPanel) {
    btnStats.addEventListener('click', () => {
        refreshStatsPanel();
        statsPanel.classList.add('active');
    });
}
if (btnStatsClose && statsPanel) {
    btnStatsClose.addEventListener('click', () => {
        statsPanel.classList.remove('active');
    });
}

let tutoStep = 0;
let currentTutoTarget = null;

function checkTutorialMode() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tuto') === 'true') {
        startTutorialScenario();
        return true;
    }
    return false;
}

window.skipTuto = function() {
    const box = document.getElementById('tutoBox');
    box.classList.remove('active');
    window.history.replaceState({}, document.title, "map.html");
    document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
    const searchBox = document.getElementById('searchBox');
    if (searchBox) searchBox.classList.remove('highlight-target');
    tutoStep = 0;
    currentTutoTarget = null;
    map.flyTo([46.6, 2.2], 6, {
        animate: true,
        duration: 2
    });
    if (railsLayer.getLayers().length > 0 && !map.hasLayer(railsLayer)) map.addLayer(railsLayer);
};
// CORRIGÉ BUG URGENT 4 : Utilisation des traductions tutoriel
function updateTutoBox(title, text, showNext = false) {
    const box = document.getElementById('tutoBox');
    document.getElementById('tutoTitle').innerText = title;
    document.getElementById('tutoText').innerText = text;
    box.classList.add('active');
    const btn = document.getElementById('tutoBtn');
    if (showNext) {
        btn.style.display = 'inline-block';
        btn.innerText = JS_TEXTS.tutorialButtons.next[currentLang];
        btn.onclick = nextTutoStep;
    } else {
        btn.style.display = 'none';
    }
}

window.nextTutoStep = function() {
    if (tutoStep === 1) {
        markersLayer.zoomToShowLayer(currentTutoTarget.marker, () => {
            currentTutoTarget.marker.openPopup();
            setTimeout(() => {
                const lang = currentLang;

                updateTutoBox(JS_TEXTS.tuto2.title[lang], JS_TEXTS.tuto2.text[lang]);
                const btn = document.querySelector(`button[onclick*="lancerAnalyseComplete(${currentTutoTarget.id})"]`);
                if (btn) btn.classList.add('highlight-target');
            }, 1000);
        });
    }
    if (tutoStep === 3) {
        skipTuto();
    }
};

function startTutorialScenario() {
    console.log("SCÉNARIO TUTORIEL");
    const target = DATA.gares.find(g => g.nom.includes("Avignon Centre")) || DATA.gares[0];
    if (!target) return;
    currentTutoTarget = target;
    map.setView([46.6, 2.2], 6);
    const lang = currentLang;
    updateTutoBox(JS_TEXTS.tuto1.title[lang], JS_TEXTS.tuto1.text[lang], true);
    tutoStep = 1;
}

function checkTutoAdvancement(action) {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tuto') !== 'true') return;
    const lang = currentLang;
    if (action === 'analyse' && tutoStep === 1) {
        tutoStep = 2;
        setTimeout(() => {
            updateTutoBox(JS_TEXTS.tuto3.title[lang], JS_TEXTS.tuto3.text[lang]);
            const btn = document.querySelector(`button[onclick*="toggleWalkZone(${currentTutoTarget.id})"]`);
            if (btn) btn.classList.add('highlight-target');
        }, 800);
    }
    if (action === 'walk' && tutoStep === 2) {
        tutoStep = 3;
        setTimeout(() => {
            document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
            const searchBox = document.getElementById('searchBox');
            if (searchBox) searchBox.classList.add('highlight-target');
            const btn = document.getElementById('tutoBtn');
            btn.innerText = JS_TEXTS.tutorialButtons.finish[lang];
            btn.style.display = "inline-block";
            btn.onclick = skipTuto;
            updateTutoBox(JS_TEXTS.tuto4.title[lang], JS_TEXTS.tuto4.text[lang]);
        }, 1500);
    }
}

// ============================================================
// NOUVELLES FONCTIONS API - données écologiques
// AJOUTÉ : 02/01/2026
// ============================================================

/**
 * Charge et affiche la qualité de l'air pour une gare
 * @param {number} lat - Latitude
 * @param {number} lon - Longitude
 * @param {number} gareId - ID de la gare
 */
async function loadAirQuality(lat, lon, gareId) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/air-quality?lat=${lat}&lon=${lon}`);
        const result = await response.json();

        if (result.success && result.data.value !== null) {
            const airData = result.data;

            const container = document.getElementById('ecoDataContainer');

            // Initialise le container vide
            if (!container.dataset.hasData) {
                container.innerHTML = '';
                container.dataset.hasData = 'true';
            }

            // Utilise innerHTML += seulement après avoir vidé au premier chargement
            container.innerHTML += `
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-top:15px; border-left:4px solid ${airData.color};">
                    <h3 style="color:${airData.color}; margin-top:0;">
                        <i class="fa-solid fa-wind"></i> Qualité de l'Air
                    </h3>
                    <p style="font-size:1.2rem; font-weight:bold; color:white;">
                        ${airData.quality} - ${airData.value} ${airData.unit}
                    </p>
                    <small style="color:#94a3b8;">Station : ${airData.station}</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erreur chargement qualité air:', error);
        // UX: Display an error message in the panel if the API call fails.
        const airContainer = document.getElementById(`air-quality-${gareId}`);
        if (airContainer) {
            airContainer.innerHTML = `<p style="color:#ef4444">${JS_TEXTS.ecoPanel.error[currentLang]}</p>`;
        }
    }
}

/**
 * Charge et affiche la biodiversité locale pour une gare
 * @param {number} lat - Latitude
 * @param {number} lon - Longitude
 * @param {number} gareId - ID de la gare
 */
async function loadBiodiversity(lat, lon, gareId) {
    try {
        const response = await fetch(`${API_BASE_URL}/api/biodiversity?lat=${lat}&lon=${lon}&radius=5`);
        const result = await response.json();

        if (result.success && result.data.count > 0) {
            const bioData = result.data;

            const container = document.getElementById('ecoDataContainer');

            // Initialise le container vide si pas déjà fait
            if (!container.dataset.hasData) {
                container.innerHTML = '';
                container.dataset.hasData = 'true';
            }

            // Utilisation de innerHTML += pour empiler avec la qualité de l'air
            let speciesHtml = '';
            bioData.species.forEach(s => {
                if (s.photo) {
                    speciesHtml += `
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <img src="${s.photo}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
                            <div>
                                <strong style="color:white;">${s.name}</strong><br>
                                <small style="color:#94a3b8;">${s.scientificName}</small><br>
                                <small>${s.rarity}</small>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML += `
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-top:15px; border-left:4px solid #10b981;">
                    <h3 style="color:#10b981; margin-top:0;">
                        <i class="fa-solid fa-seedling"></i> Biodiversité Locale
                    </h3>
                    <p style="color:#cbd5e1; margin-bottom:15px;">
                        <strong>${bioData.count}</strong> espèces observées dans un rayon de 5 km
                    </p>
                    ${speciesHtml}
                </div>
            `;

            // Badge hotspot si >30 espèces
            if (bioData.count > 30) {
                container.innerHTML += `
                    <div style="background:#10b981; color:white; padding:10px; border-radius:8px; text-align:center; font-weight:bold; margin-top:10px;">
                        Hotspot Biodiversité !
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Erreur chargement biodiversité:', error);
        // UX: Display an error message in the panel if the API call fails.
        const bioContainer = document.getElementById(`biodiversity-${gareId}`);
        if (bioContainer) {
            bioContainer.innerHTML = `<p style="color:#ef4444">${JS_TEXTS.ecoPanel.error[currentLang]}</p>`;
        }
    }
}

// Fonction pour reset panneau éco quand on clique sur nouvelle gare
function resetEcoPanel() {
    const container = document.getElementById('ecoDataContainer');
    if (container) {
        container.innerHTML = '<p style="color:#94a3b8;">Chargement des données écologiques...</p>';
        container.dataset.initialized = 'false';
        container.dataset.hasData = 'false';
    }
}

// ============================================================
// NOUVELLES FONCTIONS UI - BOUTONS FEATURES
// AJOUTÉ : 02/01/2026 pour contrôles des nouvelles fonctionnalités
// ============================================================

/**
 * Toggle IGN Relief Layer
 * Bascule entre Google Satellite et carte topographique IGN
 */
let ignLayerActive = false;
let ignReliefLayer = null;
// Google Maps Standard au lieu d'IGN Relief
window.toggleIgnLayer = function() {
    const btn = document.getElementById('btnIgn');

    if (!ignReliefLayer) {
        // Carte Google Maps Standard (pas satellite)
        ignReliefLayer = L.tileLayer(
            'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                attribution: '© Google Maps',
                maxZoom: 20
            }
        );
    }

    if (!ignLayerActive) {
        map.removeLayer(googleSat);
        map.addLayer(ignReliefLayer);
        btn.classList.add('active');
        ignLayerActive = true;
        // FIX: Use translation from JS_TEXTS for toast message.
        showToast(JS_TEXTS.toast.googleMapsActive[currentLang]);
    } else {
        map.removeLayer(ignReliefLayer);
        map.addLayer(googleSat);
        btn.classList.remove('active');
        ignLayerActive = false;
        // FIX: Use translation from JS_TEXTS for toast message.
        showToast(JS_TEXTS.toast.satelliteActive[currentLang]);
    }
};

/**
 * Open Theme Selector Panel
 * Ouvre le panneau de sélection des Thèmes visuels
 */
window.openThemeSelector = function() {
    const panel = document.getElementById('themeSelectorPanel');
    panel.classList.toggle('active');
};

// Changement Thème VISIBLE sur tous les éléments
window.applyTheme = function(themeName) {
    const root = document.documentElement;

    // Suppression Thèmes forest, sunset et midnight
    const themes = {
        'default': {
            primary: '#10b981',
            secondary: '#3b82f6',
            bg: '#0f172a',
            bgLight: '#1e293b',
            text: '#ffffff'
        },
        'ocean': {
            primary: '#06b6d4',
            secondary: '#0284c7',
            bg: '#0c4a6e',
            bgLight: '#075985',
            text: '#e0f2fe'
        }
    };

    const theme = themes[themeName] || themes['default'];

    // Application des variables CSS
    root.style.setProperty('--primary', theme.primary);
    root.style.setProperty('--secondary', theme.secondary);
    root.style.setProperty('--dark', theme.bg);
    root.style.setProperty('--bg-light', theme.bgLight);
    root.style.setProperty('--text-color', theme.text);

    // Changement DIRECT des éléments visuels principaux
    const header = document.querySelector('.dashboard-header');
    if (header) {
        header.style.background = `rgba(${hexToRgb(theme.bg)}, 0.95)`;
        header.style.borderColor = `${theme.primary}30`;
    }

    const buttons = document.querySelectorAll('.btn-tool, .btn-analyse, .btn-walk');
    buttons.forEach(btn => {
        if (btn.classList.contains('active')) {
            btn.style.background = theme.primary;
        }
    });

    const statsPanel = document.querySelector('.stats-panel');
    if (statsPanel) {
        statsPanel.style.background = `rgba(${hexToRgb(theme.bg)}, 0.96)`;
        statsPanel.style.borderColor = `${theme.primary}50`;
    }

    const toast = document.getElementById('map-toast');
    if (toast) {
        toast.style.background = theme.bgLight;
        toast.style.borderColor = theme.primary;
    }

    // Thème Océan avec CartoDB Positron au lieu d'ArcGIS
    const mapThemes = {
        'default': googleSat,
        'ocean': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors © CARTO',
            maxZoom: 20,
            subdomains: 'abcd'
        })
    };

    if (!ignLayerActive) {
        map.eachLayer(l => {
            if (l instanceof L.TileLayer && l !== railsLayer) {
                map.removeLayer(l);
            }
        });
        map.addLayer(mapThemes[themeName] || googleSat);
    }

    localStorage.setItem('eco_theme', themeName);
    document.getElementById('themeSelectorPanel').classList.remove('active');
    // FIX: Use translation from JS_TEXTS for the toast message.
    showToast(`🎨 ${JS_TEXTS.toast.themeApplied[currentLang]}`);
};

// Helper pour conversion hex to RGB
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ?
        `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` :
        '15, 23, 42';
}

/**
 * Toggle Eco Panel
 * Affiche/masque le panneau d'informations écologiques avancées
 */
window.toggleEcoPanel = function() {
    const modal = document.getElementById('ecoPanelModal');
    modal.classList.toggle('active');
};

/**
 * Toggle Heatmap
 * Active/désactive la carte de chaleur temporelle (placeholder pour implémentation future)
 */
let heatmapActive = false;
window.toggleHeatmap = function() {
    const btn = document.getElementById('btnHeatmap');

    // NEW: Add translations for heatmap toasts to JS_TEXTS
    JS_TEXTS.toast.heatmapOn = {
        fr: "Carte de chaleur (bientôt disponible)",
        en: "Heatmap (coming soon)"
    };
    JS_TEXTS.toast.heatmapOff = {
        fr: "Carte de chaleur désactivée",
        en: "Heatmap deactivated"
    };

    if (!heatmapActive) {
        btn.classList.add('active');
        heatmapActive = true;
        // FIX: Use translation from JS_TEXTS for toast message.
        showToast(JS_TEXTS.toast.heatmapOn[currentLang]);
    } else {
        btn.classList.remove('active');
        heatmapActive = false;
        // FIX: Use translation from JS_TEXTS for toast message.
        showToast(JS_TEXTS.toast.heatmapOff[currentLang]);
    }
};

// Thème par défaut "co-Vert" (default)
const savedTheme = localStorage.getItem('eco_theme');
if (savedTheme) {
    applyTheme(savedTheme);
} else {
    // Premier chargement : applique Thème co-Vert par défaut
    applyTheme('default');
}

// ============================================================
// FIN DU FICHIER
// ============================================================


--- frontend\apropos.html ---

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Escapade | À propos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ¿</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="dashboard-header">
        <div class="brand"><h1>Eco-Escapade</h1></div>
        <div class="nav-links">
            <a href="index.html">Accueil</a>
            <a href="map.html">Carte</a>
            <a href="#" class="active">À propos</a>
            <a href="carnet.html">Mes favoris</a>
        </div>
        <div style="width: 80px;"></div> </div>

    <div class="container">
        <div class="hero-section">
            <div class="hero-title">À propos d'Eco-Escapade</div>
            <div class="hero-subtitle">Voyagez vert, choisissez mieux</div>
        </div>

        <section class="section-card">
            <h2><i class="fa-solid fa-lightbulb"></i> Concept du projet</h2>
            <p>Eco-Escapade est une application de webmapping universitaire conçue pour évaluer l'accessibilité écologique des gares SNCF en France. Notre objectif est simple : promouvoir la mobilité durable en mettant en lumière les gares les mieux connectées aux transports doux.</p>
            <p><strong>Vision :</strong> Faciliter les choix des éco-voyageurs et des étudiants soucieux de leur empreinte carbone en leur fournissant des données claires et transparentes.</p>
        </section>

        <section class="section-card">
            <h2><i class="fa-solid fa-calculator"></i> Méthodologie</h2>
            <p>Le cœur du projet repose sur un algorithme qui attribue un score écologique de 0 à 10 à chaque gare. Ce score est calculé dynamiquement en fonction des services de mobilité douce à proximité.</p>
            
            <h3>Formule de calcul :</h3>
            <div class="formula-box">
                Note = Bonus TGV (1pt) + Points Vélos (max 7pts) + Points Bornes (max 2pts) + Points Covoiturage (max 1pt)
                <br><br>
                - <strong>Vélos (10 min à pied) :</strong> 1 point par parking, plafonné à 7 points.
                <br>
                - <strong>Bornes IRVE (3km) :</strong> 0,5 point par borne, plafonné à 2 points.
                <br>
                - <strong>Covoiturage (3km) :</strong> 0,5 point par aire, plafonné à 1 point.
            </div>

            <h3>Échelle de notation :</h3>
            <div class="score-scale">
                <div class="scale-item scale-bad">0 - 4.9 : ❌ Potentiel limité</div>
                <div class="scale-item scale-mid">5 - 7.9 : 👍 Bon potentiel</div>
                <div class="scale-item scale-good">8 - 10 : ✅ Excellent</div>
            </div>
        </section>

        <section class="section-card">
            <h2><i class="fa-solid fa-database"></i> Sources de données</h2>
            <ul>
                <li><strong>API SNCF :</strong> Gares de voyageurs et tracé des lignes ferroviaires (WFS).</li>
                <li><strong>OpenDataSoft :</strong> Localisation des bornes de recharge électrique (IRVE) et aires de covoiturage.</li>
                <li><strong>OpenStreetMap :</strong> Base de données de plus de 200 000 parkings vélos en France.</li>
                <li><strong>Open-Meteo :</strong> Données météorologiques en temps réel pour chaque gare.</li>
                <li><strong>Wikipedia API :</strong> Récupération dynamique des photos des villes.</li>
            </ul>
        </section>

        <section class="section-card">
            <h2><i class="fa-solid fa-code"></i> Technologies utilisées</h2>
            <h3>Frontend</h3>
            <div class="tech-tags">
                <span class="tag frontend">Leaflet.js</span>
                <span class="tag frontend">MarkerCluster</span>
                <span class="tag frontend">OSM Buildings</span>
                <span class="tag frontend">HTML5 / CSS3</span>
                <span class="tag frontend">JavaScript ES6+</span>
            </div>
            
            <h3>Backend</h3>
            <div class="tech-tags">
                <span class="tag backend">Node.js</span>
                <span class="tag backend">Express</span>
                <span class="tag backend">Axios</span>
                <span class="tag backend">GeoJSON Caching</span>
            </div>
        </section>

        <section class="section-card">
            <h2><i class="fa-solid fa-user-graduate"></i> Crédits</h2>
            <p>Ce projet a été réalisé dans le cadre de la Licence Professionnelle GGAT (Géomatique et Géographie de l'Aménagement du Territoire) à l'IUT d'Auch.</p>
            <ul>
                <li><strong>Développeur :</strong> Étudiant LP GGAT</li>
                <li><strong>Année :</strong> 2025-2026</li>
            </ul>
        </section>
    </div>

    <a href="map.html" class="btn-float"><i class="fa-solid fa-map"></i> Retour à la carte</a>

</body>
</html>










--- frontend\carnet.html ---

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Escapade |
Tableau de Bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="red-alert" id="redAlert"></div>
    <div id="countdown-screen"></div>
    <div class="dashboard-header">
        <div class="brand"><h1>Eco-Escapade <span style="font-size:0.5em; vertical-align:super; color:#f59e0b;">ULTIMATE</span></h1></div>
        <div class="nav-links"><a href="map.html" id="nav-carte">Carte</a><a href="#" class="active" onclick="openOnboarding()" id="nav-aide">Aide</a></div>
        <button class="lang-switch" onclick="switchLangCarnet()">FR / EN</button>
    </div>
    <div class="container">
        <div class="top-section">
            <div class="titles"><h2 id="main-title" style="font-size: 
2.5rem; margin: 0;">Tableau de Bord</h2><p id="main-subtitle" style="color:#94a3b8; margin-top: 5px;">Gérez vos futures aventures bas carbone.</p></div>
            <div class="heatmap-container"><div id="miniMap"></div></div>
        </div>
        <div id="grid" class="card-grid"></div>
        <div id="empty" style="text-align: center;
color: #64748b; margin-top: 100px; display: none;"><i class="fa-solid fa-ghost" style="font-size: 3rem; margin-bottom: 20px;"></i><p id="empty-text">Aucune donnée.</p><a href="map.html" id="btn-scan" class="btn-main" style="width:200px;
margin: 20px auto;">Scanner la carte</a></div>
        <div class="danger-zone"><button id="btn-nuke" class="btn-nuke" onclick="openNukeModal()">⚠️ SÉQUENCE D’AUTODESTRUCTION</button></div>
    </div>
    <button id="vs-btn" onclick="openVsModal()"><i class="fa-solid fa-gavel"></i> <span id="btn-compare">COMPARER</span></button>
    <div id="toast" class="toast"><i class="fa-solid fa-circle-info" style="color:var(--primary)"></i><span id="toast-msg">Message</span></div>
    <div id="onboardingModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="onb-title" style="color:var(--primary);
font-size:1.8rem; margin-bottom:20px;">Bienvenue !</h3>
            <p id="onb-text" style="text-align:left; line-height:1.6;
color:#cbd5e1;">Voici votre carnet de voyage intelligent. Comparez deux gares, trouvez des images de la ville, générez un QR Code pour partager. Carte de situation en haut à droite.</p>
            <button id="onb-btn" class="btn-main" onclick="closeAll()" style="margin-top:20px;">C'est parti !</button>
        </div>
    </div>
    <div id="googlePhotosModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="google-title" id="google-title" style="margin-bottom:20px;
font-size:1.5rem; color:white;"><i class="fa-brands fa-wikipedia-w"></i> Images de la ville</h3>
            <p id="googleQuery" style="color:#94a3b8;
margin-bottom:15px; font-style:italic;"></p>
            <div class="google-grid" id="googleGrid"><div style="color:#94a3b8;
padding:20px;">Chargement des images...</div></div>
        </div>
    </div>
    <div id="qrModal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-modal" onclick="closeAll()"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="qr-title">Partager</h3>
            <div id="qrcode" style="margin: 20px auto;
width: 128px; background:white; padding:10px;"></div>
            <p id="qr-text" style="font-size:0.9rem;
color:#94a3b8;">Scannez pour ouvrir Google Maps</p>
        </div>
    </div>
    <div id="nukeModal" class="modal-overlay">
        <div class="modal-box" style="border: 2px solid #ef4444;
box-shadow: 0 0 50px rgba(239,68,68,0.3);">
            <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem;
color: #ef4444; margin-bottom: 20px;"></i>
            <h3 id="nuke-title" style="color: #ef4444;
font-size: 1.5rem;">ATTENTION</h3>
            <p id="nuke-text">Voulez-vous vraiment détruire tout le carnet ?</p>
            <div style="display: flex;
gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="nuke-no" onclick="closeAll()" style="padding: 10px 20px;
background: #334155; border:none; color:white; border-radius:8px; cursor:pointer;">Non</button>
                <button id="nuke-yes" onclick="startSelfDestruct()" style="padding: 10px 20px;
background: #ef4444; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">OUI, DETRUIRE</button>
            </div>
        </div>
    </div>
    <div id="deleteSingleModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="del-title" style="margin-bottom:15px;">Supprimer ce favori ?</h3>
            <p id="del-text" style="color:#94a3b8;
margin-bottom:20px;">Cette action est irréversible.</p>
            <div style="display: flex; gap: 10px;
justify-content: center;">
                <button id="del-no" onclick="closeAll()" style="padding: 10px 20px;
background: #334155; border:none; color:white; border-radius:8px; cursor:pointer;">Annuler</button>
                <button id="confirmDeleteBtn" style="padding: 10px 20px;
background: #ef4444; border:none; color:white; border-radius:8px; font-weight:bold; cursor:pointer;">Supprimer</button>
            </div>
        </div>
    </div>
    <div id="vsModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 700px;
background: linear-gradient(145deg, #1e293b, #0f172a);">
            <button class="close-modal" onclick="closeAll()">É—</button>
            <h2 id="vs-title" style="color:#f59e0b;
font-style:italic; font-size:2rem; margin-bottom:10px;">COMPARATEUR</h2>
            <div id="vsContent"></div>
        </div>
    </div>

    <script>
        const escapeHTML = (str) => str ? str.replace(/[&<>'"]/g, tag => ({ '&': '&', '<': '<', '>': '>', "'": "'", '"': '"' }[tag])) : '';

        // MODIFIÉ‰ : Variable langue dÉ©placÉ©e en haut pour Éªtre accessible dans render()
        let isFrCarnet = true;

        let favoris = JSON.parse(localStorage.getItem('eco_favoris')) || [];
        favoris = favoris.map(f => {
            if(f.score 
=== undefined) { 
                f.score = Math.floor(Math.random() * 50 + 50) / 10; 
                f.details = { velos: Math.floor(Math.random()*20), bornes: Math.floor(Math.random()*10), covoit: Math.floor(Math.random()*5) };
            }
            return f;
        });

        const grid = document.getElementById('grid');
   
     const empty = document.getElementById('empty');
        let selectedVs = []; 
        let itemToDeleteIndex = null;

        function render() {
            if (favoris.length === 0) { empty.style.display = 'block'; grid.innerHTML = '';
return; }
            favoris.sort((a,b) => (b.score||0) - (a.score||0));
grid.innerHTML = '';
            favoris.forEach((fav, index) => {
                const score = fav.score !== undefined ? fav.score : '?';
                const details = fav.details || { velos: 0, bornes: 0, covoit: 0 };
                let color = '#ef4444'; if(score >= 5) color = '#f59e0b'; if(score >= 8) color = '#10b981';
          
       const deg = (score !== '?' ? score : 0) * 36;
                const gradient = `conic-gradient(${color} ${deg}deg, #334155 0deg)`;
                const safeName = escapeHTML(fav.nom);

                const div = document.createElement('div');
                div.className = 'card';
     
           div.innerHTML = `
                    <input type="checkbox" id="chk-${index}" class="vs-checkbox-input" onchange="toggleVs(${index}, this)">
                    <label for="chk-${index}" class="vs-label"><i class="fa-solid fa-check"></i></label>
                    <div class="card-top"><div><span class="badge ${fav.type}">${fav.type}</span><h3>${safeName}</h3></div></div>
               
     <div class="score-row">
                        <div class="circle-wrap" style="background: ${gradient}"><div class="circle-inner">${score}</div></div>
                        <div class="stats-list">
                            <div class="stat-item"><i class="fa-solid fa-bicycle" style="color:#06b6d4;
width:20px;"></i> ${details.velos} ${isFrCarnet ? 'Vélos' : 'Bikes'}</div>
                            <div class="stat-item"><i class="fa-solid fa-plug" style="color:#f59e0b;
width:20px;"></i> ${details.bornes} ${isFrCarnet ? 'Bornes' : 'Terminals'}</div>
                            <div class="stat-item"><i class="fa-solid fa-car" style="color:#a855f7;
width:20px;"></i> ${details.covoit} ${isFrCarnet ? 'Covoit' : 'Carpool'}</div>
                        </div>
                    </div>
                    <a href="map.html?target=${fav.id}" class="btn-main"><i class="fa-solid fa-location-arrow"></i> <span class="txt-go">Y aller</span></a>
                    <div class="tools-grid">
      
                   <button class="tool-btn google" title="${isFrCarnet?'Photos':'Photos'}" onclick="openGooglePhotos('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-image"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'Google Maps':'Google Maps'}" onclick="openGoogleMaps('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-map-location-dot"></i></button>
                        <button class="tool-btn" title="${isFrCarnet?'QR Code':'QR Code'}" onclick="openQr('${safeName.replace(/'/g, "\\'")}')"><i class="fa-solid fa-qrcode"></i></button>
             
           <button class="tool-btn del" title="${isFrCarnet?'Supprimer':'Delete'}" onclick="askDelete(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
grid.appendChild(div);
            });
        }
        render();
if(favoris.length > 0) {
            setTimeout(() => {
                const miniMap = L.map('miniMap', { zoomControl:false, attributionControl:false }).setView([46.5, 2.5], 4);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(miniMap);
                favoris.forEach(f => {
                    const lat = 46 
+ (Math.random()-0.5)*5; 
                    const lon = 2 + (Math.random()-0.5)*5;
                    L.circleMarker([lat, lon], { radius:4, color:'#ef4444', fillOpacity:1, stroke:false }).addTo(miniMap);
                });
            }, 500);
}

        function showToast(msg) {
            const t = document.getElementById('toast');
document.getElementById('toast-msg').innerText = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }
        function closeAll() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}
        function openModal(id) { document.getElementById(id).classList.add('active');
}

        async function openGooglePhotos(nom) {
            let cleanCity = nom.split(' - ')[0].replace(/Gare de\s?/gi, '').replace(/TGV/gi, '').replace(/Centre/gi, '').trim();
document.getElementById('googleQuery').innerText = `${isFrCarnet ? 'Recherche pour :' : 'Search for:'} "${cleanCity}"`;
            openModal('googlePhotosModal');
            const grid = document.getElementById('googleGrid');
            // MODIFIÉ‰ : Utilisation de translationsCarnet
            grid.innerHTML = `<div style="color:#94a3b8; padding:20px;">${isFrCarnet ? translationsCarnet.imgLoad.fr : translationsCarnet.imgLoad.en}</div>`;
try {
                const url = `https://fr.wikipedia.org/w/api.php?action=query&titles=${cleanCity}&prop=pageimages&format=json&pithumbsize=600&origin=*`;
const r = await fetch(url);
                const d = await r.json();
                const pages = d.query.pages;
                const pid = Object.keys(pages)[0];
if (pid !== "-1" && pages[pid].thumbnail) {
                    const imgSrc = pages[pid].thumbnail.source;
grid.innerHTML = `<img src="${imgSrc}" class="google-pic">`;
                } else {
                    grid.innerHTML = `<div style="color:#ef4444; padding:20px;">${isFrCarnet ? translationsCarnet.imgError.fr : translationsCarnet.imgError.en}</div>`;
}
            } catch(e) {
                grid.innerHTML = `<div style="color:#ef4444; padding:20px;">${isFrCarnet ? translationsCarnet.conError.fr : translationsCarnet.conError.en}</div>`;
}
        }

        // FIX: Removed extra "$" before template interpolation which produced malformed URLs
        window.openGoogleMaps = (nom) => { window.open(`https://www.google.com/maps/search/?api=1&query=Gare+${encodeURIComponent(nom.replace(/Gare de\s?/gi, ''))}`);
    };
        window.openQr = (nom) => {
            const container = document.getElementById('qrcode');
container.innerHTML = '';
            // FIX: QR Code URL must not contain stray "$" before interpolation
            new QRCode(container, { text: `https://www.google.com/maps/search/?api=1&query=Gare+${encodeURIComponent(nom)}`, width: 128, height: 128 });
            openModal('qrModal');
        };
window.askDelete = (index) => { itemToDeleteIndex = index; openModal('deleteSingleModal'); };
document.getElementById('confirmDeleteBtn').onclick = () => {
            if(itemToDeleteIndex !== null) {
                favoris.splice(itemToDeleteIndex, 1);
localStorage.setItem('eco_favoris', JSON.stringify(favoris));
                // MODIFIÉ‰ : Toast traduit
                render(); closeAll(); showToast(isFrCarnet ? translationsCarnet.toastDel.fr : translationsCarnet.toastDel.en);
            }
        };
window.toggleVs = (index, checkbox) => {
            if (checkbox.checked) {
                if (selectedVs.length >= 2) { checkbox.checked = false;
// MODIFIÉ‰ : Toast traduit
showToast(isFrCarnet ? translationsCarnet.toastMax.fr : translationsCarnet.toastMax.en); return; }
                selectedVs.push(index);
} else {
                selectedVs = selectedVs.filter(i => i !== index);
}
            const btn = document.getElementById('vs-btn');
if (selectedVs.length === 2) btn.classList.add('visible');
            else btn.classList.remove('visible');
        };

        window.openVsModal = () => {
            const f1 = favoris[selectedVs[0]];
const f2 = favoris[selectedVs[1]];
            const winner = (v1, v2) => v1 > v2 ?
'val-win' : (v1 < v2 ? 'val-lose' : '');
            
            // MODIFIÉ‰ : Labels dynamiques pour la modale VS
            const lblScore = isFrCarnet ? "SCORE GLOBAL" : "GLOBAL SCORE";
            const lblVelos = isFrCarnet ? "VÉLOS" : "BIKES";
            const lblBornes = isFrCarnet ? "BORNES" : "TERMINALS";
            const lblCovoit = isFrCarnet ? "COVOIT'" : "CARPOOL";

            document.getElementById('vsContent').innerHTML = `
                <table class="vs-table">
                    <thead><tr><th style="width:40%; font-size:1.1rem; color:white;">${escapeHTML(f1.nom)}</th><th style="width:20%;">VS</th><th style="width:40%; font-size:1.1rem; color:white;">${escapeHTML(f2.nom)}</th></tr></thead>
                    <tbody>
                        <tr><td 
class="${winner(f1.score, f2.score)}" style="font-size:1.5rem;">${f1.score}</td><td style="color:#94a3b8; font-size:0.8rem;">${lblScore}</td><td class="${winner(f2.score, f1.score)}" style="font-size:1.5rem;">${f2.score}</td></tr>
                        <tr><td class="${winner(f1.details.velos, f2.details.velos)}">${f1.details.velos}</td><td style="color:#94a3b8; font-size:0.8rem;">${lblVelos}</td><td class="${winner(f2.details.velos, f1.details.velos)}">${f2.details.velos}</td></tr>
                        <tr><td class="${winner(f1.details.bornes, f2.details.bornes)}">${f1.details.bornes}</td><td style="color:#94a3b8;
font-size:0.8rem;">${lblBornes}</td><td class="${winner(f2.details.bornes, f1.details.bornes)}">${f2.details.bornes}</td></tr>
                        <tr><td class="${winner(f1.details.covoit, f2.details.covoit)}">${f1.details.covoit}</td><td style="color:#94a3b8;
font-size:0.8rem;">${lblCovoit}</td><td class="${winner(f2.details.covoit, f1.details.covoit)}">${f2.details.covoit}</td></tr>
                    </tbody>
                </table>
            `;
            openModal('vsModal');
        };

        window.openNukeModal = () => document.getElementById('nukeModal').classList.add('active');
        window.startSelfDestruct = () => {
      
      closeAll();
            document.body.classList.add('shaking'); document.getElementById('redAlert').classList.add('active'); 
            const screen = document.getElementById('countdown-screen');
            screen.style.display = 'flex';
            let count = 5; screen.innerHTML = count;
            const timer = setInterval(() => {
                
count--; screen.innerHTML = count;
                // MODIFIÉ‰ : Traduction PURGE COMPLETE
                if(count <= 0) { clearInterval(timer); screen.innerHTML = isFrCarnet ? "PURGE TERMINÉE" : "PURGE COMPLETE"; localStorage.removeItem('eco_favoris'); setTimeout(() => location.reload(), 2000); } // FIX: Changed French text for better localization.
            }, 1000);
        };
window.openOnboarding = () => document.getElementById('onboardingModal').classList.add('active');
        if(!localStorage.getItem('visited_carnet_final')) { setTimeout(openOnboarding, 1000); localStorage.setItem('visited_carnet_final', 'true');
}
        
const translationsCarnet = {
            navCarte: { fr: "Carte", en: "Map" }, navAide: { fr: "Aide", en: "Help" }, mainTitle: { fr: "Tableau de Bord", en: "Dashboard" }, mainSub: { fr: "Gérez vos futures aventures bas carbone.", en: "Manage your future low-carbon adventures." }, emptyText: { fr: "Aucune donnée.", en: "No data." }, btnScan: { fr: "Scanner la carte", en: "Scan map" }, btnNuke: { fr: "⚠️ SÉQUENCE D’AUTODESTRUCTION", en: "⚠️ SELF-DESTRUCT SEQUENCE" }, btnCompare: { fr: "COMPARER", en: "COMPARE" }, onbTitle: { fr: "Bienvenue !", en: "Welcome!" }










--- frontend\index.html ---

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Escapade | L'Aventure Bas Carbone</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>%F0%9F%8C%BF</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #10b981; --dark: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #000; color: white; overflow: hidden; height: 100vh; position: relative; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.8s ease; }
        .bike-loader { font-size: 3rem; color: var(--primary); animation: ride 1s infinite alternate; }
        .loading-bar-container { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden; }
        .loading-bar { height: 100%; width: 0; background: var(--primary); transition: width 0.2s; }
        @keyframes ride { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-10px) rotate(5deg); } }
        .video-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; opacity: 0.6; filter: brightness(0.5); }
        .nav { position: fixed; top: 40px; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 5%; z-index: 100; }
        .logo { font-family: 'Space Grotesk', sans-serif; font-size: 2rem; font-weight: 900; color: white; cursor: pointer; }
        .logo span { color: var(--primary); }
        .lang-switch { background: var(--glass); padding: 8px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; font-weight: bold; color: white; transition: 0.3s; font-family: 'Inter', sans-serif; }
        .lang-switch:hover { background: var(--primary); color: #000; border-color: var(--primary); }
        .hero { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 0 20px; }
        .hero-title { font-size: 5rem; font-weight: 900; margin-bottom: 10px; line-height: 1.1; text-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hero-typewriter { font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; font-family: 'Space Grotesk', monospace; min-height: 2.5rem; text-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        .cursor-blink { animation: blink 1s infinite; border-right: 3px solid white; margin-left: 5px; }
        @keyframes blink { 50% { opacity: 0; } }
        .hero-subtitle { font-size: 1.1rem; color: #cbd5e1; margin-bottom: 40px; max-width: 700px; line-height: 1.6; font-family: 'Inter', sans-serif; font-weight: 400; background: rgba(0,0,0,0.5); padding: 15px 25px; border-radius: 12px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .actions-row { display: flex; gap: 20px; margin-top: 10px; justify-content: center; }
        .cta-btn { padding: 16px 45px; font-size: 1.2rem; font-weight: 800; color: #000; background: var(--primary); border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(16, 185, 129, 0.3); text-decoration: none; display: inline-flex; align-items: center; gap: 10px; }
        .cta-btn:hover { background: #34d399; box-shadow: 0 0 40px rgba(16, 185, 129, 0.5); transform: translateY(-2px); }
        .transition-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 0%; background: var(--primary); z-index: 99999; transition: height 0.8s cubic-bezier(0.77, 0, 0.175, 1); bottom: 0; }
        .transition-overlay.active { height: 100%; }
        .easter-train { position: fixed; bottom: 50px; left: -200px; font-size: 4rem; transition: left 3s linear; z-index: 50; opacity: 0; }
        .easter-train.choo-choo { left: 120vw; opacity: 1; }
    </style>
</head>
<body>
    <div class="transition-overlay" id="transitionLayer"></div>
    <div id="loader"><i class="fa-solid fa-bicycle bike-loader"></i><div class="loading-bar-container"><div class="loading-bar" id="loadBar"></div></div><p style="margin-top: 15px; font-family: monospace; color: #64748b;">Chargement des données...</p></div>
    <video class="video-bg" autoplay muted loop playsinline><source src="https://www.pexels.com/fr-fr/download/video/2402356/" type="video/mp4"></video>
    <nav class="nav"><div class="logo-box" onclick="triggerEasterEgg()"><div class="logo">Eco<span>-</span>Escapade</div></div><button class="lang-switch" onclick="switchLang()">FR / EN</button></nav>
    <div class="easter-train" id="train">🚂🚃🚃🚃</div>
    <div class="hero">
        <h1 class="hero-title">Voyagez Mieux.</h1>
        <div class="hero-typewriter"><span id="typewriter"></span><span class="cursor-blink"></span></div>
        <div class="hero-subtitle">L'outil idéal pour choisir la gare la plus optimisée écologiquement.</div>
        <div class="actions-row"><a href="#" class="cta-btn" onclick="startAdventure(event)">COMMENCER <i class="fa-solid fa-arrow-right"></i></a></div>
    </div>
    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
        const bar = document.getElementById('loadBar');
        let width = 0;
        const loadInt = setInterval(() => {
            width += Math.random() * 15;
            if(width > 100) width = 100;
            bar.style.width = width + '%';
            if(width === 100) {
                clearInterval(loadInt);
                setTimeout(() => { document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').remove(), 800); }, 400);
            }
        }, 100);

        // PrÉ©-chargement silencieux
        fetch(`${API_BASE}/api/gares`).catch(e => console.log("API OFF"));

        const textElement = document.getElementById('typewriter');
        const phrasesFr = ["Voyagez...", "Respirez...", "Découvrez...", "Préservez..."];
        const phrasesEn = ["Travel...", "Breathe...", "Discover...", "Preserve..."];
        let currentPhrases = phrasesFr;
        let phraseIndex = 0; let charIndex = 0; let isDeleting = false; let typeTimer;

        function type() {
            const currentPhrase = currentPhrases[phraseIndex];
            textElement.innerText = isDeleting ? currentPhrase.substring(0, charIndex - 1) : currentPhrase.substring(0, charIndex + 1);
            charIndex = isDeleting ? charIndex - 1 : charIndex + 1;
            let typeSpeed = isDeleting ? 50 : 100;
            if (!isDeleting && charIndex === currentPhrase.length) { typeSpeed = 2000; isDeleting = true; }
            else if (isDeleting && charIndex === 0) { isDeleting = false; phraseIndex = (phraseIndex + 1) % currentPhrases.length; typeSpeed = 500; }
            typeTimer = setTimeout(type, typeSpeed);
        }
        type();

        let clicks = 0;
        function triggerEasterEgg() { clicks++; if(clicks === 5) { document.getElementById('train').classList.add('choo-choo'); setTimeout(() => { document.getElementById('train').classList.remove('choo-choo'); clicks = 0; }, 4000); } }

        function startAdventure(e) { e.preventDefault(); document.getElementById('transitionLayer').classList.add('active'); setTimeout(() => { window.location.href = 'map.html?tuto=true'; }, 800); }
        
        let isFr = true;
        const translations = { title: { fr: "Voyagez Mieux.", en: "Travel Better." }, subtitle: { fr: "L'outil idéal pour choisir la gare la plus optimisée écologiquement.", en: "The ideal tool to choose the most ecologically optimized station." }, cta: { fr: 'COMMENCER <i class="fa-solid fa-arrow-right"></i>', en: 'START <i class="fa-solid fa-arrow-right"></i>' } };
        
        function switchLang() {
            isFr = !isFr;
            document.querySelector('.hero-title').innerText = isFr ? translations.title.fr : translations.title.en;
            document.querySelector('.hero-subtitle').innerText = isFr ? translations.subtitle.fr : translations.subtitle.en;
            document.querySelector('.cta-btn').innerHTML = isFr ? translations.cta.fr : translations.cta.en;
            clearTimeout(typeTimer); currentPhrases = isFr ? phrasesFr : phrasesEn; phraseIndex = 0; charIndex = 0; isDeleting = false; textElement.innerText = ''; type();
        }
    </script>
</body>
</html>











--- frontend\map.html ---

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Escapade | Carte Interactive</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>%F0%9F%8C%BF</text></svg>">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="map-loader">
        <i class="fa-solid fa-bicycle bike-loader"></i>
        <div class="loading-bar-container"><div class="loading-bar" id="loadBar" style="width: 100%;"></div></div>
        <p class="loading-text" id="loader-msg">Chargement de la carte...</p>
    </div>

    <div id="tutoBox" class="tuto-box">
        <div id="tutoTitle" class="tuto-title">TUTORIEL</div>
        <div id="tutoText" class="tuto-text"></div>
        <button id="tutoBtn" class="tuto-btn" onclick="nextTutoStep()">SUIVANT ➡️</button>
        <button class="tuto-skip-btn" onclick="skipTuto()">Passer le tuto</button>
    </div>

    <div class="dashboard-header">
        <div class="brand"><h1>Eco-Escapade</h1></div>
        <div class="nav-links">
            <a href="index.html" id="nav-home">Accueil</a>
            <a href="carnet.html" id="nav-fav">Mes favoris</a>
            <a href="apropos.html" id="nav-apropos">À propos</a>
        </div>
        <div class="search-container" id="searchBox">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" id="search-input" list="gares-list" placeholder="Rechercher..." autocomplete="off">
            <datalist id="gares-list"></datalist>
        </div>
        <div class="actions">
            <button class="btn-discover" onclick="openDiscoverModal()"><i class="fa-solid fa-compass"></i> <span id="btn-discover-text">DÉCOUVRIR</span></button>
            <button id="btnStats" class="btn-discover" style="background: linear-gradient(135deg, #3b82f6, #2563eb); margin-right: 5px;"><i class="fa-solid fa-chart-column"></i> STATS</button>
            <button class="btn-tool" title="Me Localiser" onclick="map.locate({setView: true, maxZoom: 12})"><i class="fa-solid fa-location-arrow"></i></button>
            <button id="btnRandomGare" class="btn-tool" title="Gare Aléatoire" onclick="randomGare()"><i class="fa-solid fa-dice"></i></button>
            
            <button id="btnHeatmap" class="btn-tool" onclick="toggleHeatmap()" title="Carte de chaleur affluence" style="display:none;">
                <i class="fa-solid fa-fire"></i>
            </button>
            <button id="btnIgn" class="btn-tool" onclick="toggleIgnLayer()" title="Carte topographique IGN">
                <i class="fa-solid fa-mountain"></i>
            </button>
            <button id="btnThemes" class="btn-tool" onclick="openThemeSelector()" title="Changer le thème">
                <i class="fa-solid fa-palette"></i>
            </button>
            <button id="btnEcoInfo" class="btn-tool" onclick="toggleEcoPanel()" title="Infos écologiques avancées">
                <i class="fa-solid fa-leaf"></i>
            </button>

            <button class="lang-switch" onclick="switchLangMap()">FR / EN</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="discoverModal" class="discover-modal">
        <div class="discover-content">
            <button onclick="closeDiscover()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:white; font-size:2rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            <h2 id="discoverTitle" style="color:white; font-size:2.5rem; margin-bottom:10px;">Envie de partir quelque part ?</h2>
            <p id="discoverSubtitle" style="color:#94a3b8;">Choisissez un environnement, le site trouve pour vous les gares les plus écologiques.</p>
            <button id="btnBackCat" onclick="resetDiscover()" style="display:none; background:transparent; color:var(--primary); border:1px solid var(--primary); padding:8px 15px; border-radius:20px; cursor:pointer; margin-bottom:20px;">← Choisir un autre environnement</button>
            
            <div id="catGrid" class="cat-grid">
                <div class="cat-card" onclick="showCategory('mer', 'Mer & Plages')"><h3 id="cat-mer">Mer Méditerranée</h3></div>
                <div class="cat-card" onclick="showCategory('ocean', 'Océan & Vagues')"><h3 id="cat-ocean">Océan Atlantique</h3></div>
                <div class="cat-card" onclick="showCategory('montagne', 'Montagne & Neige')"><h3 id="cat-montagne">Montagne</h3></div>
                <div class="cat-card" onclick="showCategory('ville', 'Grandes Métropoles')"><h3 id="cat-ville">Grandes Villes</h3></div>
                <div class="cat-card" onclick="showCategory('paris', 'Capitale')"><h3 id="cat-paris">Paris</h3></div>
                <div class="cat-card" onclick="showCategory('sud', 'Le Sud')"><h3 id="cat-sud">Le Sud</h3></div>
                <div class="cat-card" onclick="showCategory('nord', 'Le Nord')"><h3 id="cat-nord">Le Nord</h3></div>
            </div>

            <div id="resultsContainer" class="results-container"></div>
        </div>
    </div>

    <div id="statsPanel" class="stats-panel">
        <div class="stats-header">
           <h2 id="stats-title">Tableau de bord national</h2>
           <button id="closeStats" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><span class="stat-label" id="lbl-gares">Gares analysées</span><span class="stat-value" id="stat-gares">–</span></div>
            <div class="stat-card"><span class="stat-label" id="lbl-score">Score moyen écolo</span><span class="stat-value" id="stat-score">–</span></div>
            <div class="stat-card"><span class="stat-label" id="lbl-tgv">Part TGV</span><span class="stat-value" id="stat-tgv">â€“</span></div>
            <div class="stat-card"><span class="stat-label" id="lbl-velos">Moyenne parkings vélos</span><span class="stat-value" id="stat-velos">–</span></div>
            <div class="stat-card"><span class="stat-label" id="lbl-bornes">Moyenne bornes IRVE</span><span class="stat-value" id="stat-bornes">â€“</span></div>
            <div class="stat-card"><span class="stat-label" id="lbl-covoit">Moyenne aires covoit'</span><span class="stat-value" id="stat-covoit">–</span></div>
        </div>
    </div>

    <div id="themeSelectorPanel">
        <div class="theme-option theme-default" onclick="applyTheme('default')">Eco-Vert</div>
        <div class="theme-option theme-ocean" onclick="applyTheme('ocean')">Océan</div>
    </div>

    <div id="ecoPanelModal">
        <div class="eco-panel-content">
            <button onclick="toggleEcoPanel()" style="float:right; background:transparent; border:none; color:white; font-size:1.5rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="color:var(--primary); margin-top:0;">
                <i class="fa-solid fa-leaf"></i> Informations écologiques avancées
            </h2>
            <div id="ecoDataContainer">
                <p style="color:#94a3b8;">Sélectionnez une gare sur la carte pour voir ses données écologiques détaillées (qualité de l'air, biodiversité, arbres urbains).</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-easyprint/2.1.9/bundle.js"></script>
    <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings-Leaflet.js"></script>
    <script src="app.js"></script> 
    
 
    <script>
        let isFrMap = true;
        const translationsMap = {
            navHome: { fr: "Accueil", en: "Home" },
            navFav: { fr: "Mes favoris", en: "My Favorites" },
            navApropos: { fr: "À propos", en: "About" },
            search: { fr: "Rechercher...", en: "Search..." },
            btnDiscover: { fr: "DÉCOUVRIR", en: "DISCOVER" },
            discTitle: { fr: "Envie de partir quelque part ?", en: "Want to go somewhere?" },
            discSub: { fr: "Choisissez un environnement, le site trouve pour vous les gares les plus écologiques.", en: "Choose an environment, the site finds the most eco-friendly stations for you." },
            btnBack: { fr: "← Choisir un autre environnement", en: "← Choose another environment" },
            catMer: { fr: "Mer Méditerranée", en: "Mediterranean Sea" },
            catOcean: { fr: "Océan Atlantique", en: "Atlantic Ocean" },
            catMontagne: { fr: "Montagne", en: "Mountain" },
            catVille: { fr: "Grandes Métropoles", en: "Major Metropolises" },
            catParis: { fr: "Paris", en: "Paris" },
            catSud: { fr: "Le Sud", en: "The South" },
            catNord: { fr: "Le Nord", en: "The North" },
            catNature: { fr: "Nature", en: "Nature" },
            tutoNext: { fr: "SUIVANT ➡️", en: "NEXT ➡️" },
            tutoSkip: { fr: "Passer le tuto", en: "Skip tutorial" },
            
            // --- NEW STATS & LOADER TRANSLATIONS ---
            loader: { fr: "Chargement de la carte...", en: "Loading map..." },
            statsTitle: { fr: "Tableau de bord national", en: "National Dashboard" },
            lblGares: { fr: "Gares analysées", en: "Analyzed stations" },
            lblScore: { fr: "Score moyen écolo", en: "Avg Eco Score" },
            lblTgv: { fr: "Part TGV", en: "TGV Share" },
            lblVelos: { fr: "Moyenne parkings vélos", en: "Avg Bike Parking" },
            lblBornes: { fr: "Moyenne bornes IRVE", en: "Avg Charging St." },
            lblCovoit: { fr: "Moyenne aires covoit'", en: "Avg Carpool Areas" }
        };
        function switchLangMap() {
            isFrMap = !isFrMap;
            const t = translationsMap;
            document.getElementById('nav-home').innerText = isFrMap ? t.navHome.fr : t.navHome.en;
            document.getElementById('nav-fav').innerText = isFrMap ? t.navFav.fr : t.navFav.en;
            document.getElementById('nav-apropos').innerText = isFrMap ? t.navApropos.fr : t.navApropos.en;
            document.getElementById('search-input').placeholder = isFrMap ? t.search.fr : t.search.en;
            document.getElementById('btn-discover-text').innerText = isFrMap ? t.btnDiscover.fr : t.btnDiscover.en;
            document.getElementById('discoverTitle').innerText = isFrMap ? t.discTitle.fr : t.discTitle.en;
            document.getElementById('discoverSubtitle').innerText = isFrMap ? t.discSub.fr : t.discSub.en;
            document.getElementById('btnBackCat').innerText = isFrMap ? t.btnBack.fr : t.btnBack.en;
            document.getElementById('cat-mer').innerText = isFrMap ? t.catMer.fr : t.catMer.en;
            document.getElementById('cat-ocean').innerText = isFrMap ? t.catOcean.fr : t.catOcean.en;
            document.getElementById('cat-montagne').innerText = isFrMap ? t.catMontagne.fr : t.catMontagne.en;
            document.getElementById('cat-ville').innerText = isFrMap ? t.catVille.fr : t.catVille.en;
            document.getElementById('cat-paris').innerText = isFrMap ? t.catParis.fr : t.catParis.en;
            document.getElementById('cat-sud').innerText = isFrMap ? t.catSud.fr : t.catSud.en;
            document.getElementById('cat-nord').innerText = isFrMap ? t.catNord.fr : t.catNord.en;
            
            document.getElementById('tutoBtn').innerText = isFrMap ? t.tutoNext.fr : t.tutoNext.en;
            document.querySelector('.tuto-skip-btn').innerText = isFrMap ? t.tutoSkip.fr : t.tutoSkip.en;
            
            // --- UPDATING STATS & LOADER ---
            document.getElementById('loader-msg').innerText = isFrMap ? t.loader.fr : t.loader.en;
            document.getElementById('stats-title').innerText = isFrMap ? t.statsTitle.fr : t.statsTitle.en;
            document.getElementById('lbl-gares').innerText = isFrMap ? t.lblGares.fr : t.lblGares.en;
            document.getElementById('lbl-score').innerText = isFrMap ? t.lblScore.fr : t.lblScore.en;
            document.getElementById('lbl-tgv').innerText = isFrMap ? t.lblTgv.fr : t.lblTgv.en;
            document.getElementById('lbl-velos').innerText = isFrMap ? t.lblVelos.fr : t.lblVelos.en;
            document.getElementById('lbl-bornes').innerText = isFrMap ? t.lblBornes.fr : t.lblBornes.en;
            document.getElementById('lbl-covoit').innerText = isFrMap ? t.lblCovoit.fr : t.lblCovoit.en;

            if (window.updateAppLanguage) window.updateAppLanguage(isFrMap);
        }
    </script>
</body>
</html>












--- frontend\style.css ---

:root { --primary: #10b981; --secondary: #3b82f6; --dark: #0f172a; --bg: #0b0b0b; --card-bg: #1e293b; }
body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: white; overflow-x: hidden; }

.lang-switch {
    background: rgba(255,255,255,0.1);
    padding: 5px 15px;
    border-radius: 30px;
    border: 1px solid rgba(255,255,255,0.2);
    cursor: pointer;
    font-weight: bold;
    color: white;
    transition: 0.3s;
    font-family: 'Inter', sans-serif;
    font-size: 0.8rem;
}
.lang-switch:hover { background: var(--primary); color: #000; border-color: var(--primary); }

/* HEADER IDENTIQUE A CARNET.HTML */
.dashboard-header { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 96%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); padding: 12px 30px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
.brand h1 { margin: 0; font-size: 1.4rem; font-weight: 800; color: var(--primary); }
.nav-links a { text-decoration: none; color: #cbd5e1; font-weight: 600; margin-left: 20px; transition:0.3s; cursor: pointer; }
.nav-links a:hover, .nav-links a.active { color: var(--primary); }

/* CONTENU PAGE A PROPOS */
.container { max-width: 900px; margin: 120px auto 60px; padding: 0 20px; animation: fadeIn 0.8s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.section-card { background: var(--card-bg); border-radius: 20px; padding: 40px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
h2 { color: var(--primary); font-size: 1.8rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
h3 { color: white; margin-top: 25px; font-size: 1.2rem; }
p, li { color: #cbd5e1; line-height: 1.7; font-size: 1rem; }
ul { list-style-type: none; padding: 0; }
li { margin-bottom: 10px; padding-left: 20px; position: relative; }
li::before { content: "âž”"; color: var(--primary); position: absolute; left: 0; }

.hero-section { text-align: center; margin-bottom: 50px; }
.hero-title { font-size: 3rem; font-weight: 900; margin-bottom: 10px; background: linear-gradient(135deg, #fff, #94a3b8); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
.hero-subtitle { font-size: 1.2rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 2px; }

.formula-box { background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; border-left: 4px solid var(--secondary); margin: 20px 0; font-family: monospace; color: #60a5fa; font-size: 0.95rem; }

.tech-tags { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
.tag { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; color: white; border: 1px solid rgba(255,255,255,0.1); }
.tag.backend { border-color: #f59e0b; color: #f59e0b; }
.tag.frontend { border-color: #3b82f6; color: #3b82f6; }

.btn-float { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: #022c22; padding: 15px 25px; border-radius: 50px; font-weight: 800; text-decoration: none; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4); transition: 0.3s; z-index: 1000; display: flex; align-items: center; gap: 10px; }
.btn-float:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(16, 185, 129, 0.6); background: white; color: var(--primary); }

.score-scale { display: flex; gap: 10px; margin-top: 15px; }
.scale-item { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-weight: bold; font-size: 0.9rem; }
.scale-bad { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.scale-mid { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.scale-good { background: rgba(16, 185, 129, 0.2); color: #10b981; }

/* ============================================================ */
/* STYLES DYNAMIQUES DEPUIS APP.JS                            */
/* ============================================================ */

/* PINS & UI DYNAMIQUES (ComplÉ©ment du CSS HTML) */
.marker-pin { width: 30px;
height: 30px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px;
border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; transition: all 0.3s ease;
}
    .marker-pin:hover { transform: rotate(-45deg) scale(1.3); z-index:999; box-shadow: 0 0 20px var(--primary);
}
    .marker-pin i { transform: rotate(45deg); font-size: 14px;
margin-top: 2px;}
    
    .tgv { background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}
    .ter { background: linear-gradient(135deg, #10b981, #047857); }
    .irve { background: linear-gradient(135deg, #f59e0b, #d97706);
} 
    .covoit { background: linear-gradient(135deg, #a855f7, #7e22ce);
} 
    .velo { background: linear-gradient(135deg, #06b6d4, #0891b2); } 

    .custom-cluster { width: 40px;
height: 40px; border-radius: 50%; color: white; font-weight: 800; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center;
border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
    .cluster-gare { background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}
    .cluster-irve { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .cluster-covoit { background: linear-gradient(135deg, #a855f7, #7e22ce);
}
    .cluster-velo { background: linear-gradient(135deg, #06b6d4, #0891b2); }

    .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0;
overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .leaflet-popup-content { margin: 0; width: 300px !important;
}
    
    .photo-container { height: 160px; width: 100%; overflow: hidden; position: relative; background: #cbd5e1;
}
    .city-photo { width: 100%; height: 100%; object-fit: cover; display: block; opacity: 0; transition: opacity 0.5s;
}
    .city-photo.loaded { opacity: 1; }

    .weather-box { display: flex; justify-content: space-between; align-items: center;
background: #0f172a; color: white; padding: 8px 15px; font-size: 0.8rem; font-weight: 600; border-bottom: 3px solid #3b82f6;
}
    .weather-item { display: flex; align-items: center; gap: 6px; }
    .weather-icon { color: #3b82f6;
font-size: 0.9rem; }

    /* STYLES POPUPS MODIFIÉ‰S */
    .simple-popup-header { padding: 15px; color: white; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
    .header-irve { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .header-covoit { background: linear-gradient(135deg, #a855f7, #7e22ce); }
    .simple-popup-body { padding: 15px; background: #f8fafc; color: #334155; }
    .simple-popup-body div { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .simple-popup-body .btn-maps { display: block; width: 100%; text-align: center; margin-top: 15px; background: #cbd5e1; color: #1e293b; padding: 8px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 0.8rem; transition: 0.2s; }
    .simple-popup-body .btn-maps:hover { background: #94a3b8; color: white; }

    .location-popup { font-family: 'Inter', sans-serif; text-align: center; }
    .location-header { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .location-body { padding: 20px; background: #f0fdf4; color: #166534; }
    .location-btn { background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; transition: 0.2s; box-shadow: 0 4px 10px rgba(16,185,129,0.3); }
    .location-btn:hover { background: #059669; transform: translateY(-2px); }

    .analyse-container { font-family: 'Inter', sans-serif; text-align: left; margin-top: 15px; padding-top: 15px;
border-top: 1px solid #e2e8f0; }
    .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9em; color: #475569;
}
    .progress-bg { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: 10px;
}
    .progress-fill { height: 100%; border-radius: 4px; transition: width 1s ease-in-out;
}

    .visible-counter { position: absolute; top: 90px; right: 10px; z-index: 1000; background: rgba(15, 23, 42, 0.9);
backdrop-filter: blur(5px); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; color: #10b981;
font-size: 0.85rem; display: flex; align-items: center; gap: 8px; pointer-events: none;
}
    
    .fav-btn { cursor: pointer; transition: 0.2s; font-size: 1.3rem;
}
    .fav-active { color: #ef4444; } .fav-inactive { color: #cbd5e1;
}

    .btn-walk { width: 100%; margin-top: 8px; background: white; color: #10b981; border: 2px solid #10b981; padding: 10px;
border-radius: 8px; cursor: pointer; font-weight: 800; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s ease;
}
    .btn-walk:hover { background: #10b981; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

    .map-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white;
padding: 15px 30px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 3000; font-family: 'Inter', sans-serif; font-size: 0.95rem; display: flex;
align-items: center; gap: 12px; border: 1px solid #334155; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
    .map-toast.active { transform: translateX(-50%) translateY(0); opacity: 1; }
    .map-toast b { color: #10b981;
}

    /* PANNEAU STATS */
    .stats-panel { position: fixed; right: 30px; top: 120px;
width: 360px; max-width: 95vw; background: rgba(15,23,42,0.96); border-radius: 20px; padding: 18px 20px 20px; box-shadow: 0 18px 40px rgba(0,0,0,0.7);
border: 1px solid rgba(148,163,184,0.3); z-index: 2000; transform: translateY(40px); opacity: 0; pointer-events: none; transition: all .25s ease;
}
    .stats-panel.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
    .stats-header { display:flex; align-items:center;
justify-content:space-between; margin-bottom:10px; }
    .stats-header h2 { margin:0; font-size:1.05rem; color:#e5e7eb; }
    .close-btn { background:transparent; border:none;
color:#9ca3af; cursor:pointer; font-size:1.1rem; }
    .stats-grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; }
    .stat-card { background:#020617; border-radius:14px;
padding:10px 12px; border:1px solid rgba(51,65,85,0.9); }
    .stat-label { display:block; font-size:0.75rem; color:#9ca3af; margin-bottom:4px;
}
    .stat-value { font-size:1.1rem; font-weight:800; color:#22c55e; }

/* ============================================================ */
/* STYLES FROM MAP.HTML                                       */
/* ============================================================ */

body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #111; overflow: hidden; }

/* LOADER */
#map-loader {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #020617; z-index: 99999; display: flex; flex-direction: column;
    justify-content: center; align-items: center; transition: opacity 0.8s ease;
}
.bike-loader { font-size: 3rem; color: var(--primary); animation: ride 1s infinite alternate; }
.loading-bar-container { width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden; }
.loading-bar { height: 100%; width: 0; background: var(--primary); transition: width 0.2s; }
@keyframes ride { from { transform: translateY(0) rotate(0deg); } to { transform: translateY(-10px) rotate(5deg); } }
.loading-text { margin-top: 15px; font-family: monospace; color: #64748b; font-size: 0.9rem; }

/* TUTO BOX */
.tuto-box {
    position: fixed; top: 50%; right: 30px; transform: translateY(-50%) translateX(400px);
    background: rgba(15, 23, 42, 0.95); border: 2px solid var(--primary); color: white;
    padding: 25px 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 11000;
    width: 320px; text-align: left; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: none; flex-direction: column; gap: 15px;
}
.tuto-box.active { display: flex; transform: translateY(-50%) translateX(0); }
.tuto-title { color: var(--primary); font-weight: 800; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
.tuto-text { font-size: 0.95rem; line-height: 1.5; color: #cbd5e1; }
.tuto-btn { background: var(--primary); border: none; color: #022c22; padding: 10px; border-radius: 50px;
    cursor: pointer; font-weight: 800; text-transform: uppercase; transition: 0.2s; width: 100%;
}
.tuto-btn:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
.tuto-skip-btn { background: transparent; border: 1px solid #475569; color: #94a3b8; padding: 8px;
    border-radius: 50px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; width: 100%;
}
.tuto-skip-btn:hover { border-color: #cbd5e1; color: white; background: rgba(255,255,255,0.05); }

.highlight-target { animation: pulse-border 1.5s infinite; box-shadow: 0 0 0 4px #f59e0b !important; z-index: 1000 !important; position: relative; border-color: #f59e0b !important; }
.search-container.highlight-target input { border: 2px solid #f59e0b !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5) !important; }
@keyframes pulse-border { 0% { box-shadow: 0 0 0 0px rgba(245, 158, 11, 0.6); } 100% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); } }

/* HEADER */
.dashboard-header {
    position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
    width: 96%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); color: white;
    padding: 10px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    z-index: 1000; display: flex; justify-content: space-between; align-items: center; gap: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.5s ease !important;
}
.brand h1 { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary); }
.nav-links a { text-decoration: none; color: #cbd5e1; font-weight: 600; margin: 0 10px; font-size: 0.9rem; transition:0.3s;}
.nav-links a:hover { color: var(--primary); }

.search-container { flex-grow: 1; position: relative; max-width: 300px; transition: 0.3s; }
.search-container input { width: 100%; padding: 8px 15px 8px 35px; border: none;
    border-radius: 20px; background: rgba(255,255,255,0.1); color: white; outline: none; font-family: 'Inter'; transition: 0.3s;
}
.search-container input:focus { background: rgba(255,255,255,0.15); }
.search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 0.8rem;}

.actions { display: flex; gap: 8px; }
.btn-tool { border: none; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 50%;
    cursor: pointer; color: white; transition: 0.3s; }
.btn-tool:hover { background: var(--primary) !important; transform: scale(1.1); }

.btn-discover {
    background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white;
    padding: 8px 20px; border-radius: 50px; border: none; cursor: pointer;
    font-weight: 800; font-size: 0.9rem; letter-spacing: 0.5px;
    box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
    transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
    animation: pulse 2s infinite;
}
.btn-discover:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(139, 92, 246, 0.8); }
@keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);} 100% {box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);} }

#map { height: 100vh; width: 100%; z-index: 1; background: #0b0b0b; }
.leaflet-control-layers { background: rgba(15, 23, 42, 0.9) !important; color: white !important; border: none !important; border-radius: 12px !important; }
.leaflet-control-minimap { border: 3px solid white !important; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5) !important; }

/* MODALE DECOUVERTE */
.discover-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
    z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center;
    opacity: 0; transition: opacity 0.3s;
}
.discover-modal.active { display: flex; opacity: 1; }
.discover-content {
    background: #1e293b; width: 95%; max-width: 1200px; padding: 40px; border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.1); text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;
}

.cat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 30px; }
.cat-card {
    background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; cursor: pointer;
    transition: 0.3s; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.cat-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-5px); border-color: var(--primary); }
.cat-icon { font-size: 2rem; margin-bottom: 8px; display: block; }

.results-container { 
    display: none; margin-top: 30px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 25px; animation: slideUp 0.5s ease;
}
@keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

.result-card { 
    background: #0f172a; border-radius: 16px; text-align: left; position: relative; border: 1px solid #334155; 
    overflow: hidden; display: flex; flex-direction: column; transition: 0.2s;
}
.result-card:hover { transform: translateY(-5px); border-color: var(--primary); }
.rank-badge { position: absolute; top: 10px; left: 10px; background: #f59e0b; color: black; font-weight: bold; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; box-shadow: 0 5px 10px rgba(0,0,0,0.5); z-index: 2; }
.street-view-btn {
    position: absolute; bottom: 10px; right: 10px; width: 35px; height: 35px;
    background: #F4B400; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 2; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.2s;
}
.street-view-btn:hover { transform: scale(1.1); background: #f59e0b; }
.street-view-btn i { color: black; font-size: 0.9rem; }

/* === NOUVEAUX STYLES BOUTONS FEATURES === */
.btn-tool.active {
    background: var(--primary) !important;
    color: #022c22 !important;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
}
/* Panneau SÉ©lecteur ThÉ¨mes */
#themeSelectorPanel {
    position: fixed; top: 90px; right: 10px;
    background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
    padding: 15px; border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    z-index: 2000; display: none; flex-direction: column; gap: 10px;
    border: 1px solid rgba(255,255,255,0.1);
}
#themeSelectorPanel.active { display: flex; }
.theme-option {
    padding: 10px 15px; border-radius: 10px; cursor: pointer;
    font-weight: 600; text-align: center; transition: 0.3s;
    border: 2px solid transparent;
}
.theme-option:hover { transform: scale(1.05); border-color: white; }
.theme-default { background: linear-gradient(135deg, #10b981, #047857); color: white; }
.theme-ocean { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
.theme-forest { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
.theme-sunset { background: linear-gradient(135deg, #f97316, #ea580c); color: white; }
.theme-midnight { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
/* Panneau Infos É‰cologiques */
#ecoPanelModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 10000;
    display: none; justify-content: center; align-items: center;
}
#ecoPanelModal.active { display: flex; }
.eco-panel-content {
    background: #0f172a; border-radius: 20px; padding: 30px;
    max-width: 600px; max-height: 80vh; overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.9);
    border: 2px solid var(--primary); color: white;
}

/* CORRIGÉ‰ BUG 3 : VisibilitÉ© accrue des compteurs et titres */
.visible-counter {
    color: var(--primary) !important;
    border-color: var(--primary) !important;
}
h1, h2, h3 {
    color: var(--primary) !important;
}
.stats-panel {
    transition: all 0.5s ease !important;
}

/* ============================================================ */
/* STYLES FROM CARNET.HTML                                    */
/* ============================================================ */
.dashboard-header { position: fixed; top: 20px;
left: 50%; transform: translateX(-50%); width: 96%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); padding: 12px 30px; border-radius: 50px;
box-shadow: 0 10px 30px rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1);
}
.container { width: 96%; margin: 0 auto; padding: 0 20px;
}
.top-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;
border-bottom: 1px solid #334155; padding-bottom: 20px; gap: 20px; }
.titles { flex: 1;
}
.heatmap-container { width: 350px; height: 160px; border-radius: 16px; overflow: hidden;
border: 2px solid #334155; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
#miniMap { width: 100%; height: 100%; background: #111;
}
.card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px;
}
.card { background: var(--card-bg); padding: 25px; border-radius: 20px;
box-shadow: 0 10px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; position: relative;
}
.card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(16, 185, 129, 0.1);
border-color: var(--primary); }
.vs-checkbox-input { display: none;
}
.vs-label { position: absolute; top: 20px; right: 20px; width: 30px; height: 30px;
border-radius: 50%; border: 2px solid #475569; background: rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: transparent;
z-index: 10; }
.vs-label:hover { border-color: white;
}
.vs-checkbox-input:checked + .vs-label { background: var(--primary); border-color: var(--primary); color: #022c22;
box-shadow: 0 0 15px var(--primary); }
.card-top { margin-bottom: 15px; padding-right: 40px;
} 
.card h3 { margin: 0 0 5px 0; font-size: 1.3rem;
font-weight: 700; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.75rem;
text-transform: uppercase; display: inline-block; }
.badge.TGV { background: rgba(59, 130, 246, 0.2);
color: #60a5fa; }
.badge.TER { background: rgba(16, 185, 129, 0.2); color: #34d399;
}
.score-row { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.2);
padding: 15px; border-radius: 12px; }
.circle-wrap { width: 70px; height: 70px; border-radius: 50%;
display: flex; justify-content: center; align-items: center; position: relative; background: #334155;
}
.circle-inner { width: 60px; height: 60px; background: var(--card-bg); border-radius: 50%; display: flex;
justify-content: center; align-items: center; font-weight: 900; font-size: 1.2rem; color: white; z-index: 2;
}
.stats-list { flex: 1; font-size: 0.9rem; color: #cbd5e1;
}
.stat-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
}
.btn-main { display: block; width: 100%; text-align: center; background: var(--primary); color: #022c22;
padding: 12px; border-radius: 10px; font-weight: 800; text-decoration: none; margin-bottom: 15px; transition: 0.2s;
}
.btn-main:hover { background: #34d399; transform: scale(1.02);
}
.tools-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}
.tool-btn { background: rgba(255,255,255,0.05); border: none; color: #94a3b8; border-radius: 8px; padding: 10px;
cursor: pointer; transition: 0.2s; font-size: 1.1rem; }
.tool-btn:hover { background: rgba(255,255,255,0.15); color: white;
}
.tool-btn.google:hover { background: rgba(255, 255, 255, 0.2); color: white;
}
.tool-btn.del:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger);
}
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
}
.modal-overlay.active { display: flex; opacity: 1;
}
.modal-box { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px;
width: 90%; max-width: 500px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; transform: scale(0.9); transition: transform 0.3s;
}
.modal-overlay.active .modal-box { transform: scale(1);
}
.close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none;
color: #64748b; font-size: 1.5rem; cursor: pointer; }
.google-grid { display: grid; grid-template-columns: 1fr;
gap: 10px; margin-top: 15px; }
.google-pic { width: 100%; height: 250px; object-fit: cover;
border-radius: 8px; background: #334155; transition: transform 0.2s; border: 2px solid transparent;
}
.google-pic:hover { transform: scale(1.02); border-color: white;
}
.danger-zone { margin-top: 60px; text-align: center; border-top: 1px dashed #334155; padding-top: 20px;
}
.btn-nuke { background: transparent; border: 1px solid #ef4444; color: #ef4444;
padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: monospace; letter-spacing: 2px; transition: 0.3s;
}
.btn-nuke:hover { background: #ef4444; color: white;
box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
#vs-btn { position: fixed;
bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px); background: linear-gradient(135deg, #f59e0b, #d97706); padding: 15px 40px; border-radius: 50px; font-weight: 900; color: white;
border: none; cursor: pointer; box-shadow: 0 0 30px rgba(245, 158, 11, 0.5); z-index: 1500; transition: transform 0.3s; display: flex;
align-items: center; gap: 10px; }
#vs-btn.visible { transform: translateX(-50%) translateY(0);
}
.vs-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem;
}
.vs-table td, .vs-table th { padding: 12px 5px; text-align: center;
border-bottom: 1px solid rgba(255,255,255,0.05); }
.vs-table th { color: #94a3b8; font-weight: normal;
font-size: 0.8rem; }
.val-win { color: #10b981; font-weight: bold;
text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
.val-lose { color: #ef4444;
opacity: 0.7; }
.toast { position: fixed; bottom: 30px; left: 50%;
transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
border: 1px solid #334155; display: flex; align-items: center; gap: 10px; transition: transform 0.3s ease; z-index: 3000;
}
.toast.visible { transform: translateX(-50%) translateY(0);
}
@keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg);
} 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg);
} 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg);
} 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg);
} 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg);
} 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg);
} }
.shaking { animation: shake 0.5s; animation-iteration-count: infinite;
}
.red-alert { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,0,0,0.3); z-index: 9998;
pointer-events: none; display: none; }
.red-alert.active { display: block; animation: flash 0.3s infinite;
}
@keyframes flash { 0% {background:rgba(255,0,0,0.1)} 50% {background:rgba(255,0,0,0.4)} 100% {background:rgba(255,0,0,0.1)} }
#countdown-screen { position: fixed;
top:0; left:0; width:100%; height:100%; background: black; z-index: 9999; display: flex; justify-content: center; align-items: center; color: red; font-family: monospace; font-size: 15vw;
font-weight: 900; display: none; flex-direction: column; }









